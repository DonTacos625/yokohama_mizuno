// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/Deferred","dojo/io-query","../request","../geometry/support/normalizeUtils","../geometry/SpatialReference","../layers/MapImageLayer","../layers/support/MapImage","./Task","./support/DataFile","./support/Date","./support/FeatureSet","./support/GPMessage","./support/JobInfo","./support/LinearUnit","./support/ParameterValue","./support/RasterData"],function(e,t,a,s,r,n,i,u,l,o,c,p,d,h,f,m,b){var S=l.createSubclass({declaredClass:"esri.tasks.Geoprocessor",constructor:function(){this._updateTimers=[],this._handleExecuteResponse=this._handleExecuteResponse.bind(this),this._handleGetResultImageResponse=this._handleGetResultImageResponse.bind(this),this._handleGetResultDataResponse=this._handleGetResultDataResponse.bind(this)},__msigns:[{n:"execute",c:1,a:[{i:0,p:["*"]}],e:2},{n:"submitJob",c:1,a:[{i:0,p:["*"]}],e:3}],properties:{outSpatialReference:{value:null,type:n},processSpatialReference:{value:null,type:n},updateDelay:{value:1e3,type:Number},url:{}},cancelJob:function(t){return s(this.parsedUrl.path+"/jobs/"+t+"/cancel",{query:e.mixin({},this.parsedUrl.query,{f:"json"}),callbackParamName:"callback"}).then(function(e){return e.data})},cancelJobStatusUpdates:function(e){clearTimeout(this._updateTimers[e]),this._updateTimers[e]=null},checkJobStatus:function(t){return s(this.parsedUrl.path+"/jobs/"+t,{query:e.mixin({},this.parsedUrl.query,{f:"json"}),callbackParamName:"callback"}).then(this._handleCheckJobStatusResponse)},getResultImage:function(t,a,r){var n=this._gpEncode(e.mixin({},this.parsedUrl.query,{f:"json"},r.toJSON()));return s(this.parsedUrl.path+"/jobs/"+t+"/results/"+a,{query:n,callbackParamName:"callback"}).then(this._handleGetResultImageResponse)},getResultData:function(t,a){return s(this.parsedUrl.path+"/jobs/"+t+"/results/"+a,{query:e.mixin({},this.parsedUrl.query,{f:"json",returnType:"data"}),callbackParamName:"callback"}).then(this._handleGetResultDataResponse)},getResultMapImageLayer:function(e){var t,s,r=this.parsedUrl;return s=r.path.indexOf("/GPServer/"),t=r.path.substring(0,s)+"/MapServer/jobs/"+e,r.query&&(t+="?"+a.objectToQuery(r.query)),new i(t)},execute:function(t,a){var r=this.outSpatialReference,n=a.assembly,i=this._gpEncode(e.mixin({},this.parsedUrl.query,{f:"json","env:outSR":r?r.wkid||JSON.stringify(r.toJSON()):null,"env:processSR":this.processSpatialReference?this.processSpatialReference.wkid||JSON.stringify(this.processSpatialReference.toJSON()):null},t),null,n&&n[0]);return s(this.parsedUrl.path+"/execute",{query:i,callbackParamName:"callback"}).then(this._handleExecuteResponse)},submitJob:function(a,r){var n=this.outSpatialReference,i=r.assembly,u=this._gpEncode(e.mixin({},this.parsedUrl.query,{f:"json","env:outSR":n?n.wkid||JSON.stringify(n.toJSON()):null,"env:processSR":this.processSpatialReference?this.processSpatialReference.wkid||JSON.stringify(this.processSpatialReference.toJSON()):null},a),null,i&&i[0]),l=new t,o=this._jobUpdateHandler.bind(this);return s(this.parsedUrl.path+"/submitJob",{query:u,callbackParamName:"callback"}).then(function(e){o(e.data,l)}).then(null,function(e){l.reject(e)}),l.promise},_gpEncode:function(t,a,s){var r;for(r in t){var n=t[r];e.isArray(n)?t[r]=JSON.stringify(n.map(function(e){return this._gpEncode({item:e},!0).item},this)):n instanceof Date&&(t[r]=n.getTime())}return this._encode(t,a,s)},_decode:function(t){var a,s=t.dataType,r=m.fromJSON(t);if(-1!==["GPBoolean","GPDouble","GPLong","GPString"].indexOf(s))return r;if("GPLinearUnit"===s)r.value=f.fromJSON(r.value);else if("GPFeatureRecordSetLayer"===s||"GPRecordSet"===s)r.value=p.fromJSON(r.value);else if("GPDataFile"===s)r.value=o.fromJSON(r.value);else if("GPDate"===s)a=r.value,e.isString(a)?r.value=c.fromJSON({date:a}):r.value=Date.fromJSON(a);else if("GPRasterData"===s||"GPRasterDataLayer"===s){var n=t.value.mapImage;n?r.value=u.fromJSON(n):r.value=b.fromJSON(r.value)}else if(-1!==s.indexOf("GPMultiValue:")){var i=s.split(":")[1];a=r.value,r.value=a.map(function(e){return this._decode({paramName:"_name",dataType:i,value:e}).value},this)}else console.log(this.declaredClass+" : GP Data type not handled. : "+r.dataType),r=null;return r},_jobUpdateHandler:function(e,t){var a,s,r=e.jobId,n=h.fromJSON(e);switch(clearTimeout(this._updateTimers[r]),this._updateTimers[r]=null,t.progress(n),n.jobStatus){case"job-submitted":case"job-executing":case"job-waiting":case"job-new":a=this._getJobStatus.bind(this),s=this._jobUpdateHandler.bind(this),this._updateTimers[r]=setTimeout(function(){a(r).then(function(e){s(e,t)})},this.updateDelay);break;default:t.resolve(n)}},_getJobStatus:function(t){return s(this.parsedUrl.path+"/jobs/"+t,{query:e.mixin({},this.parsedUrl.query,{f:"json"}),callbackParamName:"callback"}).then(function(e){return e.data})},_handleGetResultDataResponse:function(e){return this._decode(e.data)},_handleCheckJobStatusResponse:function(e){return h.fromJSON(e.data)},_handleExecuteResponse:function(e){var t=e.data,a=t.results||[],s=t.messages||[];return{results:a.map(this._decode,this),messages:s.map(d.fromJSON)}},_handleGetResultImageResponse:function(e){return this._decode(e.data)}});return r._createWrappers(S),S});