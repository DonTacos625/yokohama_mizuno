// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["../core/declare","../core/accessorSupport/watch","dojo/_base/lang","dojo/_base/kernel","dojo/dom","dojo/Deferred","dojo/when","./View","./ViewAnimation","../geometry/SpatialReference","../geometry/support/webMercatorUtils","../geometry/support/scaleUtils","../Camera","../geometry/Point","../geometry/Extent","../geometry/ScreenPoint","../Viewpoint","../core/Scheduler","../core/sniff","../core/watchUtils","../core/promiseUtils","../core/Error","../core/Logger","../core/HandleRegistry","../webscene/Environment","./3d/environment/SceneViewEnvironment","./3d/environment/SceneViewEnvironmentManager","./3d/constraints/SceneViewConstraints","./3d/lib/glMatrix","./3d/support/cameraUtils","./3d/support/viewpointUtils","./3d/support/projectionUtils","./3d/webgl-engine/Stage","./3d/webgl-engine/lib/Selector","./3d/support/RenderCoordsHelper","./3d/support/MapCoordsHelper","./3d/support/ResourceController","./3d/support/DisplayQualityProfile","./3d/support/QualitySettings","./3d/support/SharedSymbolResources","./3d/terrain/TerrainSurface","./3d/terrain/terrainUtils","./3d/layers/graphics/LabelManager","./3d/layers/GraphicsView3D","./3d/navigation/spherical/NavigationSpherical","./3d/navigation/planar/NavigationPlanar","./3d/navigation/EventController","./3d/support/Frustum","./ui/3d/DefaultUI3D"],function(e,t,i,n,a,r,s,o,l,h,d,c,u,g,p,f,m,v,_,w,y,S,C,R,b,x,V,T,P,M,H,A,E,z,I,G,U,D,O,k,L,W,F,q,N,j,B,Q,Z){function J(e,t){return function(){return this._internallyReady?t.apply(this,arguments):this._get(e)}}function K(e,t){return function(i){return this._internallyReady?t.apply(this,arguments):(this._initialProps[e]=i,this._set(e,i),ae[e]&&this.notifyChange("initialExtentRequired"),void 0)}}var X=C.getLogger("esri.views.SceneView"),Y=P.vec3d,$=Y.create(),ee=new g(0,0,0),te=new u(new g(0,0,0)),ie={point:ee,retval:null},ne={heading:0,tilt:0},ae={camera:["viewpoint"],viewpoint:["extent"],extent:["center","scale"],scale:["zoom"],center:[],zoom:[]},re=Object.keys(ae),se=e(o,{declaredClass:"esri.views.SceneView",properties:{animation:{type:l,value:null},basemapTerrain:{readOnly:!0,value:null},camera:{copy:function(e,t){e.position.x=t.position.x,e.position.y=t.position.y,e.position.z=t.position.z,e.position.spatialReference=t.position.spatialReference,e.heading=t.heading,e.tilt=t.tilt},type:u},canvas:{readOnly:!0,value:null},center:{copy:function(e,t){return e?(e.x=t.x,e.y=t.y,e.z=t.z,e.spatialReference=t.spatialReference,e):t.clone()},type:g},clippingArea:{type:p,dependsOn:["map.clippingArea","map.clippingEnabled","viewingMode"],get:function(){if("global"===this.viewingMode)return null;if(this._userClippingArea)return this._userClippingArea;var e=this.get("map.clippingEnabled"),t=this.get("map.clippingArea");return e&&t?t instanceof p?d.canProject(t.spatialReference,this.spatialReference)?(t=d.project(t,this.spatialReference),this._clippingArea&&t&&this._clippingArea.equals(t)?this._clippingArea:(this._clippingArea=t,t)):(console.error("Setting clippingArea with incompatible SpatialReference."),this._clippingArea):(console.error("Only clippingArea geometries of type Extent are supported"),this._clippingArea):(this._clippingArea=null,null)},set:function(e){this._userClippingArea=e,this._set("clippingArea",e)}},constraints:{type:T,value:null},dataExtent:{dependsOn:["basemapTerrain.extent","clippingArea","map"],readOnly:!0,get:function(){function e(e){if(e){var a=d.project(e,i);a&&(n&&(a=a.intersection(n)),a&&t.push(a))}}var t=[],i=this.spatialReference||h.WGS84,n=this.clippingArea;n&&(n=d.project(n,i));var a=this._get("basemapTerrain");if(a&&a.spatialReference&&e(new p({xmin:a.extent[0],ymin:a.extent[1],zmin:0,xmax:a.extent[2],ymax:a.extent[3],zmax:0,spatialReference:a.spatialReference})),this.map&&this.map.allLayers.forEach(function(t){e(t.fullExtent)}),t.length>0){var r=t.reduce(function(e,t){return e.union(t)});return r.hasZ?(r.zmin=Math.min(0,r.zmin),r.zmax=Math.max(0,r.zmax)):(r.zmin=0,r.zmax=0),r}return new p({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0,spatialReference:i})}},environment:{value:null,set:function(e){return e!==this._defaults.environment&&(this._externallySet.environment=!0),e?void(e instanceof x?this._set("environment",e):e instanceof b?this.environment.lighting=e.lighting:e.declaredClass?this._set("environment",e):this._set("environment",new x(e))):void this._set("environment",new x)}},environmentManager:{},extent:{copy:function(e,t){e.xmin=t.xmin,e.ymin=t.ymin,e.zmin=t.zmin,e.xmax=t.xmax,e.ymax=t.ymax,e.zmax=t.zmax,e.spatialReference=t.spatialReference},type:p},groundExtent:{dependsOn:["basemapTerrain.extent"],readOnly:!0,get:function(){var e=this._get("basemapTerrain");if(e&&e.spatialReference){var t=e.extent;return new p({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e.spatialReference})}var i=this.spatialReference||h.WGS84;return new p({spatialReference:i})}},initialExtentRequired:{dependsOn:["map.initialViewProperties.viewpoint"],get:function(){if(this.get("map.initialViewProperties.viewpoint"))return!1;for(var e=0;e<re.length;e++)if(this._initialProps&&void 0!==this._initialProps[re[e]])return!1;return!0}},interacting:{dependsOn:["navigation.interacting"],get:function(){return this.navigation&&this.navigation.interacting}},map:{value:null},mapCoordsHelper:{},navigation:{readOnly:!0,value:null},navigationController:{},qualityProfile:{set:function(e){D.isValidProfile(e)&&(D.apply(e,this),this._set("qualityProfile",e))}},qualitySettings:{type:O},ready:{dependsOn:["viewingMode"]},renderCoordsHelper:{},scale:{},spatialReference:{dependsOn:["map.initialViewProperties.spatialReference","defaultsFromMap.isDone"]},type:"3d",ui:{type:Z},updating:{},updatingPercentage:0,viewingMode:{dependsOn:["map.initialViewProperties.viewingMode","spatialReference"],get:function(){var e=this.get("map.initialViewProperties.viewingMode"),t=this.spatialReference;return e||(e=!t||t.isWebMercator||t.isWGS84?"global":"local"),e},set:function(e){var t=["local","global"];if(-1!==t.indexOf(e)){var i=this._get("viewingMode")===e;this._override("viewingMode",e),i&&!this.get("map.initialViewProperties.viewingMode")&&this._internallyReady&&this._initGlobe(this.viewingMode)}else void 0===e&&this._clearOverride("viewingMode")}},viewpoint:{copy:function(e,t){e.rotation=t.rotation,e.scale=t.scale,e.targetGeometry=t.targetGeometry,e.camera=t.camera},dependsOn:["camera"],type:m},zoom:{dependsOn:["scale"]}},getDefaults:function(e){var t=this.inherited(arguments);return t.constraints||e.constraints||(this._defaults.constraints=new T,t.constraints=this._defaults.constraints),t.environment||e.environment||(this._defaults.environment=new x,t.environment=this._defaults.environment),t.popup.autoPanEnabled=!1,t.qualitySettings=new O,t.qualityProfile=D.getDefaultProfile(),t},constructor:function(){w.when(this,"ready",this._viewReadyHandler.bind(this)),this._internallyReady=!1,this._initialProps={},this._userClippingArea=null,this._gotoTask=null,this._initialDefaultSpatialReference=null,this._initCoordinateSystem(),this._frustum=new Q,this._animationStateWatcher=null,this._constraints=null,this._clippingArea=null,this.navigationController=null,this.navigationControls=B.PAN,this._defaults={},this._externallySet={},this.resourceController=new U(this),this.labelManager=new F(this),this._evaluateUpdating=this._evaluateUpdating.bind(this),this._layerViewsUpdatingHandles={},this._navigationHandles=new R,this._navigationPauseNotifications=!1,this._navigationHandles.add([w.on(this,"navigation","currentViewChanged",this._navigationCurrentViewChanged.bind(this),null,null,!0),w.on(this,"navigation","currentViewReachedTarget",this._navigationCurrentViewReachedTarget.bind(this),null,null,!0),w.on(this,"navigation","targetViewChanged",function(e){this._navigationPauseNotifications||this._navigationTargetViewChanged(e)}.bind(this),null,null,!0),w.on(this,"navigation","animationStarted",function(e){this._navigationPauseNotifications||this._navigationAnimationStarted(e)}.bind(this),null,null,!0)]),this.watch("map",function(e){e&&e.load&&e.load()})},initialize:function(){this.environmentManager=new V({view:this}),this._updateUpdatingMonitorsHandle=this.allLayerViews.on("change",this._updateUpdatingMonitors.bind(this)),this._updateUpdatingMonitors({added:this.allLayerViews.toArray(),removed:[],moved:[]}),w.whenNot(this,"ready",this._viewUnreadyHandler.bind(this))},destroy:function(){t.dispatchTarget(this),this.environmentManager.destroy(),this._disposeGraphicsView(),this._updateUpdatingMonitorsHandle.remove(),this._updateUpdatingMonitorsHandle=null,this._navigationHandles.remove(),this._navigationHandles=null},destroyLayerViews:function(){for(var e in this._layerViewsUpdatingHandles)this._layerViewsUpdatingHandles[e].remove();this._layerViewsUpdatingHandles={},this._disposeSurface(),this.inherited(arguments),this._stage&&(this._stage.dispose(),this._stage=null,this._forwardAASettingsHandle.remove(),this._forwardAASettingsHandle=null),this._setCanvas(null),this.labelManager.destroy(),this.labelManager=null,this.resourceController.destroy(),this.resourceController=null},toMap:function(e,t,i){if(!this._internallyReady)return X.error("#toMap()","Scene view cannot be used before it is ready"),null;var n=this._normalizePointArgs(e,t,void 0,i),a=[n.point.x,this.height-n.point.y],r=this._stage.pick(a).getMinResult();return this._computeMapPointFromIntersectionResult(r,n.retval)},toScreen:function(e,t,i,n){if(!this._internallyReady)return X.error("#toScreen()","Scene view cannot be used before it is ready"),null;var a=this._normalizePointArgs(e,t,i,n);return A.pointToVector(a.point,$,this.renderSpatialReference),this.engineToScreen($,a.retval)},pixelSizeAt:function(e,t,i){if(!this._internallyReady)return X.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null;if("esri.geometry.ScreenPoint"===e.declaredClass){var n=this._stage.pick([e.x,this.height-e.y]).getMinResult();if(!n.getIntersectionPoint($))return 0}else{var a=this._normalizePointArgs(e,t,i,void 0);A.pointToVector(a.point,$,this.renderSpatialReference)}var r=this.navigation.currentCamera;return r.computePixelSizeAt($)},hitTest:function(e,t){if(!this._internallyReady)return X.error("#hitTest()","Scene view cannot be used before it is ready"),null;var i=this._normalizePointArgs(e,t,void 0,void 0),n=[i.point.x,this.height-i.point.y],a=this._stage.pick(n,null,!0).getMinResult(),r=this._computeMapPointFromIntersectionResult(a);return s(this._getGraphicFromStageObject(a.object,a.triangleNr)).otherwise(function(){return null}).then(function(e){var t=[];return(e||r)&&t.push({mapPoint:r,graphic:e}),{screenPoint:n,results:t}})},goTo:function(e,t){if(!this._internallyReady)return void X.error("#goTo()","Scene view cannot be used before it is ready");t=i.mixin({animate:!0},t);var n=H.create(this,e,t);return this._gotoTask={},t.animate?this._gotoAnimated(n,t):this._gotoImmediate(n,t)},animateTo:function(e,t){return n.deprecated(this.declaredClass+".animateTo is deprecated. Use .goTo instead.","","4.0"),this.goTo(e,t)},takeScreenshot:function(e){if(!this._internallyReady)return void X.error("#takeScreenshot()","Scene view cannot be used before it is ready");e=i.mixin({format:"png",quality:100},e||{});var t,n,a=new r;e.includePadding||(t=this.width-this.padding.left-this.padding.right,n=this.height-this.padding.top-this.padding.bottom);var s=t/n;return void 0!==e.width&&void 0===e.height?e.height=e.width/s:void 0!==e.height&&void 0===e.width&&(e.width=s*e.height),void 0!==e.height&&(e.height=Math.floor(e.height)),void 0!==e.width&&(e.width=Math.floor(e.width)),e.area||e.includePadding||(e.area={x:this.padding.left,y:this.padding.top,width:t,height:n}),this._stage.requestScreenCapture(e,function(e){v.schedule(function(){a.resolve(e)})}),a.promise},engineToScreen:function(e,t){var i=Y.create();this._stage.getCamera().projectPoint(e,i);var n=i[0],a=this.height-i[1],r=i[2];return t?(t.x=n,t.y=a,t.z=r,t):new f({x:n,y:a,z:r})},getDefaultSpatialReference:function(){return this.get("map.initialViewProperties.spatialReference")||this.get("defaultsFromMap.spatialReference")||this.get("defaultsFromMap.isDone")&&this._initialDefaultSpatialReference||null},validate:function(){var e;return _("esri-webgl")?_("safari")&&_("safari")<7.1&&(e=new S("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 7.1)",{type:"safari",requiredVersion:7.1,detectedVersion:_("safari")})):e=new S("sceneview:webgl-required","WebGL is required but not supported"),e?y.reject(e):y.resolve()},isSpatialReferenceSupported:function(e,t){var i=null==c.getUnitValue(e),n=e.isWebMercator,a=e.isWGS84,r="local"===this.viewingMode,s=!(!this._isOverridden("viewingMode")&&!this.get("map.initialViewProperties.viewingMode"));if(s){if(r&&i)return!1;if(!r&&!n&&!a)return!1}else if(i&&!a)return!1;return!t||W.isTiledLayer(t)||!a&&!n||r?!0:(null==this._initialDefaultSpatialReference&&(this._initialDefaultSpatialReference=e),s||this.ready||(this.viewingMode="global"),!1)},has:function(e){return this._stage.has(e)},flushDisplayModifications:function(){this._stage.processDirty()},getFrustum:function(){return this._frustum.dirty&&this._frustum.update(this.navigation.currentCamera),this._frustum},getDrawingOrder:function(e){return this.allLayerViews.findIndex(function(t){return t.layer&&t.layer.uid===e})},getViewForGraphic:function(e){return e.layer?this.allLayerViews.find(function(t){return t.layer===e.layer}):this._graphicsView},whenViewForGraphic:function(e){return e.layer?this.whenLayerView(e.layer):y.resolve(this._graphicsView)},renderSpatialReference:null,_graphicsView:null,_surfaceReadyWatchHandle:null,_forwardAASettingsHandle:null,_gotoImmediate:function(e,t){var i=this._gotoTask;return e.then(function(e){i===this._gotoTask&&(this.viewpoint=e)}.bind(this))},_gotoAnimated:function(e,t){!this.animation||"running"!==this.animation.state&&"waiting-for-target"!==this.animation.state?this.animation=new l({target:e}):this.animation.target=e;var i=this.animation;return i.state="waiting-for-target",e.then(function(t){if(i.target===e&&this.animation===i){i.target=t,i.state="running";var n=H.toCamera(this,t);if(!n)throw X.error("#goTo()","Invalid target specified for animateTo"),new S("goto:invalid-camera","Invalid camera in conversion from viewpoint");if(this._cameraAlmostEquals(this.camera,n))return void i.finish();var a=M.externalToInternal(this,n);if(a.almostEquals(this.navigation.targetCamera,5e-4/this.renderCoordsHelper.unitInMeters))return void i.finish();this._navigationPauseNotifications=!0,this._setInternalCamera(a,{animate:!0}),i.state===l.State.STOPPED&&i.stop(),this._navigationPauseNotifications=!1}}.bind(this)).otherwise(function(){i.target===e&&this.animation===i&&(this.animation=null,i.finish())}),i},_trackCanvasSize:function(){this.on("resize",function(e){if(this.canvas){this.canvas.width=e.width,this.canvas.height=e.height;var t=this._stage.getCamera();t.width=e.width,t.height=e.height,this._stage.setCamera(t),this.navigation&&(this.navigation.windowSize=[e.width,e.height])}}.bind(this)),this.canvas.width=this.width,this.canvas.height=this.height},_computeMapPointFromIntersectionResult:function(e,t){if(e.getIntersectionPoint($)){var i=this.spatialReference||h.WGS84;A.vectorToVector($,this.renderSpatialReference,$,i)||(i=h.WGS84,A.vectorToVector($,this.renderSpatialReference,$,i)),t?(t.x=$[0],t.y=$[1],t.z=$[2],t.spatialReference=i):t=new g($,i);var n=this._get("basemapTerrain");if("terrain"===e.intersector&&n){var a=n.getElevation(t);null!==a&&(t.z=a)}return t}return null},_onGeometryPicked:function(e,t,i){var n={screenPoint:{x:t[0],y:this.height-t[1]}},a=this._computeMapPointFromIntersectionResult(i);a&&(n.mapPoint=a),this.emit("click",n)},_getGraphicFromStageObject:function(e,t){if(!e)return null;var i=e.getMetadata();if(null!=i&&null!=i.layerId){if(i.layerId===this._graphicsView.mockLayerId)return this._graphicsView.getGraphicsFromStageObject(e,t);var n=this.map.findLayerById(i.layerId);if(n)return this.whenLayerView(n).then(function(i){return i&&null!=i.getGraphicsFromStageObject&&!i.suspended?i.getGraphicsFromStageObject(e,t):void 0})}return null},_viewingModeToManifold:function(e){return{local:"planar",global:"spherical"}[e]},_initBasemapTerrain:function(e){this._disposeBasemapTerrain(),this._set("basemapTerrain",new L(this,this._viewingModeToManifold(e))),this.navigation.elevationProvider=this._get("basemapTerrain")},_initGlobe:function(e){this._initCoordinateSystem(),this._initNavigation(e),this._stage.setViewParams({backgroundColor:[0,0,0,0],maxFarNearRatio:0,frustumCullingEnabled:!1}),this._initBasemapTerrain(e),this._navigationCurrentViewChanged({camera:this.navigation.currentCamera})},_initCoordinateSystem:function(){if(this.spatialReference){var e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||(this.mapCoordsHelper=new G(this.map,e));var t=this.renderCoordsHelper?this.renderCoordsHelper.unitInMeters:1,i="global"===this.viewingMode,n=i?A.SphericalRenderSpatialReference:e;if(n!==this.renderSpatialReference){this.renderSpatialReference=n;var a=i?I.Spherical:I.Planar;if(this.renderCoordsHelper=new a(n),this._stage&&this._stage.setIntersectTolerance(z.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._constraints){var r=t/this.renderCoordsHelper.unitInMeters;this._constraints.scale(r)}}}else this.mapCoordsHelper=null,this.renderCoordsHelper=null,this.renderSpatialReference=null},_paddingEqualsArray:function(e){var t=this.padding;return t?t.top===e[0]&&t.right===e[1]&&t.bottom===e[2]&&t.left===e[3]:!0},_navigationCurrentViewChanged:function(e){this._frustum.dirty=!0;var t=e.camera,i=t.padding,n=this._get("basemapTerrain"),a=n.spatialReference;if(a){var r=this.renderCoordsHelper.fromRenderCoords(t.eye,a),s=n.getElevation(r)||0,o=r.z,l=o>=s;t.aboveGround=l}if(!this._paddingEqualsArray(i)){var h=this._padding,d={top:i[0],right:i[1],bottom:i[2],left:i[3]};this._internallyReady?(this._padding=d,this.notifyChange("padding",h,d)):this.padding=d}this._stage.setCamera(t),this.notifyChange("center"),this.notifyChange("extent"),this.notifyChange("scale");var c=this.camera,u=M.internalToExternal(this,t,te);c&&this._cameraAlmostEquals(c,u)||this.notifyChange("camera")},_cameraAlmostEquals:function(e,t){return Math.abs(e.tilt-t.tilt)<1e-5&&Math.abs(e.heading-t.heading)<1e-5&&Math.abs(e.fov-t.fov)<1e-5&&e.position.equals(t.position)},_navigationAnimationStarted:function(e){var t=H.fromInternalCamera(this,this.navigation.targetCamera);this.animation?this.animation.target=t:this.animation=new l({target:t})},_navigationTargetViewChanged:function(e){if(this.animation&&"waiting-for-target"!==this.animation.state){var t=e.camera,i=this.spatialReference||h.WGS84,n=M.internalToExternal(this,t),a=new m({camera:n,targetGeometry:A.vectorToPoint(t.center,i,this.renderSpatialReference),scale:M.computeScale(this,t),rotation:H.headingToRotation(n.heading)});this.animation.target=a}},_navigationCurrentViewReachedTarget:function(e){if((e.interruptedAnimation||e.finishedAnimation)&&(this._gotoTask=null),this.animation&&(e.interruptedAnimation||e.finishedAnimation)){this._animationStateWatcher&&(this._animationStateWatcher.remove(),this._animationStateWatcher=null);var t=this.animation;this.animation=null,e.finishedAnimation?t.finish():t.stop(),this.notifyChange("animation")}},_setInternalCamera:function(e,t){return e&&(this.navigation.setCamera(e,t),this._externallySet.camera=!0),!!e},_setCamera:function(e,t){return this._setInternalCamera(M.externalToInternal(this,e),t)},_evaluateUpdating:function(){var e=0,t=0,i=!1;this.allLayerViews.forEach(function(n){if(n.updating){i=!0;var a=n.updatingPercentage;null!=a&&(++t,e+=a)}}),this._graphicsView&&this._graphicsView.updating&&(i=!0),i!==this.updating&&(this.updating=i),0!==t?e/=t:e=i?100:0,this.updatingPercentage!==e&&(this.updatingPercentage=e)},_updateUpdatingMonitors:function(e){for(var t=0;t<e.removed.length;t++){var i=e.removed[t],n=this._layerViewsUpdatingHandles[i.id];n&&(delete this._layerViewsUpdatingHandles[i.id],n.remove())}for(t=0;t<e.added.length;t++)i=e.added[t],i.destroyed||(n=i.watch(["updating","updatingPercentage"],this._evaluateUpdating),this._layerViewsUpdatingHandles[i.id]=n);this._evaluateUpdating()},_spatialReferenceSetter:function(e){this.inherited(arguments),this._initCoordinateSystem()},_setInitialView:function(e){if(e&&!this._externallySet.camera){var t=null;if(e instanceof m&&!e.camera&&e.targetGeometry instanceof p&&(t=H.rotationToHeading(e.rotation),e=e.targetGeometry),e instanceof m)this.viewpoint=e;else if(e instanceof u)this.camera=e;else{var i=this._getDesiredHeadingTilt();null!=t&&(i.heading=t),H.create(this,{target:e,heading:i.heading,tilt:i.tilt}).then(function(e){this.navigation._dataExtentChanged(),this.viewpoint=e}.bind(this))}}},_pickRay:function(){return this._stage?this._stage.pickRay.apply(this._stage,arguments):null},_pickRayWithBeginPoint:function(){return this._stage?this._stage.pickRayWithBeginPoint.apply(this._stage,arguments):null},_removeHandles:function(e){for(var t=0;t<e.length;t++){var i=e[t];this[i]&&(this[i].remove(),this[i]=null)}},_setCanvas:function(e){e!==this._get("canvas")&&this._set("canvas",e)},_disposeSurface:function(){this._removeHandles(["_stageFrameTask","_updateDrawingOrderHandle","onViewExtentUpdateHandle","_mapLayersChangeHandle"]),this._disposeBasemapTerrain(),this._setNavigation(null),this.environmentManager&&this.environmentManager.disposeRendering()},_disposeBasemapTerrain:function(){var e=this._get("basemapTerrain");e&&(e.destroy(),this._set("basemapTerrain",null))},_disposeNavigation:function(){var e=this._get("navigation");e&&(e.destroy(),e.elevationProvider=null,this._set("navigation",null)),this.navigationController&&(this.navigationControls=this.navigationController.getControls(),this.navigationController.destroy(),this.navigationController=null)},_setNavigation:function(e){this._get("navigation")!==e&&(this._disposeNavigation(),e&&(e.windowSize=[this.width,this.height],e.userConstraints=this.constraints),this._set("navigation",e))},_initNavigation:function(e){e=e||this.viewingMode;var t={view:this};"global"===e?this._setNavigation(new N(t)):this._setNavigation(new j(t)),this.navigationController=new B(this,this.navigationControls)},_initSurface:function(){var e={};e.deactivatedWebGLExtensions=this.deactivatedWebGLExtensions,this.renderCanvas&&(e.canvas=this.renderCanvas),this._stage=new E(a.byId(this.surface),e),this._stage.selectionState=!1,this._stage.onGeometryPicked=this._onGeometryPicked.bind(this),this._forwardAASettingsHandle=w.init(this.qualitySettings,"antialiasingEnabled",function(){this._stage.setRenderParams({antialiasingEnabled:this.qualitySettings.antialiasingEnabled})}.bind(this)),this.sharedSymbolResources=new k(this._stage,this.resourceController),this.renderCoordsHelper&&this._stage.setIntersectTolerance(z.DEFAULT_TOLERANCE/this.renderCoordsHelper.unitInMeters),this._setCanvas(this._stage.getCanvas()),this._stageFrameTask=v.addFrameTask(this._stage.getFrameTask()),this._trackCanvasSize(),this._initGlobe(this.viewingMode)},_initGraphicsView:function(){this._surfaceReadyWatchHandle=w.whenTrueOnce(this,"basemapTerrain.ready",function(){this._graphicsView=new q({view:this,graphics:this.graphics}),this._surfaceReadyWatchHandle=null,this._layerViewsUpdatingHandles[this._graphicsView.mockLayerId]=this._graphicsView.watch("updating",this._evaluateUpdating)}.bind(this))},_disposeGraphicsView:function(){if(this._surfaceReadyWatchHandle&&(this._surfaceReadyWatchHandle.remove(),this._surfaceReadyWatchHandle=null),this._graphicsView){var e=this._graphicsView.mockLayerId;this._layerViewsUpdatingHandles[e].remove(),delete this._layerViewsUpdatingHandles[e],this._graphicsView.destroy(),this._graphicsView=null}},_normalizePointArgs:function(e,t,i,n,a){a=a||ie;var r=a.point;return r.spatialReference=void 0,"object"==typeof e?(r.x=e.x,r.y=e.y,r.z=e.z,e.spatialReference&&(r.spatialReference=e.spatialReference),a.retval=t):(r.x=e,r.y=t,"number"!=typeof i&&void 0!==i?(r.z=void 0,a.retval=i):(r.z=i,a.retval=n)),r.spatialReference||(r.spatialReference=this.spatialReference||h.WGS84),a},_separateInitialProperties:function(){var e,t={},i={},n={},a=function(e){var t=ae[e];if(t)for(var i=0;i<t.length;i++)n[t[i]]=!0,a(t[i])};for(e in this._initialProps){var r=ae[e],s=this._initialProps[e];r?(a(e),t[e]=s):i[e]=s}for(e in n)delete t[e];return{view:t,other:i}},_viewReadyHandler:function(e,t){if(!t){"global"===this.viewingMode&&(this._clippingArea=null),this._internallyReady=!0,this._initSurface(),this._initGraphicsView();var i,n=this._separateInitialProperties();for(i in n.other)this.set(i,n.other[i]);for(i in n.view)this.set(i,n.view[i]);var a=this.get("map.initialViewProperties.viewpoint"),r=this.get("initialExtent");if(a?this._setInitialView(a):r&&r.spatialReference.equals(this.spatialReference)?this._setInitialView(r):"local"===this.viewingMode&&w.whenOnce(this.basemapTerrain,"ready",function(){this._setInitialView(this.groundExtent)}.bind(this)),!this._externallySet.environment){var s=this.get("map.initialViewProperties.environment");s&&(this.environment=s)}this._initialProps={},this.notifyChange("initialExtentRequired"),this._updateDrawingOrderHandle=this.allLayerViews.on("change",this._updateDrawingOrder.bind(this)),this._updateDrawingOrder({added:this.allLayerViews.toArray(),removed:[],moved:[]}),this.environmentManager.updateReadyChange(!0)}},_viewUnreadyHandler:function(e,t){t&&(this._initialDefaultSpatialReference=null,this.environmentManager.updateReadyChange(!1),this._disposeGraphicsView(),this._internallyReady=!1,this._disposeSurface(),this.sharedSymbolResources&&(this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null),this._stage&&(this._stage.dispose(),this._stage=null,this._forwardAASettingsHandle.remove(),this._forwardAASettingsHandle=null),this._setCanvas(null))},_getDesiredHeadingTilt:function(){if(this._externallySet.camera){var e=this.camera;ne.heading=e.heading,ne.tilt=e.tilt}else ne.heading=0,ne.tilt=.5;return ne},_cameraSetter:K("camera",function(e){this._setCamera(e,{animate:!1})||X.error("#camera=","Invalid camera",e)}),_cameraGetter:J("camera",function(e){return M.internalToExternal(this,this.navigation.currentCamera,e)}),_externalExtent:function(){return this._cachedExtentDirty&&(M.toExtent(this,null,null,this._cachedExtent,te),this._cachedExtentDirty=!1),this._cachedExtent},_extentGetter:J("extent",function(e){return M.toExtent(this,null,null,e,te)}),_extentSetter:K("extent",function(e){var t=M.fromExtent(this,e,this._getDesiredHeadingTilt(),te);t?this.camera=t:this._isIncompatibleSpatialReference(e.spatialReference)?X.error("#extent=","Extent has an incompatible spatial reference (extent: "+e.spatialReference.wkid+", view: "+this.spatialReference.wkid+")",e):X.error("#extent=","Invalid extent",e)}),_isIncompatibleSpatialReference:function(e){return e&&!e.equals(this.spatialReference)&&!d.canProject(e,this.spatialReference)},_scaleGetter:J("scale",function(){return null!=this.navigation?M.computeScale(this,this.navigation.currentCamera):0}),_scaleSetter:K("scale",function(e){var t=this._getDesiredHeadingTilt(),i=this.navigation.currentCamera.center,n=Y.create();A.vectorToVector(i,this.renderSpatialReference,n,h.WGS84);var a=M.scaleToDistance(this,e,n[1]),r=M.eyeHeadingTiltForCenterPointAtDistance(this,t.heading,t.tilt,i,a);this._externallySet.camera=!0,this.navigation.setCameraFromEyeCenterAndUp(r.eye,r.center,r.up,{animate:!1})}),_zoomGetter:J("zoom",function(){return M.scaleToZoom(this,this.scale)}),_zoomSetter:K("zoom",function(e){this.scale=M.zoomToScale(this,e)}),_centerGetter:J("center",function(e){var t=this.navigation.currentCamera,i=this.spatialReference||h.WGS84;return A.vectorToPoint(t.center,this.renderSpatialReference,e||i,i)}),_centerSetter:K("center",function(e){if(this._isIncompatibleSpatialReference(e&&e.spatialReference))return void X.error("#center=","Center has an incompatible spatial reference (center: "+e.spatialReference.wkid+", view: "+this.spatialReference.wkid+")",e);var t=this._getDesiredHeadingTilt(),i=M.eyeHeadingTiltForCenterPointAtDistance(this,t.heading,t.tilt,e,this.navigation.currentCamera.distance);i||X.error("#center=","Invalid center",e),this._externallySet.camera=!0,this.navigation.setCameraFromEyeCenterAndUp(i.eye,i.center,i.up,{animate:!1})}),_viewpointGetter:J("viewpoint",function(){return H.fromCamera(this,this.camera)}),_viewpointSetter:K("viewpoint",function(e){var t=H.toCamera(this,e);t?this._setCamera(t,{animate:!1}):X.error("#viewpoint=","Invalid viewpoint",e)}),_screenCenterGetter:function(){var e=this.padding;return new f((this.size[0]-(e.left+e.right))/2+e.left,(this.size[1]-(e.top+e.bottom))/2+e.top)},_updateDrawingOrder:function(){var e=this.allLayerViews.length-1;this.allLayerViews.forEach(function(t,i){null!=t.drawingOrder&&(t.drawingOrder=e-i)},this)},_paddingSetter:K("padding",function(e){this._set("padding",{top:e&&e.top||0,right:e&&e.right||0,bottom:e&&e.bottom||0,left:e&&e.left||0}),this.navigation&&(this.navigation.padding=this._get("padding"))}),_constraintsSetter:K("constraints",function(e){this._set("constraints",e),e===this._defaults.constraints&&(this._defaults.constraints=null,e.scale(1/this.renderCoordsHelper.unitInMeters)),this.navigation.userConstraints=e}),_animationSetter:function(e){if(e!==this._get("animation")){if(!this._internallyReady)return void X.error("#animation=","Scene view cannot be used before it is ready");this._animationStateWatcher&&(this._animationStateWatcher.remove(),this._animationStateWatcher=null),this._set("animation",e),e&&(this._animationStateWatcher=e.watch("state",function(e){(e===l.State.FINISHED||e===l.State.STOPPED)&&(this.animation=null,e===l.State.FINISHED?this.navigation.setCurrentToTarget():this.navigation.setCamera(this.navigation.currentCamera,{animate:!1}))}.bind(this)))}},_mapSetter:function(e){e!==this._get("map")&&(this.navigation&&this.navigation._dataExtentChanged(),this._mapLayersChangeHandle&&this._mapLayersChangeHandle.remove(),e&&(this._mapLayersChangeHandle=e.allLayers.on("change",this.notifyChange.bind(this,"dataExtent"))),delete this._externallySet.camera,this.inherited(arguments))}});return se});