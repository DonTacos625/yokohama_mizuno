// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/text!./HUDMaterial.xml","./internal/MaterialUtil","../lib/ShaderVariations","../lib/Util","../lib/gl-matrix","../lib/RenderSlot","../../../webgl/Program","../lib/DefaultVertexAttributeLocations","../../../webgl/Util"],function(e,t,i,r,n,o,a,s,l,f){var d=o.vec2d,c=o.vec3d,u=o.mat4d,h=n.assert,g=n.VertexAttrConstants,x={"bottom-left":[0,0],bottom:[.5,0],"bottom-right":[1,0],left:[0,.5],center:[.5,.5],right:[1,.5],"top-left":[0,1],top:[.5,1],"top-right":[1,1]},S=[253/255,231/255,229/255],v=function(e,t){i.basicMaterialConstructor(this,t),e=e||null,e.texCoordScale=e.texCoordScale||[1,1],e.occlusionTest=void 0!==e.occlusionTest?e.occlusionTest:!0,e.color=e.color||[1,1,1,1],e.screenMinMaxSize=e.screenMinMaxSize||[0,1e5],e.outlineColor=e.outlineColor||[1,1,1,1],e.outlineSize=e.outlineSize||0,e.textureIsSignedDistanceField=e.textureIsSignedDistanceField?1:0,e.distanceFieldBoundingBox=e.distanceFieldBoundingBox||[.25,.25,.75,.75],e.screenOffset?e.screenOffset.forEach(function(t,i){e.screenOffset[i]=2*t}):e.screenOffset=[0,0],"string"==typeof e.anchorPos?(h(x[e.anchorPos],"HUDMaterial: invalid anchorPos specified"),e.anchorPos=x[e.anchorPos]):e.anchorPos||(e.anchorPos=x.center),null==e.shaderPolygonOffset&&(e.shaderPolygonOffset=1e-5);var r=[{name:"position",count:3,type:5126,offset:0,stride:60,normalized:!1},{name:"normal",count:3,type:5126,offset:12,stride:60,normalized:!1},{name:"uv0",count:2,type:5126,offset:24,stride:60,normalized:!1},{name:"color",count:4,type:5121,offset:32,stride:60,normalized:!1},{name:"size",count:2,type:5126,offset:36,stride:60,normalized:!1},{name:"auxpos1",count:4,type:5126,offset:44,stride:60,normalized:!1}],n=f.getStride(r),o=n/4;this.dispose=function(){},this.getParameterValues=function(){var t={color:e.color,texCoordScale:e.texCoordScale,polygonOffset:e.polygonOffset,anchorPos:e.anchorPos,screenOffset:e.screenOffset,screenMinMaxSize:e.screenMinMaxSize,shaderPolygonOffset:e.shaderPolygonOffset,textureIsSignedDistanceField:e.textureIsSignedDistanceField,outlineColor:e.outlineColor,outlineSize:e.outlineSize,distanceFieldBoundingBox:e.distanceFieldBoundingBox};return e.textureId&&(t.textureId=e.textureId),e.direction&&(t.direction=e.direction),t},this.setParameterValues=function(t){for(var i in t)"textureId"===i&&h(e.textureId,"Can only change texture of material that already has a texture"),"direction"===i&&h(e.direction,"Can only change direction of HUDMaterial which was initialized with a direction"),e[i]=t[i];this.notifyDirty("matChanged")},this.getParams=function(){return e},this.getOutputAmount=function(e){return e*o*6},this.getVertexBufferLayout=function(){return r},this.fillInterleaved=function(t,a,s,l,d,c){for(var u=4*c,h=i.fill,x=t.faces.indices[g.POSITION],S=t.vertexAttr[g.POSITION].data,v=c+f.findAttribute(r,g.POSITION).offset/4,m=0;m<x.length;++m){var O=3*x[m];h(S,O,d,v,a,3),v+=o,h(S,O,d,v,a,3),v+=o,h(S,O,d,v,a,3),v+=o,h(S,O,d,v,a,3),v+=o,h(S,O,d,v,a,3),v+=o,h(S,O,d,v,a,3),v+=o}var P=t.faces.indices[g.NORMAL],p=t.vertexAttr[g.NORMAL].data;for(v=c+f.findAttribute(r,g.NORMAL).offset/4,m=0;m<P.length;++m)O=3*P[m],h(p,O,d,v,s,3),v+=o,h(p,O,d,v,s,3),v+=o,h(p,O,d,v,s,3),v+=o,h(p,O,d,v,s,3),v+=o,h(p,O,d,v,s,3),v+=o,h(p,O,d,v,s,3),v+=o;v=c+f.findAttribute(r,g.UV0).offset/4;var U=t.vertexAttr[g.UV0].data;if(null==U||U.length<=3)var D=0,b=0,C=e.texCoordScale[0],y=e.texCoordScale[1];else D=t.vertexAttr[g.UV0].data[0],b=t.vertexAttr[g.UV0].data[1],C=t.vertexAttr[g.UV0].data[2],y=t.vertexAttr[g.UV0].data[3];for(C=Math.min(1.99999,C+1),y=Math.min(1.99999,y+1),m=0;m<x.length;++m)d[v]=D,d[v+1]=b,v+=o,d[v]=C,d[v+1]=b,v+=o,d[v]=C,d[v+1]=y,v+=o,d[v]=C,d[v+1]=y,v+=o,d[v]=D,d[v+1]=y,v+=o,d[v]=D,d[v+1]=b,v+=o;var I=t.faces.indices[g.COLOR],T=t.vertexAttr[g.COLOR].data;v=u+f.findAttribute(r,g.COLOR).offset;var M=new Uint8Array(d.buffer);for(m=0;m<I.length;++m)O=4*I[m],h(T,O,M,v,null,4),v+=n,h(T,O,M,v,null,4),v+=n,h(T,O,M,v,null,4),v+=n,h(T,O,M,v,null,4),v+=n,h(T,O,M,v,null,4),v+=n,h(T,O,M,v,null,4),v+=n;var A=t.faces.indices[g.SIZE],z=t.vertexAttr[g.SIZE].data;for(v=c+f.findAttribute(r,g.SIZE).offset/4,m=0;m<A.length;++m){var w=z[2*A[m]],E=z[2*A[m]+1];d[v]=w,d[v+1]=E,v+=o,d[v]=w,d[v+1]=E,v+=o,d[v]=w,d[v+1]=E,v+=o,d[v]=w,d[v+1]=E,v+=o,d[v]=w,d[v+1]=E,v+=o,d[v]=w,d[v+1]=E,v+=o}if(null!=t.faces.indices[g.AUXPOS1]&&null!=t.vertexAttr[g.AUXPOS1]){var F=t.faces.indices[g.AUXPOS1],L=t.vertexAttr[g.AUXPOS1].data;for(v=c+f.findAttribute(r,"auxpos1").offset/4,m=0;m<F.length;++m)O=4*F[m],h(L,O,d,v,null,4),v+=o,h(L,O,d,v,null,4),v+=o,h(L,O,d,v,null,4),v+=o,h(L,O,d,v,null,4),v+=o,h(L,O,d,v,null,4),v+=o,h(L,O,d,v,null,4),v+=o}};var a=c.create(),s=c.create(),l=1,d=[0,0];this.intersect=function(t,i,r,n,o,f,x,S,v,m,O,P){if(P){var p=t.getData().getVertexAttr()[g.POSITION],U=t.getData().getVertexAttr()[g.SIZE];h(p.size>=3);for(var D=0;D<p.data.length/p.size;D++){var b=D*p.size;c.set3(p.data[b],p.data[b+1],p.data[b+2],a),u.multiplyVec3(r,a,a);var C=D*U.size;if(d[0]=U.data[C],d[1]=U.data[C+1],v.projectPoint(a,s),s[0]>-1){var y=s[0],I=s[1],T=e.anchorPos,M=y-l-(T[0]>0?d[0]*T[0]:0),A=M+d[0],z=I-l-(T[1]>0?d[1]*T[1]:0),w=z+d[1];if(e.textureIsSignedDistanceField){var E=e.distanceFieldBoundingBox,F=e.outlineSize/2;M+=d[0]*E[0]-F,A-=d[0]*(1-E[2])-F,z+=d[1]*E[1]-F,w-=d[1]*(1-E[3])-F}if(n[0]>M&&n[0]<A&&n[1]>z&&n[1]<w){var L=c.subtract(o,a,c.create()),V=c.length(L);c.scale(L,1/V);var R=.98*V/c.dist(o,f);O(R,L,-1,1,!0)}}}}},this.getGLMaterials=function(){return{color:m,depthShadowMap:void 0,normal:void 0,depth:void 0,highlight:O}},this.getAllTextureIds=function(){return[e.textureId]},this._textureDirty=!1,this.setTextureDirty=function(){this._textureDirty=!0}},m=function(t,r,n){function o(){return r.shaderVariators.HUDMaterial.getProgram([!!c.direction,!!c.worldScale,c.occlusionTest,c.textureIsSignedDistanceField])}i.basicGLMaterialConstructor(this,t);var s=a.OCCLUSION_PIXELS,l=a.OVERLAY,f=0,c=e.clone(t.getParams()),u=r.get("hudOcclusionTestPixel"),h=o();i.singleTextureGLMaterialConstructor(this,n,c),this.beginSlot=function(e){return f=e,c.occlusionTest?e===s||e===l:e===l},this.getProgram=function(){return f===s&&c.occlusionTest?u:h},this.getAllPrograms=function(){return[u,h]},this.updateParameters=function(){var e=t.getParams();c.color=e.color,c.texCoordScale=e.texCoordScale,c.polygonOffset=e.polygonOffset,c.anchorPos=e.anchorPos,c.screenOffset=e.screenOffset,c.screenMinMaxSize=e.screenMinMaxSize,c.direction=e.direction,c.shaderPolygonOffset=e.shaderPolygonOffset,c.textureIsSignedDistanceField=e.textureIsSignedDistanceField,c.outlineColor=e.outlineColor,c.outlineSize=e.outlineSize,this.updateTexture(e.textureId),h=o()},this.bind=function(e,i){t._textureDirty&&(this.renderTexture(e),t._textureDirty=!1);var r=e.gl,n=i.cameraAboveGround?1:-1;if(f===s&&c.occlusionTest)e.bindProgram(u),u.setUniform1f("cameraGroundRelative",n),u.setUniform1f("polygonOffset",c.shaderPolygonOffset),u.setUniform4fv("viewport",i.viewport),u.setUniform4f("color",S[0],S[1],S[2],1),e.setDepthFunction(r.LEQUAL);else{if(e.bindProgram(h),h.setUniform1f("cameraGroundRelative",n),this.bindTexture(e,h),h.setUniform1i("framebufferTex",1),e.bindTexture(i.framebufferTex,1),e.setActiveTexture(0),h.setUniform3fv("markerColor",S),h.setUniform4fv("viewport",i.viewport),h.setUniform4fv("overrideColor",c.color),h.setUniform1f("pixelRatio",i.pixelRatio),h.setUniform1f("polygonOffset",c.shaderPolygonOffset),c.textureIsSignedDistanceField&&(h.setUniform4fv("outlineColor",c.outlineColor),h.setUniform1f("outlineSize",c.outlineSize)),c.worldScale){var o=[-1,-1],a=c.screenMinMaxSize,l=i.proj,g=i.viewport[2]/i.pixelRatio;if(a)if(0!==l[11]){var x=2*Math.atan(1/l[0]),v=Math.tan(x/2)/g*2;o[0]=a[0]*v,o[1]=a[1]*v}else{var m=2/(l[0]*g);d.scale(a,m,o)}h.setUniform2fv("minMaxWorldSizeFactor",o)}c.direction&&h.setUniform3fv("direction",c.direction),h.setUniform2fv("texScale",c.texCoordScale),h.setUniform2fv("screenOffset",c.screenOffset),h.setUniform2fv("anchorPos",c.anchorPos),c.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(0,-4)),e.setBlendingEnabled(!0)}},this.release=function(e){var t=e.gl;f===s&&c.occlusionTest?e.setDepthFunction(t.LESS):(e.setPolygonOffsetFillEnabled(!1),e.setBlendingEnabled(!1))},this.bindView=function(e,t){var r=t.origin;f===s&&c.occlusionTest?(i.bindView(r,t.view,u),i.bindCamPos(r,t.viewInvTransp,u)):(i.bindView(r,t.view,h),i.bindCamPos(r,t.viewInvTransp,h))},this.bindInstance=function(e,t){f===s&&c.occlusionTest?(u.setUniformMatrix4fv("model",t.transformation),u.setUniformMatrix4fv("modelNormal",t.transformationNormal)):h.setUniformMatrix4fv("model",t.transformation)},this.getDrawMode=function(e){var t=e.gl;return f===s&&c.occlusionTest?t.POINTS:t.TRIANGLES}},O=function(t,r,n){function o(){return r.shaderVariators.HUDMaterialHighlight.getProgram([!!s.direction,!!s.worldScale,s.occlusionTest,s.textureIsSignedDistanceField])}i.basicGLMaterialConstructor(this,t);var s=e.clone(t.getParams()),l=r.get("hudOcclusionTestPixel"),f=o();i.singleTextureGLMaterialConstructor(this,n,s),this.beginSlot=function(e){return e===a.OVERLAY},this.getProgram=function(){return f},this.getAllPrograms=function(){return[l,f]},this.updateParameters=function(){var e=t.getParams();s.color=e.color,s.texCoordScale=e.texCoordScale,s.polygonOffset=e.polygonOffset,s.anchorPos=e.anchorPos,s.screenOffset=e.screenOffset,s.screenMinMaxSize=e.screenMinMaxSize,s.direction=e.direction,s.shaderPolygonOffset=e.shaderPolygonOffset,s.textureIsSignedDistanceField=e.textureIsSignedDistanceField,s.outlineColor=e.outlineColor,s.outlineSize=e.outlineSize,this.updateTexture(e.textureId),f=o()},this.bind=function(e,i){if(t._textureDirty&&(this.renderTexture(e),t._textureDirty=!1),e.bindProgram(f),this.bindTexture(e,f),f.setUniform1i("framebufferTex",1),e.bindTexture(i.framebufferTex,1),e.setActiveTexture(0),f.setUniform3fv("markerColor",S),f.setUniform4fv("viewport",i.viewport),f.setUniform4fv("overrideColor",s.color),f.setUniform1f("pixelRatio",i.pixelRatio),f.setUniform1f("polygonOffset",s.shaderPolygonOffset),s.textureIsSignedDistanceField&&(f.setUniform4fv("outlineColor",s.outlineColor),f.setUniform1f("outlineSize",s.outlineSize)),s.worldScale){var r=[-1,-1],n=s.screenMinMaxSize,o=i.proj,a=i.viewport[2]/i.pixelRatio;if(n)if(0!==o[11]){var l=2*Math.atan(1/o[0]),c=Math.tan(l/2)/a*2;r[0]=n[0]*c,r[1]=n[1]*c}else{var u=2/(o[0]*a);d.scale(n,u,r)}f.setUniform2fv("minMaxWorldSizeFactor",r)}s.direction&&f.setUniform3fv("direction",s.direction),f.setUniform2fv("texScale",s.texCoordScale),f.setUniform2fv("screenOffset",s.screenOffset),f.setUniform2fv("anchorPos",s.anchorPos),s.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(0,-4)),e.setBlendingEnabled(!0)},this.release=function(e){e.setPolygonOffsetFillEnabled(!1),e.setBlendingEnabled(!1)},this.bindView=function(e,t){var r=t.origin;i.bindView(r,t.view,f),i.bindCamPos(r,t.viewInvTransp,f)},this.bindInstance=function(e,t){f.setUniformMatrix4fv("model",t.transformation)},this.getDrawMode=function(e){var t=e.gl;return t.TRIANGLES}};return v.loadShaders=function(e,i,n,o){e._parse(t);var a=o.parameters.maxVertexTextureImageUnits>0,f=new r("hud",["vertexShaderHUD","fragmentShaderHUD"],null,n,i,e,o);f.addBinaryShaderSnippetSuffix("Direction","Direction",[!0,!1]),f.addBinaryShaderSnippetSuffix("WorldScale","WorldScale",[!0,!1]),f.addDefine("OcclTest",a?"OCCL_TEST":"OCCL_PIXELSHADER"),f.addDefine("SDF","SIGNED_DISTANCE_FIELD"),n.shaderVariators.HUDMaterial=f;var d=new r("hudHighlight",["vertexShaderHUD","fragmentShaderHUDHighlight"],null,n,i,e,o);d.addBinaryShaderSnippetSuffix("Direction","Direction",[!0,!1]),d.addBinaryShaderSnippetSuffix("WorldScale","WorldScale",[!0,!1]),d.addDefine("OcclTest",a?"OCCL_TEST":"OCCL_PIXELSHADER"),d.addDefine("SDF","SIGNED_DISTANCE_FIELD"),n.shaderVariators.HUDMaterialHighlight=d;var c=new s(o,e.vertexShaderOcclusionTestPixel,e.fragmentShaderSimple,l.Default3D);n.add("hudOcclusionTestPixel",c)},v});