// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/text!./Material.xml","./internal/MaterialUtil","../../../webgl/Program","../lib/ShaderVariations","../lib/Util","../lib/gl-matrix","../lib/RenderSlot","../lib/DefaultVertexAttributeLocations","../lib/DefaultVertexBufferLayouts","../../../webgl/Util"],function(e,t,i,n,r,a,s,o,d,l,u){var f,c=a.assert,h=s.vec3,g=h.create(),p=function(e,t){i.basicMaterialConstructor(this,t),e=e||{},e.ambient=e.ambient||[.2,.2,.2],e.diffuse=e.diffuse||[.8,.8,.8],e.specular=e.specular||[0,0,0],e.shininess=e.shininess||10,e.opacity=void 0!==e.opacity?e.opacity:1,e.blendModeOneOne=e.blendModeOneOne||!1,e.inverseWindingOrder=e.inverseWindingOrder||!1,e.vertexColors=e.vertexColors||!1,e.flipV=e.flipV||!1,e.doubleSided=e.doubleSided||!1,e.cullFace=e.cullFace||void 0,e.instanced=e.instanced||!1,this.instanced=!!e.instanced,e.writeStencil=e.writeStencil||!1,e.textureId||(e.reflTextureId=void 0);var n;n=e.textureId?e.atlasRegions?"Pos3NormTexRegion":"Pos3NormTex":"Pos3Norm",e.vertexColors&&(n+="Col");var r=l[n],a=e.instanced?l.ModelCol:null;e.instanced&&(a=e.instanced.indexOf("color")>-1?l.ModelCol:l.Model);var s=this.isVisible.bind(this);this.isVisible=function(){return s()&&e.opacity>0},this.dispose=function(){},this.getParams=function(){return e},this.getParameterValues=function(){var t={ambient:e.ambient,diffuse:e.diffuse,specular:e.specular,shininess:e.shininess,opacity:e.opacity,transparent:e.transparent,polygonOffset:e.polygonOffset,reflectivity:e.reflectivity,atlasRegions:e.atlasRegions,flipV:e.flipV,doubleSided:e.doubleSided,cullFace:e.cullFace,writeStencil:e.writeStencil};return e.textureId&&(t.textureId=e.textureId,t.initTexture=e.initTexture),t},this.setParameterValues=function(t){for(var i in t)"textureId"===i&&c(e.textureId,"Can only change texture of material that already has a texture"),e[i]=t[i];this.notifyDirty("matChanged")},this.getOutputAmount=function(e){var t=u.getStride(r)/4;return e*t},this.getVertexBufferLayout=function(){return r},this.getInstanceBufferLayout=function(){return a},this.fillInterleaved=function(e,t,n,a,s,o,d){i.fillInterleaved(e,t,n,a,r,s,o,d)},this.intersect=i.intersectTriangleGeometry,this.getGLMaterials=function(){return{color:T,depthShadowMap:D,normal:O,depth:S,highlight:I}},this.getAllTextureIds=function(){var t=[];return e.textureId&&t.push(e.textureId),e.reflTextureId&&t.push(e.reflTextureId),t}};p.paramsFromOldConstructor=function(e,t,i,n,r,a,s,o,d,l,u,f,c){return{textureId:e,transparent:t,ambient:i,diffuse:n,specular:r,shininess:a,opacity:s,polygonOffset:o,initTexture:d,reflTextureId:l,reflectivity:u,flipV:f,doubleSided:c,cullFace:void 0}};var v=function(e){return e.cullFace?"none"!==e.cullFace:e.transparent?!1:!0},x=function(e,t){var i=e.gl,n=v(t);n?(e.setFaceCullingEnabled(!0),"front"===t.cullFace&&e.setCullFace(i.FRONT)):e.setFaceCullingEnabled(!1)},m=function(e,t){var i=e.gl,n=v(t);n?(e.setFaceCullingEnabled(!1),"front"===t.cullFace&&e.setCullFace(i.BACK)):e.setFaceCullingEnabled(!0)},b=function(e,t){return e?o.TRANSPARENT_MATERIAL:t?o.STENCIL_MATERIAL:o.OPAQUE_MATERIAL},T=function(t,n,r){i.basicGLMaterialConstructor(this,t);var a=e.clone(t.getParams()),s=b(a.transparent,a.writeStencil);i.singleTextureGLMaterialConstructor(this,r,a);var o=i.aquireIfNotUndefined(a.reflTextureId,a.reflInitTexture,r);o&&(o=o.getGLTexture()),c(!(a.atlasRegions&&a.reflTextureId),"Atlas texture with reflection is not yet supported");var d=a.textureId?a.atlasRegions?"AtlasTextured":"Textured":"none";this.instanced=f&&a.instanced;var l=!!this.instanced&&this.instanced.indexOf("color")>-1;this._loadProgram=function(e){return n.shaderVariators.Material.getProgram([d,!!a.reflTextureId,a.vertexColors,a.flipV,a.doubleSided,!!this.instanced,l,e])};var u=this._loadProgram(!1),p=this._loadProgram(!0),v=null,T="AtlasTextured"===d,S=this.dispose;this.dispose=function(){S(),i.releaseIfNotUndefined(a.reflTextureId,r)},this.beginSlot=function(e){return s===e},this.getProgram=function(){return v||u},this.getAllPrograms=function(){return[p,u]},this.updateParameters=function(){var e=t.getParams();a.ambient=e.ambient,a.diffuse=e.diffuse,a.specular=e.specular,a.shininess=e.shininess,a.opacity=e.opacity,a.polygonOffset=e.polygonOffset,a.reflectivity=e.reflectivity,a.flipV=e.flipV,a.doubleSided=e.doubleSided,a.cullFace=e.cullFace,a.transparent!=e.transparent&&(s=b(e.transparent),a.transparent=e.transparent),a.initTexture=e.initTexture,this.updateTexture(e.textureId),e.atlasRegions&&(a.atlasRegions=e.atlasRegions),a.blendModeOneOne=e.blendModeOneOne,a.inverseWindingOrder=e.inverseWindingOrder},this.bind=function(e,t){var i=e.gl,n=t.shadowMap&&t.shadowMap.getEnableState();v=n?p:u,e.bindProgram(v),v.setUniform3fv("ambient",a.ambient),v.setUniform3fv("diffuse",a.diffuse),v.setUniform3fv("specular",a.specular),v.setUniform1f("shininess",a.shininess),v.setUniform1f("opacity",a.opacity),t.shadowMap||v.setUniform1f("depthHalfPixelSz",-1),this.bindTexture(e,v),T&&this.bindTextureSize(e,v),e.setBlendFunctionSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA),void 0!==o&&(v.setUniform1i("reflTex",1),e.bindTexture(o,1),v.setUniform1f("reflectivity",a.reflectivity)),a.inverseWindingOrder&&e.setFrontFace(i.CW),a.transparent&&(e.setBlendingEnabled(!0),a.blendModeOneOne&&(e.setBlendFunction(i.ONE,i.ONE),e.setDepthWriteEnabled(!1))),a.polygonOffset&&(e.setPolygonOffsetFillEnabled(!0),e.setPolygonOffset(2,2)),x(e,a)},this.release=function(e,t){var i=e.gl;e.setPolygonOffsetFillEnabled(!1),m(e,a),e.setBlendingEnabled(!1),e.setBlendFunctionSeparate(i.SRC_ALPHA,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA),e.setDepthWriteEnabled(!0),e.setFrontFace(i.CCW)},this.bindView=function(e,t){var n=t.shadowMap&&t.shadowMap.getEnableState();v=n?p:u;var r=t.origin;i.bindView(r,t.view,v),i.bindCamPos(r,t.viewInvTransp,v),t.shadowMap&&t.shadowMap.bindView(v,r)},this.bindInstance=function(e,t){if(v.setUniformMatrix4fv("model",t.transformation),v.setUniformMatrix4fv("modelNormal",t.transformationNormal),l&&t.instanceParameters){var i=t.instanceParameters.color;i&&(h.multiply(a.ambient,i,g),v.setUniform3fv("ambient",g),h.multiply(a.diffuse,i,g),v.setUniform3fv("diffuse",g),v.setUniform1f("opacity",a.opacity*i[3]))}},this.getDrawMode=function(e){var t=e.gl;return t.TRIANGLES}},S=function(t,n,r,a){i.basicGLMaterialConstructor(this,t);var s=e.clone(t.getParams()),o=null!=a?n.get(u.hasAttribute(t.getVertexBufferLayout(),"uv0")?"depthTexturedShadowMap":"depthShadowMap"):n.get(u.hasAttribute(t.getVertexBufferLayout(),"uv0")?"depthTextured":"depth"),d=b(s.transparent,s.writeStencil);i.singleTextureGLMaterialConstructor(this,r,s),this.beginSlot=function(e){return d===e},this.getProgram=function(){return o},this.updateParameters=function(){var e=t.getParams();s.initTexture=e.initTexture,s.cullFace=e.cullFace,s.inverseWindingOrder=e.inverseWindingOrder,this.updateTexture(e.textureId)},this.bind=function(e,t){var i=e.gl;e.bindProgram(o),o.setUniform2fv("nearFar",t.nearFar),s.inverseWindingOrder&&e.setFrontFace(i.CW),this.bindTexture(e,o),x(e,s)},this.release=function(e){var t=e.gl;m(e,s),s.inverseWindingOrder&&e.setFrontFace(t.CCW)},this.bindView=function(e,t){i.bindView(t.origin,t.view,o)},this.bindInstance=function(e,t){o.setUniformMatrix4fv("model",t.transformation)},this.getDrawMode=function(e){var t=e.gl;return t.TRIANGLES}},D=function(e,t,i){S.call(this,e,t,i,!0)},O=function(t,n,r){i.basicGLMaterialConstructor(this,t);var a=e.clone(t.getParams()),s=n.get(u.hasAttribute(t.getVertexBufferLayout(),"uv0")?"normalTextured":"normal"),o=b(a.transparent,a.writeStencil);i.singleTextureGLMaterialConstructor(this,r,a),this.beginSlot=function(e){return o===e},this.getProgram=function(){return s},this.updateParameters=function(){var e=t.getParams();a.initTexture=e.initTexture,a.cullFace=e.cullFace,a.inverseWindingOrder=e.inverseWindingOrder,this.updateTexture(e.textureId)},this.bind=function(e,t){var i=e.gl;e.bindProgram(s),this.bindTexture(e,s),s.setUniformMatrix4fv("viewNormal",t.viewInvTransp),x(e,a),a.inverseWindingOrder&&e.setFrontFace(i.CW)},this.release=function(e){var t=e.gl;m(e,a),a.inverseWindingOrder&&e.setFrontFace(t.CCW)},this.bindView=function(e,t){i.bindView(t.origin,t.view,s)},this.bindInstance=function(e,t){s.setUniformMatrix4fv("model",t.transformation),s.setUniformMatrix4fv("modelNormal",t.transformationNormal)},this.getDrawMode=function(e){var t=e.gl;return t.TRIANGLES}},I=function(t,n,r,a){i.basicGLMaterialConstructor(this,t);var s=e.clone(t.getParams()),d=n.get(u.hasAttribute(t.getVertexBufferLayout(),"uv0")?"highlightTextured":"highlight"),l=o.OPAQUE_MATERIAL;i.singleTextureGLMaterialConstructor(this,r,s),this.beginSlot=function(e){return l===e},this.getProgram=function(){return d},this.updateParameters=function(){var e=t.getParams();s.initTexture=e.initTexture,s.cullFace=e.cullFace,s.inverseWindingOrder=e.inverseWindingOrder,this.updateTexture(e.textureId)},this.bind=function(e,t){var i=e.gl;e.bindProgram(d),this.bindTexture(e,d),x(e,s),s.inverseWindingOrder&&e.setFrontFace(i.CW)},this.release=function(e){var t=e.gl;m(e,s),s.inverseWindingOrder&&e.setFrontFace(t.CW)},this.bindView=function(e,t){i.bindView(t.origin,t.view,d)},this.bindInstance=function(e,t){d.setUniformMatrix4fv("model",t.transformation),d.setUniformMatrix4fv("modelNormal",t.transformationNormal)},this.getDrawMode=function(e){var t=e.gl;return t.TRIANGLES}};return p.loadShaders=function(e,i,a,s){e._parse(t),f=s.extensions.angleInstancedArrays,s.extensions.shaderTextureLOD,s.extensions.standardDerivatives;var o=new r("phong",["vsPhong","fsPhong"],null,a,i,e,s);o.addNaryShaderSnippetSuffix([{value:"none",programNameSuffix:"",shaderSnippetSuffix:""},{value:"Textured"},{value:"AtlasTextured"}]),o.addBinaryShaderSnippetSuffix("Refl","Refl",[!1,!0]),o.addDefine("Color","VERTEXCOLORS"),o.addDefine("FlipV","FLIPV"),o.addDefine("DoubleSided","DOUBLESIDED"),o.addDefine("Instanced","INSTANCED"),o.addDefine("InstColor","INSTANCEDCOLOR"),o.addDefine("ReceiveShadows","RECEIVE_SHADOWS"),a.shaderVariators.Material=o;var l=new n(s,e.vsDepth,e.fsDepth,d.Default3D,["BIAS_SHADOWMAP 1"]),u=new n(s,e.vsDepthTextured,e.fsDepthTextured,d.Default3D,["BIAS_SHADOWMAP 1"]),c=new n(s,e.vsDepth,e.fsDepth,d.Default3D),h=new n(s,e.vsDepthTextured,e.fsDepthTextured,d.Default3D),g=new n(s,e.vsNormal,e.fsNormal,d.Default3D),p=new n(s,e.vsNormalTextured,e.fsNormalTextured,d.Default3D),v=new n(s,e.vsHighlight,e.fsHighlight,d.Default3D),x=new n(s,e.vsHighlightTextured,e.fsHighlightTextured,d.Default3D);a.add("depthShadowMap",l),a.add("depthTexturedShadowMap",u),a.add("depth",c),a.add("depthTextured",h),a.add("normal",g),a.add("normalTextured",p),a.add("highlight",v),a.add("highlightTextured",x),i.add("fsDepth",{source:e.fsDepth}),i.add("fsDepthTextured",{source:e.fsDepthTextured}),i.add("fsDepthShadowMap",{source:e.fsDepthShadowMap,defines:["BIAS_SHADOWMAP 1"]}),i.add("fsDepthTexturedShadowMap",{source:e.fsDepthTextured,defines:["BIAS_SHADOWMAP 1"]}),i.add("vsDepth",{source:e.vsDepth}),i.add("fsNormal",{source:e.fsNormal})},p});