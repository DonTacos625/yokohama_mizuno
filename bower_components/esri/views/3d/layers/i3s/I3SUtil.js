// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["require","exports","../../lib/glMatrix","../../support/earthUtils","../../support/projectionUtils","../../../../core/requireUtils","../../../../core/promiseUtils","../../../../core/Error","../../../../core/urlUtils","../../../../geometry/support/webMercatorUtils","dojo/_base/lang","dojo/promise/all","../../../../request","../../../../geometry/SpatialReference","../../../../geometry/support/scaleUtils","../../webgl-engine/Stage","../../webgl-engine/materials/Material","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/Object3D","../../webgl-engine/lib/Layer","../../webgl-engine/lib/Util","./I3SBinaryReader"],function(e,r,t,n,a,i,o,s,l,u,d,c,f,g,p,h,v,b,m,w,y,R,S){function T(e){return"/"!==e[e.length-1]&&(e+="/"),e}function M(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function I(e){var r=new g(M(e.store.indexCRS||e.store.geographicCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function C(e){var r=new g(M(e.store.vertexCRS||e.store.projectedCRS));return r.equals(e.spatialReference)?e.spatialReference:r}function E(e){return null==p.getUnitValue(e)}function O(e,r,t){var n=I(e),a=C(e);if(!u.canProject(n,r)||!u.canProject(a,r))throw new s("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{layer:e,viewSR:r,indexSR:n,vertexSR:a});if("local"===t&&(E(n)||E(a)))throw new s("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{layer:e,indexSR:n,vertexSR:a})}function x(e,r,t){switch(r){case"none":G(e);break;case"east-north-up":break;case"earth-centered":var n=a.SphericalRenderSpatialReference;t(e.normals,n);break;case"vertex-reference-frame":break;default:throw new Error("Received unexpected normalReferenceFrame: "+r)}}function G(e){var r=e.normals,t=e.positions,n=e.normalInd,a=e.positionInd;W(e.normalInd.length===e.positionInd.length);for(var i=P.create(),o=P.create(),s=0;s<a.length;s+=3){var l=3*a[s],u=t[l],d=t[l+1],c=t[l+2];l=3*a[s+1],i[0]=t[l]-u,i[1]=t[l+1]-d,i[2]=t[l+2]-c,l=3*a[s+2],o[0]=t[l]-u,o[1]=t[l+1]-d,o[2]=t[l+2]-c,P.cross(i,o,i),P.normalize(i);for(var f=0;3>f;f++){var g=3*n[s+f];r[g]=i[0],r[g+1]=i[1],r[g+2]=i[2]}}}function _(e,t){if(Array.isArray(e)){if(t){var n=e.indexOf(r.DDS_ENCODING_STRING);if(n>-1)return n}for(var a=0;a<e.length;a++)if(r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(e[a])>-1)return a;throw new Error("Could not find appropriate texture encoding (among "+e.toString()+")")}return-1}function j(e,r,t,n,i,o){if(null!=t){var s=Y;if(a.mbsToMbs(t.mbs,n,s,r),0!==this.intersectBoundingBoxWithMbs(e,s)){o.push(t);for(var l=null!=t.children?t.children.length:0,u=0;l>u;u++){var d=i[t.children[u].id];this.findIntersectingNodes(e,r,d,n,i,o)}}}}function A(e,r){var t=r[0],n=r[1],a=r[2],i=r[3],o=0;if(t<e[0]){var s=e[0]-t;o+=s*s}if(n<e[1]){var s=e[1]-n;o+=s*s}if(a<e[2]){var s=e[2]-a;o+=s*s}if(t>e[3]){var s=t-e[3];o+=s*s}if(n>e[4]){var s=n-e[4];o+=s*s}if(a>e[5]){var s=a-e[5];o+=s*s}if(o>i*i)return 0;if(o>0)return 1;var l=1/0;return t-e[0]<l&&(l=t-e[0]),n-e[1]<l&&(l=n-e[1]),a-e[2]<l&&(l=a-e[2]),e[3]-t<l&&(l=e[3]-t),e[4]-n<l&&(l=e[4]-n),e[5]-a<l&&(l=e[5]-a),l>i?2:1}function N(e,r,t){function i(e){return{ambient:e,diffuse:[0,0,0],transparent:!0,opacity:.5,blendModeOneOne:!1}}var o=new b(m.createCylinderGeometry(1,1,64,[0,0,1],[0,0,0],!1),"debugCylinder"),s=new b(m.createSphereGeometry(1),"debugSphere"),l={red:new v(i([.8,0,0]),"debugMaterialRed"),grey:new v(i([.4,.4,.4]),"debugMaterialGrey"),brown:new v(i([.2,.1,0]),"debugMaterialBrown"),green:new v(i([0,.8,0]),"debugMaterialGreen"),blue:new v(i([0,0,.8]),"debugMaterialBlue"),yellow:new v(i([.8,.8,0]),"debugMaterialYellow"),magenta:new v(i([.8,0,.8]),"debugMaterialMagenta")};for(var u in l)e.add(h.ModelContentType.MATERIAL,l[u]);e.add(h.ModelContentType.GEOMETRY,o);var d=new y(t+"_debug",{interaction:"IGNORED"},t+"_debug");e.add(h.ModelContentType.LAYER,d),e.addToViewContent([d.getId()]);var c=P.create(),f=F.create();return{engineLayer:d,added:{},show:function(e,t,i){var s=e.computedMbs;s||(s=q.create(),a.mbsToMbs(e.mbs,t,s,r.spatialReference));var u="node"+e.id+"dbg";P.set(s,c);var d=s[3];if(d>n.earthRadius/10&&r.spatialReference===a.SphericalRenderSpatialReference){this.showWS(c,Math.max(.01*d,1e4),i,u+"_center");var g=P.length(c),p=n.earthRadius;if(p+d>g){var h=(g*g+p*p-d*d)/(2*g);P.scale(c,h/g),d=Math.sqrt(p*p-h*h)}}F.identity(f),F.scale(f,[d,d,.05*d]);var v=l[i];W(v);var b=new w({name:u,geometries:[o],materials:[[v]],transformations:[f],castShadow:!1,idHint:u});a.computeLinearTransformation(t,e.mbs,f,r.spatialReference),null!=c&&(f[12]=c[0],f[13]=c[1],f[14]=c[2]),b.setObjectTransformation(f),this._addToStage(b,u)},showWS:function(e,r,t,n){var a=F.identity();F.scale(a,[r,r,r]);var i=l[t];W(i);var o=new w({name:n,geometries:[s],materials:[[i]],transformations:[a],castShadow:!1,idHint:n}),u=F.identity();F.translate(u,e),o.setObjectTransformation(u),this._addToStage(o,n)},_addToStage:function(r,t){e.add(h.ModelContentType.OBJECT,r),this.engineLayer.addObject(r);var n=this.added[t];void 0!==n&&(e.remove(h.ModelContentType.OBJECT,n.getId()),this.engineLayer.removeObject(n)),this.added[t]=r},clear:function(){for(var r in this.added){var t=this.added[r];e.remove(h.ModelContentType.OBJECT,t.getId()),this.engineLayer.removeObject(t)}this.added={}},dispose:function(){this.clear();for(var r in l)e.remove(h.ModelContentType.MATERIAL,l[r].getId());e.remove(h.ModelContentType.GEOMETRY,o.getId()),e.remove(h.ModelContentType.LAYER,this.engineLayer.getId())}}}function D(e,r,t){var n=new XMLHttpRequest;n.open("PUT","/put.php"+e,!0),n.setRequestHeader("Content-type",t),n.send(r)}function U(e,r,t,n,a){var i=n.filter(function(e){return!r.attributes.hasOwnProperty(e)});if(0===i.length)return o.resolve(r);var s=function(e){return d.mixin(r.attributes,e),r},l=e.companionFeatureLayer,u=e.attributeStorageInfo;if(l)return L(l,t,i).then(s);if(u){var c=a();if(null!=c)return k(u,c.node,c.index,i,e.token).then(s)}return o.reject()}function L(r,t,n){return void 0===n&&(n=["*"]),r?i.when(e,["../../../../tasks/support/Query","../../../../tasks/QueryTask"]).then(function(e){var a=e[0],i=e[1],o=new a({objectIds:[t],outFields:n}),s=new i(r.parsedUrl.path);return s.execute(o)}).then(function(e){return e&&e.features&&e.features.length>0?e.features[0].attributes:o.reject(new Error("Feature not found in companion feature layer."))}):o.reject(new Error("Companion feature layer not present."))}function k(e,r,t,n,a){void 0===n&&(n=["*"]);var i=n.some(function(e){return"*"===e});return c(r.attributeData.map(function(t,s){if(!i&&!n.some(function(r){return e[s].name===r}))return o.resolve(null);var u=l.makeAbsolute(t.href,r.baseUrl);return f(u,{query:{token:a},responseType:"array-buffer"}).then(function(r){return S.readBinaryAttribute(e[s],r.data)}).otherwise(function(){return null})})).then(function(r){for(var n={},a=0;a<r.length;a++)null!=r[a]&&(n[e[a].name]=r[a][t]);return n})}function B(e,r){for(var t=0,n=e.length-1;n>t;){var a=t+(n-t>>1);r>e[a]?t=a+1:n=a}return r===e[t]?t:~t}var q=t.vec4d,P=t.vec3d,F=t.mat4d,W=R.assert,Y=q.create();r.DDS_ENCODING_STRING="image/vnd-ms.dds",r.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"],r.addTrailingSlash=T,r.extractWkid=M,r.getIndexCrs=I,r.getVertexCrs=C,r.checkSpatialReference=O,r.processNormals=x,r.getAppropriateTextureEncoding=_,r.findIntersectingNodes=j,r.intersectBoundingBoxWithMbs=A,r.makeNodeDebugVisualizer=N,r.postData=D,r.whenGraphicAttributes=U,r.queryAttributesFromFeatureLayer=L,r.queryAttributesFromCachedAttributes=k,r.binaryIndexOf=B});