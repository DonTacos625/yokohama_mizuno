// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["../../../../core/declare","dojo/_base/lang","dojo/when","./Graphics3DSymbolLayer","./Graphics3DGraphicLayer","./Graphics3DDrapedGraphicLayer","./ElevationAligners","./Graphics3DSymbolCommonCode","./SignedDistanceFunctions","../../../../core/urlUtils","../../../../core/screenUtils","../../../../config","../../../../Color","../../../../geometry/Polygon","../../support/projectionUtils","../../lib/glMatrix","../../webgl-engine/Stage","../../webgl-engine/lib/Geometry","../../webgl-engine/lib/GeometryUtil","../../webgl-engine/lib/RenderGeometry","../../webgl-engine/lib/Texture","../../webgl-engine/materials/HUDMaterial"],function(e,t,i,r,n,o,s,a,l,u,c,h,_,d,g,p,f,m,v,y,R,I){function x(e){return"cross"===e||"x"===e}function O(e){var t,i=G,r=i*w;switch("primitive:"===e.substring(0,10)&&(e=e.substring(10)),e){case U.PRIM_CIRCLE:t=l.computeSignedDistancefieldCicle(i,r);break;case U.PRIM_SQUARE:t=l.computeSignedDistancefieldSquare(i,r,!1);break;case U.PRIM_KITE:t=l.computeSignedDistancefieldSquare(i,r,!0);break;case U.PRIM_CROSS:t=l.computeSignedDistancefieldCrossAndX(i,r,!1);break;case U.PRIM_X:t=l.computeSignedDistancefieldCrossAndX(i,r,!0)}return new R(t,"sdf_"+e,{mipmap:!1,wrapClamp:!0,width:G,height:G,components:4})}var E=p.vec3d,b=p.vec4d,S=p.mat4d,M=S.identity(),D=[0,0,1],T=[0,0,0,0],z=["center","bottom","top","left","right","bottom-left","bottom-right","top-left","top-right"],A="circle",C=16,P=1.5,G=128,w=.5,U={PRIM_CIRCLE:"circle",PRIM_SQUARE:"square",PRIM_CROSS:"cross",PRIM_X:"x",PRIM_KITE:"kite"},L=e([r],{_prepareResources:function(){var e=this.symbol,t=null!=e.size?c.pt2px(e.size):C;this._size=null,this._symbolTextureRatio=1,this._primitive=null;var i=this._getStageIdHint();this._isPropertyDriven("size")&&64>t&&(t=64);var r=e.resource||{primitive:A},n={anchorPos:this._getAnchorPos(e)};if(r.href)n.color=this._getFillColor(e,null),n.outlineColor=this._getOutlineColor(e),n.outlineSize=this._getOutlineSize(e,null),n.textureIsSignedDistanceField=!1,this._prepareImageResources(r.href,t,n,i);else{var o=r.primitive||A,s="primitive:"+o;if(this._primitive=o,n.color=this._getFillColor(e,o),n.outlineColor=this._getOutlineColor(e),n.outlineSize=this._getOutlineSize(e,o),x(o)&&0===n.outlineSize)return void this.reject();this.texture=this._context.sharedResources.textures.acquire(s,O),this._textureURI=s,n.textureIsSignedDistanceField=!0,n.textureId=this.texture.getId(),this._createMaterialsAndAddToStage(n,this._context.stage,i),this._size=[t,t],this._symbolTextureRatio=1/w,this.resolve()}},_getOutlineDefaultSize:function(e){return x(e)?P:0},_getOutlineSize:function(e,t){return e.outline&&null!=e.outline.size?c.pt2px(e.outline.size):this._getOutlineDefaultSize(t)},_getOutlineColor:function(e){var t=this._getLayerOpacity();if(e.outline){if(null!=e.outline.color){var i=_.toUnitRGB(e.outline.color),r=e.outline.color.a*t;return[i[0],i[1],i[2],r]}return[0,0,0,t]}return[0,0,0,t]},_getFillColor:function(e,t){return x(t)?T:this._getMaterialOpacityAndColor()},_getAnchorPos:function(e){return z.indexOf(e.anchor)>-1?e.anchor:"center"},_prepareImageResources:function(e,t,r,n){var o=function(e){if(!this.isRejected()){var i=e.params,o=i.width/i.height;t?o>1?this._size=[t,t/o]:this._size=[t*o,t]:this._size=[i.width,i.height],r.textureId=e.getId(),this._createMaterialsAndAddToStage(r,this._context.stage,n),this.resolve()}}.bind(this),s="data:image/svg"===e.substring(0,14),a=".svg"===e.substring(e.length-4,e.length),l=s||a;if(l){var c=e;c=u.normalize(c);var _=new Image,d=!s&&u.hasSameOrigin(c,window.location.href);s?_.src=c:d||u.canUseXhr(c)?(d||(_.crossOrigin="anonymous"),_.src=c):(h.request.proxyUrl&&(c=h.request.proxyUrl+"?"+c),_.src=c),_.onerror=function(){this.reject()}.bind(this),_.onload=function(){var e=_.width,r=_.height,n=1;e&&r&&(n=e/r),null!=t&&(n>1?(e=t,r=Math.round(t/n)):(r=t,e=Math.round(t*n)));var s=document.createElement("canvas");s.width=e,s.height=r;var a=s.getContext("2d");a.drawImage(_,0,0,e,r);var l=s.toDataURL();i(this._context.sharedResources.textures.acquire(l),o,function(){this.reject()}),this.textureURI=l}.bind(this),_.onerror=function(){console.warn("Failed to create Icon primitive"),this.reject()}.bind(this)}else i(this._context.sharedResources.textures.acquire(e),o,function(){this.reject()}.bind(this)),this._textureURI=e},_createMaterialsAndAddToStage:function(e,i,r){var n=t.clone(e);n.occlusionTest=!1,n.shaderPolygonOffset=0,this._drapedMaterial=new I(n,r+"_iconDraped"),i.add(f.ModelContentType.MATERIAL,this._drapedMaterial),e.occlusionTest=!0,this._material=new I(e,r+"_icon"),i.add(f.ModelContentType.MATERIAL,this._material)},destroy:function(){this.isFulfilled()||this.reject(),this._material&&(this._context.stage.remove(f.ModelContentType.MATERIAL,this._material.getId()),this._material=null),this._drapedMaterial&&(this._context.stage.remove(f.ModelContentType.MATERIAL,this._drapedMaterial.getId()),this._drapedMaterial=null),this._textureURI&&(this._context.sharedResources.textures.release(this._textureURI),this._textureURI=null)},createGraphics3DGraphic:function(e,t,i){var r=e.geometry;if("extent"===r.type&&(r=d.fromExtent(r)),"polyline"===r.type)r=a.placePointOnPolyline(r);else if("polygon"===r.type)r=a.placePointOnPolygon(r);else if("point"!==r.type)return this._logWarning("unsupported geometry type for icon symbol: "+r.type),null;var n="graphic"+e.uid,o=1;if(this._isPropertyDriven("size")&&t.size){for(var s=0;3>s;s++)t.size[s]&&(t.size[s]=c.pt2px(t.size[s]));var l=this._size[0]>this._size[1]?this._size[0]:this._size[1];isFinite(t.size[0])?o=t.size[0]/l:"symbolValue"===t.size[0]?o=1:isFinite(t.size[2])&&(o=t.size[2]/l)}var u=this._getVertexOpacityAndColor(t);o*=this._symbolTextureRatio;var h=[this._size[0]*o,this._size[1]*o],_=this._getGraphicElevationInfo(e);return _.mode===a.ELEV_MODES.ON_THE_GROUND?this._createAsOverlay(e,r,u,h,_,n,e.uid,i):this._createAs3DShape(e,r,u,h,_,n,e.uid,i)},layerPropertyChanged:function(e,t,i){if("opacity"===e){var r=this._getFillColor(this.symbol,this._primitive);this._drapedMaterial.setParameterValues({color:r}),this._material.setParameterValues({color:r});var n=this._getOutlineColor(this.symbol);return this._drapedMaterial.setParameterValues({outlineColor:n}),this._material.setParameterValues({outlineColor:n}),!0}if("elevationInfo"===e){var o=this._elevationInfo.mode;this._updateElevationInfo();var l=this._elevationInfo.mode,u=a.ELEV_MODES;if(o===u.ON_THE_GROUND&&l===u.ON_THE_GROUND)return!0;if(o!==l&&(o===u.ON_THE_GROUND||l===u.ON_THE_GROUND))return!1;var c=this._context.elevationProvider,h=this._context.renderCoordsHelper,_=s.perObjectElevationAligner;for(var d in t){var g=t[d],p=g._graphics[i];if(p){var f=g.graphic,m=this._getGraphicElevationInfo(f);p.elevationAligner=l===u.RELATIVE_TO_GROUND?_:null,p.elevationInfo.set(m),_(p,c,h)}}return!0}return!1},setDrawOrder:function(e,t,i){this._drapedMaterial&&(this._drapedMaterial.setRenderPriority(e),i[this._drapedMaterial.getId()]=!0)},_defaultElevationInfoNoZ:{mode:a.ELEV_MODES.RELATIVE_TO_GROUND,offset:0},_getGraphicElevationInfo:function(e){var t=this.inherited(arguments);return t.mode!==a.ELEV_MODES.RELATIVE_TO_GROUND||0!==t.offset||e.geometry.get("hasZ")||(t.offset=1/this._context.renderCoordsHelper.unitInMeters),t},_createAs3DShape:function(e,t,i,r,o,l,u){var c=v.createPointGeometry(D,null,i,r,null,b.createFrom(0,0,0,1)),h=new m(c,l),_=[h],d=this._context.layer.id,g=a.createStageObjectForPoint.call(this,t,_,[[this._material]],null,null,o,l,d,u,!0);if(null===g)return null;var p=null;o.mode===a.ELEV_MODES.RELATIVE_TO_GROUND&&(p=s.perObjectElevationAligner);var f=new n(this,g,_,null,null,p,o);return f.getScreenSize=function(e,t){return function(){return[e,t]}}(r[0]/this._symbolTextureRatio,r[1]/this._symbolTextureRatio),a.extendPointGraphicElevationInfo(f,t,this._context.elevationProvider),f},_createAsOverlay:function(e,t,i,r,n,s,l){this._drapedMaterial.setRenderPriority(this._symbolLayerOrder);var u=E.create();g.pointToVector(t,u,this._context.overlaySR),u[2]=this._getDrapedZ();var c=this._context.clippingExtent;if(c&&!a.pointInBox2D(u,c))return null;var h=v.createPointGeometry(D,u,i,r,!0),_=new y(h);_.material=this._drapedMaterial,_.center=u,_.bsRadius=0,_.transformation=M,_.name=s,_.uniqueName=s+"#"+h.id;var d=new o(this,[_],null,null);return d.getScreenSize=function(e,t){return function(){return[e,t]}}(r[0]/this._symbolTextureRatio,r[1]/this._symbolTextureRatio),d}});return L.VALID_ANCHOR_STRINGS=z,L});