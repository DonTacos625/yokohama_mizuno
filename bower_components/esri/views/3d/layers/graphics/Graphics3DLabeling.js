// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["require","exports","dojo/promise/all","dojo/Deferred","../../webgl-engine/lib/TextTextureAtlas","../../webgl-engine/lib/MaterialCollection","../../webgl-engine/materials/HUDMaterial","./Graphics3DWebStyleSymbol","../../../../layers/support/LabelClass","../../lib/glMatrix"],function(e,t,a,r,l,i,s,n,o,h){function c(e){return e instanceof n?e.graphics3DSymbol:e}var f,b=h.vec3d,p="VISIBILITY_LABEL_SHOW",u=function(){function e(){this.textTextureAtlas=null,this.hudMaterialCollection=null,this.showLabelsChangeOnResume=!1,this.labelClasses=[],this.eventHandles=[],this.layerView=null,this.layer=null,this.graphicsCore=null}return e.prototype.initialize=function(e,t,a){var r=this;this.layerView=e,this.layer=t,this.graphicsCore=a,this.layerView.view.labelManager.addSceneServiceLayerView(this),this.eventHandles.push(this.layerView.watch("suspended",function(){return r.suspendedChange()}))},e.prototype.destroy=function(){this.layerView.view.labelManager.removeSceneServiceLayerView(this),this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null),this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null),this.labelClasses=null,this.eventHandles.forEach(function(e){return e.remove()}),this.eventHandles=null,this.layerView=null,this.layer=null,this.graphicsCore=null},e.prototype.clear=function(){this.layerView.view.labelManager.setDirty(),this.textTextureAtlas&&(this.textTextureAtlas.dispose(),this.textTextureAtlas=null),this.hudMaterialCollection&&(this.hudMaterialCollection.dispose(),this.hudMaterialCollection=null)},e.prototype.suspendedChange=function(){this.layerView.suspended===!1&&this.showLabelsChangeOnResume&&this.showLabelsChange()},e.prototype.initLabelingInfo=function(){var e=this,t=new r;return this.layer.then(function(){var r=e.layer.labelingInfo&&e.layer.labelingInfo.filter(function(e){return!!e.symbol});if(r&&r.length>0){e.labelClasses=new Array(r.length);for(var l=[],i=function(t){var a=e.graphicsCore.getOrCreateGraphics3DSymbol(r[t].symbol);a.then(function(){e.labelClasses[t]={labelClass:r[t],graphics3DSymbolLayer:c(a),graphics3DGraphics:[]}}),l.push(a)},s=0;s<r.length;s++)i(s);a(l).then(function(){t.resolve()})}else t.resolve()}),t.promise},e.prototype.createLabelsForGraphic=function(e,t){if(this.labelClasses&&this.labelClasses.length>0&&t._graphics[0])for(var a=0;a<this.labelClasses.length;a++){var r=this.labelClasses[a];if(o.evaluateWhere(r.labelClass.where,e.attributes)){var s=r.labelClass.getLabelExpression();if(s){var n=o.buildLabelText(s,e.attributes,this.layer.fields);if(n){var h=r.graphics3DSymbolLayer.childGraphics3DSymbols[0],c=this.evalLabelPlacementParams(e,t);null==this.textTextureAtlas&&(this.textTextureAtlas=new l(this.layer.id,this.layerView.view._stage),this.hudMaterialCollection=new i(this.layerView.view._stage));var f=h.createGraphics3DGraphic(e,{text:n,centerOffset:c.centerOffset,translation:c.translation,screenOffset:c.screenOffset,anchor:c.anchor},this.hudMaterialCollection,this.textTextureAtlas);f&&(f._labelClass=r.labelClass,t.addLabelGraphic(f),r.graphics3DGraphics.push(t),f.setVisibilityFlag(p,this.layerLabelsEnabled()),this.layerView.view.labelManager.setInitialLabelGraphicState(f));break}}}}return t},e.prototype.evalLabelPlacementParams=function(e,t){var a=this.layer.labelingInfo[0],r=g[a.labelPlacement]||g["default"];if("polygon"===e.geometry.type)return{anchor:"center"};if("polyline"===e.geometry.type)return{anchor:"center"};if("extent"===e.geometry.type)return{anchor:"center"};if("point"!==e.geometry.type)return{anchor:r.anchor};var l=t.graphics3DSymbol,i=l instanceof n?l.graphics3DSymbol:l,o=i.symbol.symbolLayers.getItemAt(0),h={screenOffset:[0,0],centerOffset:[0,0,0,-1],translation:t.getCenterObjectSpace(),anchor:r.anchor};if("Icon"===o.type){var c=t._graphics[0].getScreenSize();if(t.isDraped())h.anchor="center";else{var f=t._graphics[0].stageObject.getGeometryRecords()[0].materials[0];if(f instanceof s){var p=f.getParams();h.screenOffset=[c[0]/2*(r.normalizedOffset[0]-2*(p.anchorPos[0]-.5)),c[1]/2*(r.normalizedOffset[1]-2*(p.anchorPos[1]-.5))]}else h.screenOffset=[c[0]/2*r.normalizedOffset[0],c[1]/2*r.normalizedOffset[1]]}}else if("Object"===o.type){var u=t._graphics[0].getBoundingBoxObjectSpace(),c=[u[3]-u[0],u[4]-u[1],u[5]-u[2]],y=1.1,d=Math.max(c[0],c[1]);h.centerOffset[0]=d*y/2*r.normalizedOffset[0],h.translation[2]+=c[2]*y/2*r.normalizedOffset[1];var v=b.length(c);h.centerOffset[2]=v*y/2*r.normalizedOffset[2]}return h},e.prototype.layerLabelsEnabled=function(){return this.layer.labelsVisible},e.prototype.getGraphics3DGraphics=function(){return this.graphicsCore.getGraphics3DGraphics()},e.prototype.getGraphics3DGraphicsKeys=function(){return this.graphicsCore.getGraphics3DGraphicsKeys()},e.prototype.showLabelsChange=function(){var e=this;if(this.layerView.suspended)return void(this.showLabelsChangeOnResume=!0);if(this.layerView.loadedGraphics){var t=this.layerLabelsEnabled();this.layerView.loadedGraphics.forEach(function(a){var r=e.graphicsCore.getGraphics3DGraphicById(a.uid);if(r){if(t&&0===r._labelGraphics.length){r=e.createLabelsForGraphic(a,r);for(var l=0;l<r._labelGraphics.length;l++){var i=r._labelGraphics[l];i.initialize(e.graphicsCore.labelStageLayer,e.layerView.view._stage)}}for(var l=0;l<r._labelGraphics.length;l++){var i=r._labelGraphics[l];i.setVisibilityFlag(p,t)}}}),this.layerView.view.labelManager.setDirty(),this.showLabelsChangeOnResume=!1}},e.prototype.elevationInfoChange=function(){this.labelClasses&&this.labelClasses.forEach(function(e){e.graphics3DSymbolLayer.layerPropertyChanged("elevationInfo",{})})},e}(),g={"above-center":{normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{normalizedOffset:[0,0,1],anchor:"center"},"center-left":{normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{normalizedOffset:[1,0,0],anchor:"left"}},y={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(var d in y){var v=y[d];f=g[d],v.forEach(function(e){g[e]=f})}return Object.freeze&&(Object.freeze(g),Object.keys(g).forEach(function(e){Object.freeze(g[e]),Object.freeze(g[e].normalizedOffset)})),u});