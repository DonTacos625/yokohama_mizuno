// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["require","exports","../../../core/tsSupport/declareExtendsHelper","../../../core/tsSupport/decorateHelper","../../../core/accessorSupport/decorators","../../../core/watchUtils","../../../core/promiseUtils","../../../core/Logger","../../../core/lang","dojo/_base/lang","dojox/color/_base","dojo/has","../../layers/LayerView","../../../Graphic","../../../symbols/Symbol3D","./i3s/I3SUtil","./i3s/I3SBinaryReader","./i3s/I3SProjectionUtil","./graphics/graphicUtils","./support/LayerViewUpdatingPercentage","../support/projectionUtils","../support/aaBoundingBox","../webgl-engine/Stage","../webgl-engine/lib/Layer","../webgl-engine/lib/Geometry","../webgl-engine/lib/GeometryData","../webgl-engine/lib/Object3D","../webgl-engine/lib/Texture","../webgl-engine/materials/Material","../webgl-engine/lib/Util","../webgl-engine/lib/base64Binary","../lib/glMatrix","../../../layers/IntegratedMeshLayer"],function(e,t,r,i,a,n,o,s,d,l,u,c,h,g,p,f,m,y,v,_,b,I,M,x,O,T,A,w,D,E,R,L,j){function P(e){return e.getMetadata()}function C(){return h}function F(e,t,r,i){var a,n=!1;t.encoding===f.DDS_ENCODING_STRING?a=w.DDS_ENCODING:n=!(N(e.width)&&N(e.height));var o=t.usedByEngineMats.some(function(e){return e.getParams().atlasRegions}),s=o||t.atlas,d=(r||!s)&&!n,l=s||!t.wrap,u=s&&d&&i;return{mipmap:d,wrapClamp:l,disableAnisotropy:u,encoding:a,noUnpackFlip:!0}}function S(e,t){for(var r=t.toLowerCase(),i=0,a=Object.keys(e);i<a.length;i++){var n=a[i];if(n.toLowerCase()===r)return e[n]}return null}var B=s.getLogger("esri.layers.SceneService"),V=E.assert,U=E.clamp,N=E.isPowerOfTwo,G=E.fallbackIfUndefined,z=E.objectEmpty,k=E.VertexAttrConstants,q=!1,X=!1,H=!0,Y=!1,J=!1,K=!1,Q=!1,W=[1,1,1,1],Z=M.ModelContentType,$=[.8,.8,.8],ee=[.5,.5,.5],te=64,re=9,ie=1,ae=null,ne=function(e){function t(){e.apply(this,arguments)}return r(t,e),t.prototype.initialize=function(){var e=this;f.checkSpatialReference(this.layer,this.view.spatialReference,this.view.viewingMode);var t=this.layer.version,r=!c("trident")||t.major>1||1===t.major&&t.minor>3;this.useCompressedTextures=this.view.has("s3tc")&&r,this._enableAtlasMipMaps=this.view.has("standardDerivatives"),this._disableAtlasAnisotropy=this._enableAtlasMipMaps&&!this.view.has("shaderTextureLOD"),this._initGraphicsController(),this.dbg=!1,this.maxGpuMemory=1e3,this.gpuMemoryEstimate=0,this.texMemoryEstimate=0,this.geoMemoryEstimate=0,this._stage=this.view._stage,this._matId2Meta={},this._texId2Meta={},this._requestedTexImageIds={},this._nodeId2Meta={},this._colorOverride=null;for(var i=new Uint8Array(256),a=0;a<i.length;a++)i[a]=255;this._whiteTexture=new w(i,"white",{width:8,height:8}),this._stage.add(M.ModelContentType.TEXTURE,this._whiteTexture),this._layerEventHandles=[n.init(this.layer,"renderer",function(t){return e._rendererChange(t)}),n.watch(this,"fullOpacity",function(t){return e._opacityChange(t)}),n.init(this.layer,"objectIdFilter",function(){return e._objectIdFilterChange()}),n.init(this.view,"clippingArea",function(){return e._clippingAreaChanged()})],this._addThisLayerToStage(),this.setVisibility(!this.suspended),this.debugNodeVis=X,this.debugLODVis=!1},t.prototype.destroy=function(){this._stage.remove(M.ModelContentType.TEXTURE,this._whiteTexture.getId()),this._removeThisLayerFromStage();var e=function(e){e.remove()};this._layerEventHandles.forEach(e),this._stage=null,null!=this._controller&&(this._controller.destroy(),this._controller=null),this._matId2Meta=null,this._texId2Meta=null,this._nodeId2Meta=null},t.prototype.canResume=function(){return this.inherited(arguments)&&(!this._controller||this._controller.rootNodeVisible)},t.prototype.isUpdating=function(){return this._controller&&this._controller.updating},t.prototype.memEstimateTextureAdded=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate+=t,this.texMemoryEstimate+=t},t.prototype.memEstimateTextureRemoved=function(e){var t=e.getEstimatedTexMemRequiredMB();this.gpuMemoryEstimate-=t,this.texMemoryEstimate-=t},t.prototype.memEstimateGeometryAdded=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate+=t,this.geoMemoryEstimate+=t},t.prototype.memEstimateGeometryRemoved=function(e){var t=e.estimateGpuMemoryUsage()/1e6;this.gpuMemoryEstimate-=t,this.geoMemoryEstimate-=t},t.prototype.isBundleAlreadyAddedToStage=function(e,t){var r=!1,i=!1;if(null!=this._nodeId2Meta[e.id]&&this._nodeId2Meta[e.id].engineObjectsPerBundle&&this._nodeId2Meta[e.id].engineObjectsPerBundle[t]){i=!0;for(var a=this._nodeId2Meta[e.id].engineObjectsPerBundle[t],n=0;n<a.length;n++){var o=a[n];if(r=o.isPartiallyHidden())break}}return{wasPartiallyHidden:r,alreadyLoaded:i}},t.prototype._initGraphicsController=function(){var e=this,t={addBundle:this._addBundle.bind(this),isBundleAlreadyAddedToStage:this.isBundleAlreadyAddedToStage.bind(this),isOverMemory:this.isOverMemory.bind(this),removeNodeData:this._removeNodeDataFromStage.bind(this),removeFeatures:this._removeFeatures.bind(this),getAddedFeatures:this._getAddedFeatures.bind(this),getAddedNodeIDs:this._getAddedNodeIDs.bind(this),areAllBundlesLoaded:this._areAllBundlesLoaded.bind(this),wholeNodeSwitchEnabled:!0},r={additionalStartNodeLoadingHandler:this._startNodeLoading.bind(this),additionalCancelNodeLoadingHandler:this.cancelNodeLoading.bind(this),getTexturePrefetchFunctions:function(){return{_calcDesiredTextureLOD:e._calcDesiredTextureLOD.bind(e),_imageIsPartOfTextureBundle:e._imageIsPartOfTextureBundle.bind(e),_matId2Meta:e._matId2Meta,_texId2Meta:e._texId2Meta,useCompressedTextures:function(){return e.useCompressedTextures}}},_nodeDebugVisualizer:this._nodeDebugVisualizer,setPolygonOffset:this._setPolygonOffset.bind(this),traversalOptions:{initDepthFirst:!0,neighborhood:!0,perLevelTraversal:!1,allowPartialOverlaps:!1},getLoadedAttributes:this.getLoadedAttributes.bind(this),setAttributeData:this.setAttributeData.bind(this)};this.layer.createGraphicsController({layerView:this,layerViewRequiredFunctions:t,layerViewOptionalFunctions:r}).then(function(t){t.watch("rootNodeVisible",function(){e.notifyChange("suspended")})})},t.prototype.setMaxGpuMemory=function(e){this.maxGpuMemory=e},t.prototype.setVisibility=function(e){if(this._stage&&this._engineLayer){var t=this._engineLayer.getId(),r=this._stage.getViewContent(),i=r.indexOf(t)>=0;if(!!e===i)return;var a=[t];null!=this._nodeDebugVisualizer&&a.push(this._nodeDebugVisualizer.engineLayer.getId()),e?this._stage.addToViewContent(a):this._stage.removeFromViewContent(a)}},t.prototype.getEngineLayer=function(){return this._engineLayer},t.prototype.getStats=function(){var e={nodesInIndex:0,knownFeatures:0,displayedFeatures:0,displayedGeometries:0,displayedComponents:0,geometryDataSize:0,activeMaterials:0};if(!this._controller)return e;for(var t in this._controller.nodeIndex)if(this._controller.nodeIndex.hasOwnProperty(t)){e.nodesInIndex++;var r=this._controller.nodeIndex[t];if(null==r.features)continue;for(var i=0;i<r.features.length;i++)e.knownFeatures++}return e.activeMaterials=Object.keys(this._matId2Meta).length,e},t.prototype._addThisLayerToStage=function(){var e=this._stage;this._initTexture=new w(null,"i3sInitTexture"),e.add(Z.TEXTURE,this._initTexture);var t=this.layer.id,r=new x(t,{},t);this._engineLayer=r,e.add(Z.LAYER,r),null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose(),X&&(this._nodeDebugVisualizer=f.makeNodeDebugVisualizer(e,this.view.renderCoordsHelper,t),window._nodeDebugVisualizer=this._nodeDebugVisualizer)},t.prototype._removeThisLayerFromStage=function(){if(this.cancelNodeLoading(),null!=this._engineLayer){var e=this._stage;if(e.remove(Z.TEXTURE,this._initTexture.getId()),null!=this._controller)for(var t in this._controller.nodeIndex)if(this._controller.nodeIndex.hasOwnProperty(t)){var r=this._controller.nodeIndex[t];this._removeNodeDataFromStage(r),delete this._controller.nodeIndex[t]}V(z(this._nodeId2Meta)),V(z(this._matId2Meta)),V(z(this._texId2Meta)),e.remove(Z.LAYER,this._engineLayer.getId()),null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.dispose(),this._nodeDebugVisualizer=void 0,this._matId2Meta={},this._texId2Meta={},this._requestedTexImageIds={},this._nodeId2Meta={},this._engineLayer=void 0,this.gpuMemoryEstimate=0}},t.prototype._startNodeLoading=function(){this._updateAllTextureLOD()},t.prototype.cancelNodeLoading=function(){null!=this._nodeDebugVisualizer&&this._nodeDebugVisualizer.clear(),this._requestedTexImageIds={}},t.prototype._isAllHidden=function(e){for(var t=this._nodeId2Meta[e.id].engineObjects,r=0;r<t.length;r++)if(!t[r].isAllHidden())return!1;return!0},t.prototype.getLoadedAttributes=function(e){var t=this._nodeId2Meta[e.id];return t&&1===t.engineObjects.length?P(t.engineObjects[0]).loadedAttributes:void 0},t.prototype.setAttributeData=function(e,t,r){var i=this._nodeId2Meta[e.id];if(i&&1===i.engineObjects.length){var a=i.engineObjects[0],n=P(a);n.loadedAttributes=t,n.attributeData=r,this._setObjectSymbology(a)}},t.prototype._createUnitTestData=function(e){var t=this.view.navigation.targetCamera,r=[],i={viewParams:{eye:t.eye,center:t.center,up:t.up,viewMatrix:t.viewMatrix,projectionMatrix:t.projectionMatrix,fovX:t.fovX,viewport:t.viewport,perPixelRatio:t.perPixelRatio},visibleObjects:r},a=e.getAll("objects");for(var n in a){var o=a[n];if(o.getParentLayer()===this._engineLayer){var s=P(o),d=s.features,l=s.i3sNode,u=d.map(function(e){return e.id});u.sort();var c={featureIDs:u,nodeId:l};i.visibleObjects.push(c)}}return console.debug(""+i.visibleObjects.length),JSON.stringify(i)},t.prototype.isOverMemory=function(){return this.gpuMemoryEstimate>this.maxGpuMemory?(B.warn("over memory: "+this.gpuMemoryEstimate+" tex "+this.texMemoryEstimate+" geom "+this.geoMemoryEstimate),!0):!1},t.prototype._getAddedFeatures=function(e){var t=this._nodeId2Meta[e];if(null==t)return null;for(var r=[],i=this._nodeId2Meta[e].engineObjects,a=0;a<i.length;a++){var n=i[a];r=r.concat(P(n).features)}return r},t.prototype._getAddedNodeIDs=function(){return Object.keys(this._nodeId2Meta)},t.prototype._calcEngineMaterialTransparencyParams=function(e,t,r){var i=this.fullOpacity,a=1-U(G(t.transparency,0),0,1),n=i*a,o=1>n||e&&d.endsWith(e.channels,"a")||t.useVertexColorAlpha===!0||r;return{opacity:n,transparent:o}},t.prototype._calcEngineMaterialDoubleSidedParams=function(e){return null!=e.doubleSided?e.doubleSided:!0},t.prototype._calcEngineMaterialCullFaceParams=function(e){return e.cullFace?e.cullFace:null!=e.doubleSided?e.doubleSided?"none":"back":"none"},t.prototype._createEngineMaterial=function(e,t,r,i,a,n){var o,s;null!=e&&(s=this._texId2Meta[t],o=s&&s.engineTex?s.engineTex.getId():this._initTexture.getId());var d,u,c=r.params,h=G(c.diffuse,$);null!=e&&(u=f.getAppropriateTextureEncoding(e.encoding,this.useCompressedTextures),d=u>-1?e.encoding[u]:e.encoding),"standard"!==r.type&&B.warn("Unknown material type '"+r.type+"', must be 'standard'"),void 0===c.reflectivity&&B.warn("Material parameter 'reflectivity' is missing.");var g=this.layer instanceof j,p={ambient:this._colorOverride||h,diffuse:this._colorOverride||h,specular:G(c.specular,ee),shininess:G(c.shininess,te),atlasRegions:c.vertexRegions,textureId:o&&this._colorOverride?this._whiteTexture.getId():o,vertexColors:!0,flipV:!1,doubleSided:this._calcEngineMaterialDoubleSidedParams(c),cullFace:this._calcEngineMaterialCullFaceParams(c),writeStencil:g};if(!g){var m=this._calcEngineMaterialTransparencyParams(e,c);l.mixin(p,m)}var y=new D(p,i);if(y.metadata={i3sMatId:i,i3sTexId:t,i3sTex:e,i3sMatParams:c},null!=e){s?s.usedByEngineMats.push(y):(s={id:t,featureMBS:{},usedByEngineMats:[y],images:e.images,encoding:d,encodingIdx:u,atlas:e.atlas===!0,wrap:"none"!==e.wrap[0]||"none"!==e.wrap[1]},this._texId2Meta[t]=s);for(var v=0;v<a.length;v++){var _=a[v];s.featureMBS[_.id]=_.engineMBS}if(void 0!==n[t]){if(null==s.engineTex){var b=n[t],I=b.data,M=F(I,s,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);s.engineTex=new w(I,s.id,M),this._stage.add(Z.TEXTURE,s.engineTex),s.desiredLOD=n[t].desiredLOD,s.curLOD=s.desiredLOD,this.memEstimateTextureAdded(s.engineTex)}for(var x=s.engineTex.getId(),O=0;O<s.usedByEngineMats.length;O++){var T=s.usedByEngineMats[O];null==this._colorOverride&&T.setParameterValues({textureId:x}),T.metadata.originalTextureId=x}n[t].createdTextureForDomImage(),delete n[t]}else this._updateTextureLOD(s)}return this._matId2Meta[i]||(this._matId2Meta[i]={}),this._matId2Meta[i][t]={engineMat:y,refCount:1},Y&&console.debug("new mat "+y.getId()),y},t.prototype._createVertexAndIndexArrays=function(e,t,r){var i,a=!0,n=e.params.vertexAttributes,o={};for(var s in n)if(n.hasOwnProperty(s)){if("classification"===s)continue;var d=n[s];i=m.valueType2TypedArrayClassMap[d.valueType],V(null!=i,"unsupported vertex attribute value type: "+d.valueType),o[s]={data:new i(t,d.byteOffset,d.count*d.valuesPerElement),size:d.valuesPerElement}}if(a&&null==o[k.COLOR]){i=m.valueType2TypedArrayClassMap.UInt8,o[k.COLOR]={data:new i(4*n.position.count),size:4};for(var l=0;l<o[k.COLOR].data.length;l++)o[k.COLOR].data[l]=l%3===0?255:0}var u=!1;null==o[k.NORMAL]&&(u=!0,i=m.valueType2TypedArrayClassMap.Float32,o[k.NORMAL]={data:new i(3*n.position.count),size:3});var c,h=[],g=e.params.faces;if(null!=g&&"PerAttributeArray"!==e.params.topology){var p={};for(name in g)if(g.hasOwnProperty(name)){var f=g[name];V(f.count%3===0),V(f.count===g.position.count),V("UInt32"===f.valueType),p[name]=f.byteOffset}var y=e.params.components.length;c=new Array(y);for(var v=g.position.componentIndices||[0],_=0;y>_;_++){var b=e.params.components[_],I=y-1>_?v[_+1]-v[_]:g.position.count-v[_],M={type:"triangle",positionKey:"position",indices:{},componentRange:[v[_],v[_]+I]};for(name in g)g.hasOwnProperty(name)&&(M.indices[name]=new Uint32Array(t,p[name],I),p[name]+=4*I);if(a&&null==M.indices[k.COLOR]){M.indices[k.COLOR]=new Uint32Array(I);for(var l=0;I>l;l++)M.indices[k.COLOR][l]=l}if(u&&null==M.indices[k.NORMAL]){M.indices[k.NORMAL]=new Uint32Array(I);for(var l=0;I>l;l++)M.indices[k.NORMAL][l]=l}c[_]=M;var x=b.textureID||"none",O=void 0;if("none"!==x&&(O=r.textureDefinitions[x],V(void 0!==O,"geometry wants unknown texture "+x)),O&&O.atlas===!0&&null!=O.regions){V(O.regions.length>0,"texture marked as atlas carries no region definition");var T=O.regions[b.regionID].subimageRegion,A=[65536*T[0],65536*(T[2]-T[0]),65536*(1-T[3]),65536*(T[3]-T[1])];h=h.concat(A);for(var w=new Uint32Array(I),D=0;I>D;D++)w[D]=h.length/4-1;M.indices[k.REGION]=w}}}else{var M={type:"triangle",positionKey:"position",indices:{}},E=o.position.data.length/o.position.size;if(E>ie||null==ae){for(;E>ie;)ie*=2;ae=new Uint32Array(ie);for(var l=0;ie>l;l++)ae[l]=l}var R=new Uint32Array(ae.buffer,0,E);for(var L in o)M.indices[L]=R;var j=M.indices[M.positionKey];M.componentRange=[0,null!=j?j.length-1:0],c=[M]}if(h.length>0){var P=new Uint16Array(h);o[k.REGION]={data:P,size:4}}return{indexArrays:c,vertexArrays:o}},t.prototype._createEngineMats=function(e,t,r,i,a){for(var n=e.params.components.length,o=new Array(n),s=0;n>s;s++){var d=e.params.components[s],l=d.materialID,u=r.materialDefinitions[l];null!=u.href&&(u=i[u.hrefConcat].materialDefinitions[l]),V(void 0!==u,"geometry wants unknown material "+l);var c=d.textureID||"none",h=void 0;"none"!==c&&((null==r.textureDefinitions||null==r.textureDefinitions[c])&&B.warn("textureDefinitions missing in shared resource"),h=r.textureDefinitions[c]);var g=void 0;if(this._matId2Meta[l]&&this._matId2Meta[l][c]){var p=this._matId2Meta[l][c];g=p.engineMat,p.refCount++,Y&&console.debug("reused mat "+g.getId()+", increased refcount "+p.refCount)}else g=this._createEngineMaterial(h,c,u,l,t,a);o[s]=g}return o},t.prototype._areAllBundlesLoaded=function(e,t){if(null==this._nodeId2Meta[e.id]||null==this._nodeId2Meta[e.id].engineObjectsPerBundle)return!1;for(var r=0;r<e.featureData.length;r++){if(null==this._nodeId2Meta[e.id].engineObjectsPerBundle[r])return!1;if(!t)for(var i=this._nodeId2Meta[e.id].engineObjectsPerBundle[r],a=0;a<i.length;a++)if(i[a].isPartiallyHidden())return!1}return!0},t.prototype._getObjectIdField=function(){return this.layer.objectIdField||"OBJECTID"},t.prototype._findGraphic=function(e){for(var t=S(e.attributes,this._getObjectIdField()),r=0,i=Object.keys(this._nodeId2Meta);r<i.length;r++)for(var a=i[r],n=this._nodeId2Meta[a].engineObjects,o=0;o<n.length;o++){var s=n[o],d=P(s),l=d.featureIds.indexOf(t);if(-1!==l)return{node:this._controller.nodeIndex[a],nodeId:a,bundleNr:o,index:l}}return null},t.prototype.whenGraphicBounds=function(e){var t=this._findGraphic(e);if(null!=t){for(var r=this._nodeId2Meta[t.nodeId].engineObjects[t.bundleNr],i=P(r),a=i.faceRanges[t.index],n=r.geometries[0].calculateBoundingInfo(0,a),s=n.bbMin,d=n.bbMax,l=[],u=0;8>u;++u){var c=[1&u?s[0]:d[0],2&u?s[1]:d[1],4&u?s[2]:d[2]];L.mat4d.multiplyVec3(r.objectTransformation,c),l[3*u]=c[0],l[3*u+1]=c[1],l[3*u+2]=c[2]}if(b.bufferToBuffer(l,this.view.renderSpatialReference,0,l,this.view.spatialReference,0,8)){for(var h=I.create(I.NEGATIVE_INFINITY),g=0;g<l.length;g+=3)for(var p=0;3>p;p++)h[p]=Math.min(h[p],l[g+p]),h[p+3]=Math.max(h[p+3],l[g+p]);return o.resolve(h)}}return o.reject()},t.prototype.whenGraphicAttributes=function(e,t){var r=this,i=S(e.attributes,this._getObjectIdField()),a=function(){return r._findGraphic(e)};return f.whenGraphicAttributes(this.layer,e,i,t,a)},t.prototype.getGraphicsFromStageObject=function(e,t){if(this.layer instanceof j)return o.reject();var r=P(e),i=e.getFaceRangeIndexFromTriangleNr(t);if(null!=i&&null!=r.graphics&&null!=r.graphics[0].attributes)return o.resolve(r.graphics[i]);if(null!=i&&null!=r.featureIds&&null!=r.featureIds[i]){var a={};a[this._getObjectIdField()]=r.featureIds[i];for(var n=0,s=Object.keys(r.attributeData);n<s.length;n++){var d=s[n];a[d]=r.attributeData[d][i]}var l=new g(null,null,a);return l.layer=this.layer,o.resolve(l)}return o.reject()},t.prototype._addBundle=function(e,t,r,i,a,n,o){if(this.debugNodeVis===!0&&null!=this._nodeDebugVisualizer){var s="grey";switch(e.level){case 1:s="red";break;case 2:s="green";break;case 3:s="blue";break;case 4:s="yellow";break;case 5:s="magenta";break;case 6:s="brown"}this._nodeDebugVisualizer.show(e,this._controller.crsIndex,s)}var d=this._stage,l={};l[Z.OBJECT]={},l[Z.GEOMETRY]={},l[Z.MATERIAL]={},l[Z.TEXTURE]={};var u=this._engineLayer,c=u.getId(),h=i[e.sharedResource.hrefConcat];if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle&&this._nodeId2Meta[e.id].engineObjectsPerBundle[o])return this._applyFilters(e),void(null!=a&&a.done());if(!this.isOverMemory()){if(null==this._nodeId2Meta[e.id]&&(this._nodeId2Meta[e.id]={engineObjects:[],engineObjectsPerBundle:[]}),this._nodeId2Meta[e.id].engineObjectsPerBundle[o]=[],K&&null==this.allUnitTestData&&(this.allUnitTestData={}),null==t)return void(null!=a&&a.done());for(var p=0;p<t.length;p++){var m=t[p].geometries,v=t[p].features,_=t[p].featureDataAttributes,b=i[e.geometryData[o].hrefConcat];V(b instanceof ArrayBuffer,"I3S: geometry data is not an ArrayBuffer"),null==b._isReprojected&&(b._isReprojected={});for(var I=e.id+"|"+v[0].id.toString(),M=[],x=[],w=[],D=void 0,E=function(t){var r=m[t];Y&&console.debug("adding geometry "+t);var a=j._createVertexAndIndexArrays(r,b,h);if(H&&0===a.indexArrays.length)return"continue";var o=j._createEngineMats(r,v,h,i,n),s=void 0;K&&(s={},s.inputPositions=R.encode(new Uint8Array(a.vertexArrays.position.data.buffer)));var d=b._isReprojected[r.id],u=j._controller.crsIndex,c=j.view.renderSpatialReference,g=j._controller.isMeshPyramid?y.ReprojectionTypes.PER_VERTEX:y.ReprojectionTypes.BOUNDINGBOX;if(D=y.reprojectPoints(g,a.vertexArrays.position.data,e.mbs,d,u,j._controller.crsVertex,c),b._isReprojected[r.id]=!0,j._controller.isMeshPyramid){var p={normals:a.vertexArrays.normal.data,positions:a.vertexArrays.position.data,normalInd:a.indexArrays[0].indices.normal,positionInd:a.indexArrays[0].indices.position},_=j.layer.normalReferenceFrame||"none",A=function(t,r){var i=e.mbs;y.reprojectNormalsPerVertex(t,i,u,r,c)};f.processNormals(p,_,A)}K&&(s.perVertexReprojectedPositions=R.encode(new Uint8Array(a.vertexArrays.position.data.buffer)),s.matrices=D,s.mbs=e.mbs,s.crsIndex=j._controller.crsIndex,s.crsVertex=j._controller.crsVertex,s.crsEngine=j.view.renderSpatialReference);var E=D.localTrafo;null!=r.transformation&&(E=L.mat4d.create(r.transformation),L.mat4d.multiply(D.localTrafo,E,E));for(var P=0;P<o.length;P++){var C=o[P];l[Z.MATERIAL][C.getId()]=C}var F=new O(new T(a.indexArrays,a.vertexArrays),I+"_"+t);j.memEstimateGeometryAdded(F.getData()),l[Z.GEOMETRY][F.getId()]=F,M[t]=F,x[t]=E,w[t]=o,K&&(j.allUnitTestData[F.getId()]=s)},j=this,C=0;C<m.length;++C){E(C)}for(var F=[],S=0;S<v.length;S++){var B=_[S],U=new g(void 0,void 0,B);U.set("layer",this.layer),F.push(U)}var N={graphics:F,i3sNode:e.id,ceLayer:c,features:v,faceRanges:t[p].faceRanges,featureIds:t[p].featureIds,attributeData:r?r.attributeData:null,loadedAttributes:r?r.loadedAttributes:null,layerId:this.layer.id},G=new A({idHint:e.id,name:I,geometries:M,materials:w,transformations:x,castShadow:!0,metadata:N}),z=L.mat4d.create();L.mat4d.identity(z),L.mat4d.multiply(z,D.globalTrafo,z),G.setObjectTransformation(z),this._nodeId2Meta[e.id].engineObjectsPerBundle[o].push(G),this._nodeId2Meta[e.id].engineObjects.push(G),l[Z.OBJECT][G.getId()]=G,this._setObjectSymbology(G),this._applyFilters(e)}if(J){for(var v="",k=this._nodeId2Meta[e.id].engineObjectsPerBundle[o],X=0;X<k.length;X++)for(var Q=P(k[X]).features,S=0;S<Q.length;S++)v+="f "+Q[S].id+" rf "+Q[S].rootFeature+", ";console.debug("_addNodeDataToStage node "+e.id+" bundle "+o+" features "+v)}if(q){var W=function(e){return Object.keys(e).length};console.log("objs: "+W(l[Z.OBJECT])+" geoms: "+W(l[Z.GEOMETRY])+" mats: "+W(l[Z.MATERIAL])+" texts: "+W(l[Z.TEXTURE]))}d.beginMod();var $=l[Z.OBJECT];for(var ee in $)$.hasOwnProperty(ee)&&u.addObject($[ee]);for(var te in l)if(l.hasOwnProperty(te)){var re=l[te];for(name in re)if(re.hasOwnProperty(name)){if(null!=d.get(te,name))continue;d.add(te,re[name])}}d.endMod(),null!=a&&a.done()}},t.prototype._clippingAreaChanged=function(){var e=this,t=[];if(b.extentToBoundingBox(this.view.clippingArea,t,this.view.renderSpatialReference)?this._clippingArea=t:this._clippingArea=null,this._updateFilters(),this._controller){var r=this._controller.nodeIndex;r&&Object.keys(this._nodeId2Meta).forEach(function(t){return e._applyFilters(r[t])}),this._controller.updateClippingArea(this.view.clippingArea)}},t.prototype._objectIdFilterChange=function(){var e=this;if(this._updateFilters(),this._controller){var t=this._controller.nodeIndex;t&&Object.keys(this._nodeId2Meta).forEach(function(r){return e._applyFilters(t[r])})}},t.prototype._updateFilters=function(){var e=this,t=[];if(this.layer.objectIdFilter){var r=new Float64Array(this.layer.objectIdFilter.ids),i="include"===this.layer.objectIdFilter.method;r.sort(),t.push(function(t,a){return e._objectIdFilter(r,i,a)})}this._clippingArea&&t.push(function(t,r){return e._boundingboxFilter(t,e._clippingArea,r)}),this._filters=t},t.prototype._objectIdFilter=function(e,t,r){for(var i=0;i<r.length;){var a=f.binaryIndexOf(e,r[i])>=0;a===t?i++:r.splice(i,1)}},t.prototype._boundingboxFilter=function(e,t,r){var i=[0,0,0,0];b.mbsToMbs(e.mbs,this._controller.crsIndex,i,this.view.renderSpatialReference);var a=null!=t?f.intersectBoundingBoxWithMbs(t,i):2;if(2!==a)for(var n=0,o=this._nodeId2Meta[e.id].engineObjects,s=0;s<o.length;s++){var d=o[s],l=P(d).featureIds;if(0!==a){var u=d.getObjectTransformation(),c=d.getGeometryRecords()[0].transformation;if(L.mat4d.multiply(u,c),0===u[1]&&0===u[2]&&0===u[3]&&0===u[4]&&0===u[6]&&0===u[7]&&0===u[8]&&0===u[9]&&0===u[11]&&1===u[15])for(var h=(t[0]-u[12])/u[0],g=(t[1]-u[13])/u[5],p=(t[2]-u[14])/u[10],m=(t[3]-u[12])/u[0],y=(t[4]-u[13])/u[5],v=(t[5]-u[14])/u[10],_=d.getGeometryRecords()[0].geometry.getData(),I=_.getFaces()[0].indices.position,M=_.getVertexAttr().position.data,x=P(d).faceRanges,O=void 0,T=void 0,A=void 0,w=void 0,D=void 0,E=void 0,R=0;R<x.length&&n<r.length;R+=1)if(r[n]===l[R]){var j=x[R],C=j[0],F=j[1];O=T=A=Number.MAX_VALUE,w=D=E=-Number.MAX_VALUE;for(var S=C;F>=S;S+=1)for(var B=0;3>B;B+=1){var V=3*I[3*S+B],U=M[V],N=M[V+1],G=M[V+2];O=Math.min(U,O),T=Math.min(N,T),A=Math.min(G,A),w=Math.max(U,w),D=Math.max(N,D),E=Math.max(G,E)}var z=O>m||h>w||T>y||g>D||A>v||p>E;z?r.splice(n,1):n++}}else{for(var k=0,R=0;R<l.length&&n+k<r.length;R+=1)r[n+k]===l[R]&&k++;r.splice(n,k)}}},t.prototype._applyFilters=function(e){if(this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){for(var t=this._nodeId2Meta[e.id].engineObjects,r=0;r<t.length;r++)t[r].unhideAllFaceRange();if(0!==this._filters.length){for(var i=[],r=0;r<t.length;r++){var a=t[r];i=i.concat(P(a).featureIds)}for(var n=i.length,o=0;o<this._filters.length;o++)this._filters[o](e,i);if(i.length!==n)for(var s=0,r=0;r<t.length;r++){for(var a=t[r],d=[],l=P(a).faceRanges,u=P(a).featureIds,c=0;c<u.length;c+=1){var h=u[c],g=l[c];s>=i.length||i[s]!==h?d.push(g):s++}d.length>0&&(Q?(this._setObjectSymbology(a),a.setFacerangeColors(d.map(function(e){return{faceRanges:e,color:[0,0,0,0]}}),"replace")):a.hideFaceRange(a.getGeometryRecords()[0],d))}}}},t.prototype._hideFeatures=function(e,t){for(var r=this._nodeId2Meta[e.id].engineObjects,i=0;i<r.length;i++){for(var a=r[i],n=[],o=P(a).features,s=a.getMetadata().faceRanges,d=0;d<t.length;d++)for(var l=t[d],u=0;u<o.length;u++)l===o[u].id&&(null!=s&&1===a.getGeometryRecords().length?n.push(s[u]):a.hideAllFaceRanges());n.length>0&&a.hideFaceRange(a.getGeometryRecords()[0],n)}},t.prototype._removeFeatures=function(e,t){null!=this._nodeId2Meta[e.id]&&(this._hideFeatures(e,t),this._isAllHidden(e)===!0&&(J&&console.debug("all hidden for node "+e.id+". removing."),this._removeNodeDataFromStage(e)))},t.prototype._removeNodeDataFromStage=function(e){if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjects){for(var t=this._stage,r=this._engineLayer,i=this._nodeId2Meta[e.id].engineObjects,a=0;a<i.length;++a){var n=i[a];r.removeObject(n);for(var o=n.getGeometryRecords(),s=0;s<o.length;s++){var d=o[s];this.memEstimateGeometryRemoved(d.geometry.getData()),t.remove(Z.GEOMETRY,d.geometry.getId());for(var l=0;l<d.materials.length;l++){var u=d.materials[l],c=u.getId(),h=u.metadata.i3sMatId,g=u.metadata.i3sTexId||"none",p=this._matId2Meta[h][g];V(p.refCount>0),p.refCount--,Y&&console.debug("decreased refcount material "+c+" "+("geometry "+s+", count "+p.refCount)),0===p.refCount&&this._removeMaterial(c,g,h,u,t)}}t.remove(Z.OBJECT,n.getId())}delete this._nodeId2Meta[e.id]}},t.prototype._removeMaterial=function(e,t,r,i,a){if(a.remove(Z.MATERIAL,e),"none"!==t){var n=this._texId2Meta[t],o=n.usedByEngineMats,s=o.indexOf(i);if(V(s>-1),o[s]=o[o.length-1],o.pop(),o.length<1){var d=n.engineTex;d&&d!==this._initTexture&&(this.memEstimateTextureRemoved(d),a.remove(Z.TEXTURE,n.engineTex.getId())),n.engineTex=void 0,n.desiredLOD=-1,n.curLOD=-1,delete this._texId2Meta[t]}}delete this._matId2Meta[r][t],z(this._matId2Meta[r])&&delete this._matId2Meta[r]},t.prototype._updateAllTextureLOD=function(){for(var e in this._texId2Meta)if(this._texId2Meta.hasOwnProperty(e)){var t=this._texId2Meta[e];this._updateTextureLOD(t)}},t.prototype._calcDesiredTextureLOD=function(e,t){for(var r,i=0,a=0,n=Object.keys(e);a<n.length;a++){var o=n[a],s=e[o],d=L.vec3.dist(s,this._controller.camPos),l=2*s[3],u=l/d*this._controller.screenSizeFactor;u>i&&(i=u)}for(i/=re,r=t.length-1;r>0&&t[r].size<i;)r--;return r},t.prototype._updateTextureLOD=function(e){var t=this;e.desiredLOD=this._calcDesiredTextureLOD(e.featureMBS,e.images);var r=e.curLOD!==e.desiredLOD&&(e.curLOD<0||!e.curLOD||0===e.desiredLOD||e.desiredLOD>e.curLOD||e.desiredLOD<e.curLOD-1);if(r){if(0===e.images.length)return;var i=e.images[e.desiredLOD],a=e.encodingIdx>-1?i.hrefConcat[e.encodingIdx]:i.hrefConcat;if(!this._requestedTexImageIds[i.id]){var n={metadata:{texMeta:e,image:i}};this._requestedTexImageIds[i.id]=!0,this._imageIsPartOfTextureBundle(i)?this._controller.streamDataSupplier.request(a,"binary",n).then(this._extractTextureImageFromBlob.bind(this)):this._controller.streamDataSupplier.request(a,"image",n).then(function(e,r,i,a){t._textureImageLoaded(e,r,a.image,a.texMeta)})}}if(e.engineTex||(e.engineTex=this._initTexture,e.curLOD=-1),this.debugLODVis)for(var o=u.fromHsv(e.desiredLOD/e.images.length*270,100,100).toRgb().map(function(e){return e/255}),s=0;s<e.usedByEngineMats.length;s++){var d=e.usedByEngineMats[s],l={ambient:o,diffuse:o};d.setParameterValues(l)}},t.prototype._extractTextureImageFromBlob=function(e,t,r,i){var a=i.texMeta;if(a.desiredLOD<0||i.image.size>a.images[a.desiredLOD].size)return void delete this._requestedTexImageIds[i.image.id];var n=this;V("binary"===r);var o="";try{var s=0,d=0;a.encodingIdx>-1?(s=i.image.byteOffset[a.encodingIdx],d=i.image.length[a.encodingIdx]):(s=i.image.byteOffset,d=i.image.length);var l=new Uint8Array(t,s,d),u=new Blob([l],{type:a.encoding});o=window.URL.createObjectURL(u)}catch(c){o="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAIElEQVQ4T2P8zyD6n4ECwDhqAMNoGDCMhgEwDw2DdAAAdzkhQdS8dl8AAAAASUVORK5CYII=",B.error("error loading texture "+e+" "+c)}var h=new Image;h.onerror=function(){window.URL.revokeObjectURL(o),h.src="",h.onerror=void 0,h.onload=void 0},h.onload=function(){n._controller.queueAnimationFrameFunctionCall(n._textureImageLoaded,n,[e,h,i.image,i.texMeta,o],void 0,1),window.URL.revokeObjectURL(o),h.src="",h.onerror=void 0,h.onload=void 0},h.src=o},t.prototype._textureImageLoaded=function(e,t,r,i){if(delete this._requestedTexImageIds[r.id],!(i.desiredLOD<0)){var a=i.images[i.desiredLOD],n=i.images[i.curLOD];if((!this.isOverMemory()||!(null==n||r.size>n.size))&&(!n||r.size>n.size&&r.size<=a.size||r.size<n.size&&r.size>=a.size)){var o=i.engineTex;o&&o!==this._initTexture&&(this.memEstimateTextureRemoved(o),this._stage.remove(Z.TEXTURE,i.engineTex.getId()));var s=F(t,i,this._enableAtlasMipMaps,this._disableAtlasAnisotropy);i.engineTex=new w(t,i.id,s),this._stage.add(Z.TEXTURE,i.engineTex),i.curLOD=i.desiredLOD,this.memEstimateTextureAdded(i.engineTex);for(var d=i.engineTex.getId(),l=0;l<i.usedByEngineMats.length;l++){var u=i.usedByEngineMats[l];null==this._colorOverride&&u.setParameterValues({textureId:d}),u.metadata.originalTextureId=d}if(r!==a&&(i.curLOD=i.images.indexOf(r),V(i.curLOD>-1),!this._requestedTexImageIds[a.id])){var c={metadata:{texMeta:i,image:a}};this._requestedTexImageIds[a.id]=!0,this._controller.streamDataSupplier.request(a.hrefConcat,"binary",c).then(this._extractTextureImageFromBlob.bind(this))}}}},t.prototype._imageIsPartOfTextureBundle=function(e){return!this._controller.isMeshPyramid},t.prototype._setPolygonOffset=function(e,t){if(null!=this._nodeId2Meta[e.id]&&null!=this._nodeId2Meta[e.id].engineObjectsPerBundle)for(var r={polygonOffset:t},i=0;i<this._nodeId2Meta[e.id].engineObjectsPerBundle.length;i++)for(var a=this._nodeId2Meta[e.id].engineObjectsPerBundle[i],n=0;n<a.length;n++)for(var o=a[n].getGeometryRecords(),s=0;s<o.length;s++)for(var d=o[s].materials,l=0;l<d.length;l++)d[l].setParameterValues(r)},t.prototype._rendererChange=function(e){this._currentRenderer=e,e&&(e.colorInfo||e.sizeInfo)&&B.warn("renderer.colorInfo and renderer.sizeInfo are not supported for Scene Services. Use visualVariables instead.")},t.prototype._getRenderer=function(e){if(!e||e.symbol)return null;var t=this._rndForScale||this._currentRenderer;return t},t.prototype._getSymbol=function(e){if(e.symbol)return e.symbol;var t=this._getRenderer(e);return t&&t.getSymbol(e)},t.prototype._getRenderingInfo=function(e){var t=this._getRenderer(e),r=this._getSymbol(e);if(!(r&&r instanceof p))return null;var i,a,n={symbol:r};if(t&&t.visualVariables)for(var o=t.getVisualVariableValues(e),s=0;s<o.length;s++){var d=o[s],l=d.variable.type;"color"===l?i=d.value:"opacity"===l&&(a=d.value)}return i&&(n.color=[i.r/255,i.g/255,i.b/255]),null!=a?n.opacity=a:i&&null!=i.a&&(n.opacity=i.a),n},t.prototype._getSymbolFillColor=function(e){
for(var t=e.symbolLayers,r=0;r<t.length;r++){var i=t.getItemAt(r);if("Fill"===i.type&&i.material&&i.material.color){var a=i.material.color;return[a.r/255,a.g/255,a.b/255,a.a]}}},t.prototype._setObjectSymbology=function(e){if(!(this.layer instanceof j)){for(var t=P(e),r=[],i=t.graphics,a=!1,n=i.length,o=t.faceRanges?t.faceRanges.length:n,s={attributes:{}},d=function(e){o===n&&null==t.attributeData?s=i[e]:Object.keys(t.attributeData).forEach(function(r){s.attributes[r]=t.attributeData[r][e]});var d=l._getRenderingInfo(s),u=null!=t.faceRanges?t.faceRanges[e]:null;if(d){var c=d.color,h=d.opacity;if(null==c||null==h){var g=l._getSymbolFillColor(d.symbol);c=v.overrideColor(c,h,g,g&&g[3],W)}else c=v.overrideColor(c,h,null,null,W);c[3]<1&&(a=!0),r.push({faceRanges:u,color:c})}else r.push({faceRanges:u,color:void 0})},l=this,u=0;o>u;u++)d(u);this.layer.cachedDrawingInfo.color?e.setFacerangeColors(r,"replace"):e.setFacerangeColors(r,"blend");for(var c=e.getGeometryRecords(),h=0;h<c.length;h++)for(var g=c[h],p=0;p<g.materials.length;p++){var f=g.materials[p],m=f.getParams().transparent,y=f.getParams().opacity;f.metadata.symbolIsTransparent=a;var _=this._calcEngineMaterialTransparencyParams(f.metadata.i3sTex,f.metadata.i3sMatParams,f.metadata.symbolIsTransparent);(m!==_.transparent||y!==_.opacity)&&f.setParameterValues({transparent:_.transparent,opacity:_.opacity})}}},t.prototype._opacityChange=function(e){for(var t in this._matId2Meta)for(var r in this._matId2Meta[t]){var i=this._matId2Meta[t][r].engineMat,a=i.getParams().transparent,n=i.getParams().opacity,o=this._calcEngineMaterialTransparencyParams(i.metadata.i3sTex,i.metadata.i3sMatParams,i.metadata.symbolIsTransparent);(a!==o.transparent||n!==o.opacity)&&i.setParameterValues({transparent:o.transparent,opacity:o.opacity})}},i([a.property()],t.prototype,"layer",void 0),i([a.property()],t.prototype,"view",void 0),i([a.property()],t.prototype,"_controller",void 0),i([a.property({dependsOn:["_controller.updating"]})],t.prototype,"updating",void 0),i([a.property({readOnly:!0,aliasOf:"_controller.updatingPercentage"})],t.prototype,"updatingPercentageValue",void 0),t=i([a.subclass("esri.views.3d.layers.SceneLayerView3D")],t)}(a.declared(C(),_));return ne});