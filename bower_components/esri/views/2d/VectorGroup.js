// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["../../core/declare","dojo/_base/lang","dojox/gfx","dojox/gfx/matrix","./math/common","./math/mat2d","./math/vec2","./Projector","./viewpointUtils","../../geometry/Extent","../../geometry/Polygon","../../geometry/support/webMercatorUtils","../../symbols/SimpleMarkerSymbol","../../symbols/support/gfxUtils","../../core/screenUtils","../../core/Accessoire"],function(t,e,r,i,s,a,n,o,l,h,c,p,u,f,d,y){function m(){return"vecgp"+g++}var g=0,_=function(t){return{xx:t[0],yx:t[1],xy:t[2],yy:t[3],dx:t[4],dy:t[5]}},v=-1!==r.renderer.toLowerCase().indexOf("svg"),x={type:"simple-fill-symbol",style:"square",size:15,xoffset:0,yoffset:0,angle:0},S={"picture-marker-symbol":"image","picture-fill-symbol":"path","simple-fill-symbol":"path","simple-line-symbol":"path","cartographic-line-symbol":"path","text-symbol":"text"},w={square:1,cross:1,x:1,diamond:1,target:1},b=t(y,{declaredClass:"esri.views.2d.VectorGroup",constructor:function(t){this.id=m(),this._transform=a.create(),this._projector=new o,this.vectors=[],this.adding=[],this.removing=[],this.updating=[]},applyState:function(t){if(this.transform){var e=a.invert(this._transform,this.transform);a.multiply(e,t.transformNoRotation,e),this.surface.setTransform(_(e))}},requestVectorDraw:function(t){},addVector:function(t){return this.addVectorAt(t,this.vectors.length)},addVectorAt:function(t,e){return e=Math.min(this.vectors.length,e),this.vectors.splice(e,0,t),t.set({parent:this,view:this.view}),t},removeVector:function(t){if(!this.vectors)return t;var e=this.vectors.indexOf(t);return e>-1&&(t=this.vectors.splice(e,1)[0],t.set({parent:null,view:null}),this._removeShape(t)),t},draw:function(t){this.transform||this._updateTransform();var e=this.view,r=e.state;if(r.width-r.worldScreenWidth>0){var i=r.size.concat();i[0]=Math.min(i[0],Math.round(r.worldScreenWidth)),this._viewExtent=l.getExtent(new h,r.viewpoint,i)}else this._viewExtent=e.extent;e.spatialReference.isWebMercator?this._viewGeoExtent=p.webMercatorToGeographic(this._viewExtent,!0):this._viewGeoExtent=null,this.surface.openBatch();var s,a,n;for(a=0,n=this.vectors.length;n>a;a++)s=this.vectors[a],s&&this.drawVector(s,t);this.surface.closeBatch()},drawVector:function(t,e){var r,i,s,a=t.graphic,n=t.extent,o=t.shape,l=!0,h=t.geometry,c=t.projectedGeometry;if(a.visible&&n&&(r=this._getScreenOffsets(this.view,n))&&(i=l?t.symbol:x)){if(t.resolution===this.resolution&&t.rotation===this.rotation&&t.offsets&&this._compareOffsets(t.offsets,r)?s=!0:t.offsets=r,!o||e||!s){var p=h.type;if(t.resolution=this.resolution,t.rotation=this.rotation,"point"===p)this._isInvalidShape(i,o)&&this._removeShape(t),o=t.shape=this._drawPoint(this.surface,c||h,i,t,r),l&&this._stylePoint(t,i);else if("multipoint"===p)o=t.shape=this._drawMarkers(this.surface,c||h,i,t,r),l&&this._styleMarkers(t,i);else{var u=l?i:null;u&&(this._isInvalidShape(u,o)&&this._removeShape(t,!1),o=t.shape=this._drawShape(this.surface,c||h,t,r),this._styleShape(t,u))}o.getNode().vector=t}}else o&&this._removeShape(t)},_compareOffsets:function(t,e){var r=!1;return r=t.length===e.length?t.every(function(t,r){return t===e[r]}):!1},_getScreenOffsets:function(t,e){var r=e.spatialReference,i=this._viewGeoExtent&&4326===r.wkid?this._viewGeoExtent:this._viewExtent,s=i.spatialReference;if(s.isWrappable){var a,n,o=[],l=s._getInfo(),h=t.state.worldScreenWidth,c=e._partwise;return a=i._getParts(l),c&&c.length?(n=[],c.forEach(function(t){n=n.concat(t._getParts(l))})):n=e._getParts(l),n.forEach(function(t){a.forEach(function(e){e.extent.intersects(t.extent)&&t.frameIds.forEach(function(t){var r=(e.frameIds[0]-t)*h;-1===o.indexOf(r)&&o.push(r)})}.bind(this))}.bind(this)),o.length?o.sort():null}return i.intersects(e)?[0]:null},_isInvalidShape:function(t,e){var r=e&&e.shape&&e.shape.type,i=t&&t.type,s=t&&t.style;return i&&(s=S[i]||s),w[s]&&(s="path"),!(!r||!s||r===s)},_removeShape:function(t,e){var r=t.shape,i=r&&r.getNode();r&&(r.removeShape(),r.destroy()),t.shape=t.offsets=null,e!==!1&&this._removeBgShape(t),i&&(i.e_graphic=null)},_removeBgShape:function(t){var e=t.bgShape,r=e&&e.getNode();e&&(e.removeShape(),e.destroy()),t.bgShape=null,r&&(r.e_graphic=null)},_drawPoint:function(t,e,r,a,o,l){var h,c,p=r.type,y=this._projector.toScreenPoint(e,o[0]),m=n.fromValues(y.x,y.y),g=m[0],_=m[1],x=null!=l?a.shape&&a.shape.children[l]:a.shape,S=[],w=a.rotationAngle,b=a.size;if(b&&(b=isFinite(b[0])&&b[0],c=!!b),b=c?d.pt2px(b):null,m={x:m[0],y:m[1]},null==w){var E=s.toRadian(360-this.view.rotation);S.push(i.rotateAt(E,m))}w&&S.push(i.rotategAt(w,m));var T=d.pt2px(r.xoffset),M=d.pt2px(r.yoffset);if((0!==T||0!==M)&&S.push(i.translate(T,-M)),0!==r.angle&&S.push(i.rotategAt(r.angle,m)),"simple-marker-symbol"===p){var P,k=r.style,A=Math.round;b=c?b:d.pt2px(r.size);var O,R;switch(k){case u.STYLE_SQUARE:case u.STYLE_CROSS:case u.STYLE_X:case u.STYLE_DIAMOND:P=isNaN(b)?16:b/2,h=this._drawPath(t,x,this._smsToPath(u,k,g,_,A(g-P),A(g+P),A(_-P),A(_+P)));break;case u.STYLE_TARGET:var L=d.pt2px(r._targetWidth)/2,V=d.pt2px(r._targetHeight)/2;h=this._drawPath(t,x,this._smsToPath(u,k,g,_,A(g-L),A(g+L),A(_-V),A(_+V),d.pt2px(r._spikeSize)));break;case u.STYLE_PATH:h=this._drawPath(t,x,r.path,!0);var G=h.getBoundingBox(),N=this._getScaleMatrix(G,b);(1!==N.xx||1!==N.yy)&&S.push(i.scaleAt(N.xx,N.yy,m)),S.push(i.translate(-(G.x+G.width/2)+g,-(G.y+G.height/2)+_));break;default:P=isNaN(b)?16:b/2,h=this._drawCircle(t,x,{cx:g,cy:_,r:P})}}else if("shield-label-symbol"===p){O=d.pt2px(r.width),R=d.pt2px(r.height);var I=t.createGroup(),Y=t.createImage({x:g-O/2,y:_-R/2,width:O,height:R,src:r.url});if(I.add(Y),null!=r.font){var j=g,z=_+.2*d.pt2px(r.getHeight()),F=t.createText({type:"text",text:r.text,x:j,y:z,align:"middle",decoration:r.decoration,rotated:r.rotated,kerning:r.kerning}),C=r.font.clone();C.size=d.pt2px(C.size),F.setFont(C),F.setFill(r.color),I.add(F)}h=I}else if("picture-marker-symbol"===p)O=c?b:d.pt2px(r.width),R=c?b:d.pt2px(r.height),h=this._drawImage(t,x,{x:g-O/2,y:_-R/2,width:O,height:R,src:r.url});else if("text-symbol"===p&&(C=r.font,C&&(C=C.clone(),C.size=null!=b?b:d.pt2px(C.size)),h=this._drawText(t,x,{type:"text",text:r.text,x:g,y:_,align:f.getSVGAlign(r),decoration:r.decoration||C&&C.decoration,rotated:r.rotated,kerning:r.kerning}),C&&h.setFont(C),v)){var B=h.getNode(),U=f.getSVGBaseline(r),W=f.getSVGBaselineShift(r);B&&(B.setAttribute("dominant-baseline",U),W&&B.setAttribute("baseline-shift",W))}return h.setTransform(i.multiply(S)),h},_getScaleMatrix:function(t,e){var r=t.width/t.height,i=1,s=1;return isNaN(e)||(r>1?(i=e/t.width,s=e/r/t.height):(s=e/t.height,i=e*r/t.width)),{xx:i,yy:s}},_drawMarkers:function(t,e,r,i,s){var a,n,o,l=e.points,h=i.shape||t.createGroup(),c=l.length,p=[],u=0,f=s?s.length:0;for(h.children[0]&&this._isInvalidShape(r,h.children[0])&&h.clear(),n=0;c>n;n++)for(a=l[n],o=0;f>o;o++)p[0]=s[o],h.add(this._drawPoint(h,{x:a[0],y:a[1],spatialReference:e.spatialReference},r,i,p,u++));var d=h.children.length;if(c*s.length<d)for(n=d-1;n>=c*s.length;n--)h.children[n].removeShape();return h},_drawShape:function(t,e,r,i){var s,a,n=e.type,o=r.shape,l=this._projector,h=[];if("extent"===n&&(e=c.fromExtent(e),n=e.type),"polyline"===n||"polygon"===n){for(s=0,a=i.length;a>s;s++)h=h.concat(l.toScreenPath(e,i[s]));o=this._drawPath(t,o,h),this._rendererLimits&&("polyline"===n?this._clipPolyline(o,e):this._clipPolygon(o,e))}return o},_drawRect:function(t,e,r){return e?e.setShape(r):t.createRect(r)},_drawImage:function(t,e,r){return e?e.setShape(r):t.createImage(r)},_drawCircle:function(t,e,r){return e?e.setShape(r):t.createCircle(r)},_drawPath:function(t,e,r,i){return r=i?r:r.join(" "),e?e.setShape(r):t.createPath(r)},_drawText:function(t,e,r){return e?e.setShape(r):t.createText(r)},_smsToPath:function(t,e,r,i,s,a,n,o,l){switch(e){case t.STYLE_SQUARE:return["M",s+","+n,a+","+n,a+","+o,s+","+o,"Z"];case t.STYLE_CROSS:return["M",r+","+n,r+","+o,"M",s+","+i,a+","+i];case t.STYLE_X:return["M",s+","+n,a+","+o,"M",s+","+o,a+","+n];case t.STYLE_DIAMOND:return["M",r+","+n,a+","+i,r+","+o,s+","+i,"Z"];case t.STYLE_TARGET:return["M",s+","+n,a+","+n,a+","+o,s+","+o,s+","+n,"M",s-l+","+i,s+","+i,"M",r+","+(n-l),r+","+n,"M",a+l+","+i,a+","+i,"M",r+","+(o+l),r+","+o]}},_stylePoint:function(t,r,i){var s=r.type,a=r.style,n=null!=i?t.shape&&t.shape.children[i]:t.shape;if("shield-label-symbol"!==s&&"picture-marker-symbol"!==s){var o=f.getStroke(r),l=f.getFill(r),h=a===u.STYLE_X||a===u.STYLE_CROSS,c=o&&o.color,p=t.color||(h?c:l),d=t.opacity;p&&null!=d&&(p=this._applyOpacity(p,d)),p&&(h?p!==c&&(o=o?e.mixin({},o):{},o.color=p):p!==l&&(l=p)),"text-symbol"===s?n.setFill(l):"simple-marker-symbol"===s&&n.setFill(l).setStroke(o)}},_styleMarkers:function(t,e){var r,i=t.shape.children,s=i.length;for(r=0;s>r;r++)this._stylePoint(t,e,r)},_styleShape:function(t,r){var i,s,a,n,o=f.getStroke(r),l=f.getFill(r),h=r.type,c=t.shape,p=t.outlineSize,u=-1!==h.indexOf("line-symbol"),y=u?"none"!==r.style:r.outline&&"none"!==r.outline.style;p&&Array.isArray(p)&&(p=isFinite(p[0])&&p[0]),p=null!=p?d.pt2px(p):null,!t.color&&null==t.opacity||"picture-fill-symbol"===h||(i=t.color,s=t.opacity,u?(a=i||o&&o.color,a&&null!=s&&(a=this._applyOpacity(a,s))):l&&l.toCss&&(n=i||l,n&&null!=s&&(n=this._applyOpacity(n,s)))),c.setStroke(!y||null==p&&!a?o:e.mixin({},o,null!=p?{width:p}:null,a&&{color:a})).setFill(n||l),v&&c.rawNode.setAttribute("vector-effect","non-scaling-stroke")},_applyOpacity:function(t,e){return null!=e&&(t=t.clone(),t.a=e),t},_updateTransform:function(){var t=this.transform=this.transform||a.create(),e=this.resolution,r=n.fromValues(.5*this.view.width,.5*this.view.height),i=n.fromValues(1/e,-1/e),s=n.fromValues(-this.x,-this.y);a.identity(t),a.translate(t,t,r),a.scale(t,t,i),a.translate(t,t,s),t[4]=Math.round(t[4]),t[5]=Math.round(t[5]),this._projector.set({resolution:e,transform:t})}});return b});