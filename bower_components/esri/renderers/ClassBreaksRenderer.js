// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["../core/declare","../core/lang","../core/kebabDictionary","dojo/_base/array","dojo/_base/lang","../symbols/support/jsonUtils","./Renderer"],function(e,a,s,i,l,n,r){var o="log",t="percent-of-total",u="field",c=s({esriNormalizeByLog:o,esriNormalizeByPercentOfTotal:t,esriNormalizeByField:u}),f=s({esriClassifyNaturalBreaks:"natural-breaks",esriClassifyEqualInterval:"equal-interval",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation",esriClassifyGeometricalInterval:"geometrical-interval"}),m=e(r,{declaredClass:"esri.renderer.ClassBreaksRenderer",properties:{backgroundFillSymbol:{value:null,json:{read:n.read,write:function(e,a,s){var i=n.write(e,{},s);i&&(a.backgroundFillSymbol=i)}}},classBreakInfos:{set:function(e){this._symbols={},e&&e.forEach(this._processCBInfo,this),this._set("classBreakInfos",e)},json:{readFrom:["classBreakInfos","minValue"],read:function(e,s,i){var l=s.minValue;if(e&&Array.isArray(e)){var r=e[0]&&null!=e[0].classMaxValue;return e.map(function(e){if(e=a.clone(e),r){var o=e.classMaxValue;e.minValue=l,e.maxValue=o,l=o}return e.symbol=n.read(e.symbol,s,i),e})}return e},write:function(e,s,l){var r=this.classBreakInfos||[],o=r[0]&&r[0].minValue;s.minValue=o===-(1/0)?-Number.MAX_VALUE:o,s.classBreakInfos=i.map(r,function(e){return e=a.clone(e),e.symbol&&(e.symbol=n.write(e.symbol,{},l)),e.classMaxValue=e.maxValue===1/0?Number.MAX_VALUE:e.maxValue,delete e.minValue,delete e.maxValue,a.fixJson(e)})}}},classificationMethod:{value:null,json:{read:f.fromJSON,write:function(e,a){var s=f.toJSON(e);s&&(a.classificationMethod=s)}}},defaultLabel:{value:null,json:{writable:!0}},defaultSymbol:{value:null,json:{read:n.read,write:function(e,a,s){var i=n.write(e,{},s);i&&(a.defaultSymbol=i)}}},expression:{value:null,json:{writable:!0}},expressionTree:{dependsOn:["expression"],get:function(){return this.expression?this._parseExpr(this.expression,{vars:{$feature:"any"}}):null}},field:{value:null,json:{writable:!0}},isMaxInclusive:!0,normalizationField:{value:null,json:{writable:!0}},normalizationTotal:{value:null,json:{writable:!0}},normalizationType:{value:null,dependsOn:["normalizationField","normalizationTotal"],get:function(){var e=this._get("normalizationType"),a=!!this.normalizationField,s=null!=this.normalizationTotal;return a||s?(e=a&&u||s&&t,a&&s&&console.warn("warning: both normalizationField and normalizationTotal are set!")):(e===u||e===t)&&(e=null),e},json:{read:c.fromJSON,write:function(e,a){var s=c.toJSON(e);s&&(a.normalizationType=s)}}},requiredFields:{dependsOn:["field","normalizationField"]},type:"classBreaks"},constructor:function(){this._symbols={},this.classBreakInfos=[]},addClassBreakInfo:function(e,a,s){var i=l.isObject(e)?e:{minValue:e,maxValue:a,symbol:s};this.classBreakInfos.push(i),this._processCBInfo(i)},removeClassBreakInfo:function(e,a){var s,i,l=this.classBreakInfos.length,n=this._symbols;for(i=0;l>i;i++)if(s=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue],s[0]==e&&s[1]==a){delete n[e+"-"+a],this.classBreakInfos.splice(i,1);break}},getBreakIndex:function(e){var a,s,i,n=this.field,r=e.attributes,c=this.classBreakInfos.length,f=this.isMaxInclusive;if(this.expression)a=this._executeExpr(this.expressionTree,this._createExprContext(e));else if(l.isFunction(n))a=n(e);else{a=parseFloat(r[n]);var m,d,h=this.normalizationType;h&&(m=parseFloat(this.normalizationTotal),d=parseFloat(r[this.normalizationField]),h===o?a=Math.log(a)*Math.LOG10E:h!==t||isNaN(m)?h!==u||isNaN(d)||(a/=d):a=a/m*100)}for(s=0;c>s;s++)if(i=[this.classBreakInfos[s].minValue,this.classBreakInfos[s].maxValue],i[0]<=a&&(f?a<=i[1]:a<i[1]))return s;return-1},getClassBreakInfo:function(e){var a=this.getBreakIndex(e);return-1!==a?this.classBreakInfos[a]:null},getSymbol:function(e){var a=this.getBreakIndex(e),s=a>-1&&[this.classBreakInfos[a].minValue,this.classBreakInfos[a].maxValue];return s?this._symbols[s[0]+"-"+s[1]]:this.defaultSymbol},clone:function(){return new m({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),classificationMethod:this.classificationMethod,defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),expression:this.expression,classBreakInfos:a.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:a.clone(this.visualVariables)})},collectRequiredFields:function(e){this.inherited(arguments),[this.field,this.normalizationField].forEach(function(a){a&&(e[a]=!0)})},_processCBInfo:function(e){var a=e.minValue,s=e.maxValue,i=e.symbol;i&&(i.declaredClass||(e.symbol=n.fromJSON(i))),this._symbols[a+"-"+s]=e.symbol}});return m});