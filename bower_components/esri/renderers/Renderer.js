// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["../core/declare","../core/Accessor","../core/JSONSupport","../core/kebabDictionary","../core/screenUtils","../core/lang","dojo/_base/lang","../Color","../arcade/arcade"],function(t,e,i,a,o,r,n,s,l){var u="size",c="color",p="opacity",f="rotation",h=a({sizeInfo:u,colorInfo:c,transparencyInfo:p,rotationInfo:f}),y=a({widthAndDepth:"width-and-depth"}),_=Math.PI,m=t([e,i],{declaredClass:"esri.renderer.Renderer",properties:{authoringInfo:{value:null,json:{write:function(t,e){t=r.clone(t),t.visualVariables&&t.visualVariables.forEach(function(t){t.type===p&&(t.type=h.toJSON(t.type))}),e.authoringInfo=t}}},requiredFields:{dependsOn:["visualVariables"],get:function(){var t=Object.create(null);return this.collectRequiredFields(t),Object.keys(t)}},type:{readOnly:!0,json:{readable:!1,writeAlways:!0}},visualVariables:{json:{readFrom:["visualVariables","rotationType","rotationExpression"],read:function(t,e){return this._readVariables(t,e)},write:function(t,e){var i=[];t.forEach(function(t){t.type===u?i.push(this._writeSizeInfo(t)):t.type===c?i.push(this._writeColorInfo(t)):t.type===p?i.push(this._writeOpacityInfo(t)):t.type===f&&i.push(this._writeRotationInfo(t))},this),e.visualVariables=i}}}},constructor:function(){this._ipDataCache={}},_rotationRE:/^\[([^\]]+)\]$/i,_meterIn:{inches:39.3701,feet:3.28084,yards:1.09361,miles:621371e-9,"nautical-miles":539957e-9,millimeters:1e3,centimeters:100,decimeters:10,meters:1,kilometers:.001,"decimal-degrees":180/20015077},_scaleExpr:"view.scale",_visualVariablesSetter:function(t){var e=this._ipDataCache;this.visualVariables&&this.visualVariables.forEach(function(t,i){e.hasOwnProperty(i)&&(e[i]=null)},this);var i=t&&t.some(function(t){return!!t.target});i&&t.sort(function(t,e){var i;return i=t.target===e.target?0:t.target?1:-1}),t&&t.forEach(function(t,i){t.type===c?e[i]=this._processColorInfo(t):t.type===p?e[i]=this._processOpacityInfo(t):t.type===u&&(e[i]=this._processSizeInfo(t))},this),this._set("visualVariables",t)},getSymbol:function(t){},getVisualVariableValues:function(t,e){var i,a=this.visualVariables;return a&&(i=a.map(function(i){var a,o=i.type,r=o+"Info";switch(e=n.mixin({},e),e[r]=i,o){case u:a=this.getSize(t,e);break;case c:a=this.getColor(t,e);break;case p:a=this.getOpacity(t,e);break;case f:a=this.getRotationAngle(t,e)}return{variable:i,value:a}},this).filter(function(t){return null!=t.value},this)),i},hasVisualVariables:function(t,e){return t?!!this.getVisualVariablesForType(t,e):!!(this.getVisualVariablesForType(u,e)||this.getVisualVariablesForType(c,e)||this.getVisualVariablesForType(p,e)||this.getVisualVariablesForType(f,e))},getVisualVariablesForType:function(t,e){var i,a=this.visualVariables;return a&&(i=a.filter(function(i){return i.type===t&&("string"==typeof e?i.target===e:e===!1?!i.target:!0)}),i&&0===i.length&&(i=void 0)),i},getSize:function(t,e){var i=this._getVarInfo(e&&e.sizeInfo,u),a=i.variable,o=this._ipDataCache[i.cacheKey],r=null;if(a){var n=a.minSize,s=a.maxSize,l="object"==typeof n&&n?this._getSize(t,n,o&&o.minSize,e):n,c="object"==typeof s&&s?this._getSize(t,s,o&&o.maxSize,e):s;r=this._getSize(t,a,o&&o.root,e,[l,c])}return r},getSizeRangeAtScale:function(t,e){var i,a=this._getVarInfo(t,u),o=this._ipDataCache[a.cacheKey],r={scale:e};if(t=a.variable,t&&e){var n=t.minSize,s=t.maxSize,l="object"==typeof n&&n?this._getSize({},n,o&&o.minSize,r):n,c="object"==typeof s&&s?this._getSize({},s,o&&o.maxSize,r):s;(null!=l||null!=c)&&(i={minSize:l,maxSize:c})}return i},getColor:function(t,e){var i=this._getVarInfo(e&&e.colorInfo,c);return this._getColorComponent(t,i.variable,this._ipDataCache[i.cacheKey])},getOpacity:function(t,e){var i=this._getVarInfo(e&&e.opacityInfo,p);return this._getColorComponent(t,i.variable,this._ipDataCache[i.cacheKey],!0)},getRotationAngle:function(t,e){var i=this._getVarInfo(e&&e.rotationInfo,f),a=i.variable,o="arithmetic"===a.rotationType,r=a.field,s=t.attributes,l=0;return r&&(n.isFunction(r)?l=r.apply(this,arguments):s&&(l=s[r]||0),l=(l+(o?-90:0))*(o?-1:1)),l},collectRequiredFields:function(t){var e=[];this.visualVariables&&(e=e.concat(this.visualVariables)),e.forEach(function(e){e&&e.field&&(t[e.field]=!0),e&&e.normalizationField&&(t[e.normalizationField]=!0)})},_getVarInfo:function(t,e){var i;if(t&&t.type===e&&this.visualVariables)i=this.visualVariables.indexOf(t),t=this.visualVariables[i];else if(this.visualVariables){var a=this.getVisualVariablesForType(e);t=a&&a[0],i=this.visualVariables.indexOf(t)}return{variable:t,cacheKey:i}},_readSizeInfo:function(t){return t.axis&&(t.axis=y.fromJSON(t.axis)),t},_readColorInfo:function(t){return t&&(t.colors&&t.colors.forEach(function(e,i){n.isArray(e)?t.colors[i]=s.fromJSON(e):t.colors[i]=new s(e)}),t.stops&&t.stops.forEach(function(e,i){e.color&&n.isArray(e.color)?t.stops[i].color=s.fromJSON(e.color):e.color&&(t.stops[i].color=new s(e.color))})),t},_readOpacityInfo:function(t){var e;return t&&(e=n.mixin({},t),e.transparencyValues&&(e.opacityValues=e.transparencyValues.map(function(t){return 1-t/100}),delete e.transparencyValues),e.stops&&(e.stops=e.stops.map(function(t){return t=n.mixin({},t),t.opacity=1-t.transparency/100,delete t.transparency,t}))),e},_readVariables:function(t,e){t&&(t=t.map(function(t){return t=r.clone(t),t.type=h.fromJSON(t.type),t.type===u?t=this._readSizeInfo(t):t.type===c?t=this._readColorInfo(t):t.type===p&&(t=this._readOpacityInfo(t)),t},this));var i=e.rotationType,a=e.rotationExpression;if(a){var o={type:f,rotationType:i},n=a.match(this._rotationRE);n&&n[1]&&(o.field=n[1],t||(t=[]),t.push(o))}return t},_processColorInfo:function(t){return t&&(t.colors&&t.colors.forEach(function(e,i){e instanceof s||(t.colors[i]=new s(e))}),t.stops&&t.stops.forEach(function(e,i){!e.color||e.color instanceof s||(t.stops[i].color=new s(e.color))}),this._sortStops(t.stops)),this._interpolateData(t)},_processOpacityInfo:function(t){return this._sortStops(t&&t.stops),this._interpolateData(t)},_processSizeInfo:function(t){return t.stops&&Array.isArray(t.stops)?t.stops=this._processSizeInfoStops(t.stops):(t.minSize=t.minSize&&this._processSizeInfoSize(t.minSize),t.maxSize=t.maxSize&&this._processSizeInfoSize(t.maxSize)),{root:this._interpolateData(t),minSize:this._interpolateData(t.minSize),maxSize:this._interpolateData(t.maxSize)}},_processSizeInfoSize:function(t){return"object"==typeof t?t.stops=this._processSizeInfoStops(t.stops):t=o.toPt(t),t},_processSizeInfoStops:function(t){return t&&Array.isArray(t)&&(t.forEach(function(t){t.size=o.toPt(t.size)}),this._sortStops(t)),t},_sortStops:function(t){t&&Array.isArray(t)&&t.sort(function(t,e){return t.value-e.value})},_getSize:function(t,e,i,a,o){var r=t.attributes,s=e.field,l=e.expression,u=e.stops,c=0,p="number"==typeof t,f=p?t:null;if(s||l){var h,y=a&&a.scale,m=o?o[0]:e.minSize,v=o?o[1]:e.maxSize,g=e.minDataValue,V=e.maxDataValue,S=e.valueUnit||"unknown",d=e.valueRepresentation,b=e.scaleBy,z=e.normalizationField,I=r?parseFloat(r[z]):void 0,x=a&&a.shape;if(l&&(f=l.toLowerCase()===this._scaleExpr?null==y?this._getAverageValue(e):y:null),"number"!=typeof f&&(n.isFunction(s)?f=s.apply(this,arguments):r&&(f=r[s])),null==f||z&&!p&&(isNaN(I)||0===I))return null;if(isNaN(I)||p||(f/=I),u){var O,C,w=this._lookupData(f,i),D=w[0],F=w[1];D===F?c=u[D].size:(O=u[D].size,C=u[F].size,c=O+(C-O)*w[2])}else if(null!=m&&null!=v&&null!=g&&null!=V)if(g>=f)c=m;else if(f>=V)c=v;else if(h=(f-g)/(V-g),"area"===b&&x){var N="circle"===x,E=N?_*Math.pow(m/2,2):m*m,A=N?_*Math.pow(v/2,2):v*v,j=E+h*(A-E);c=N?2*Math.sqrt(j/_):Math.sqrt(j)}else c=m+h*(v-m);else if("unknown"===S)null!=m&&null!=g?(m&&g?(h=f/g,c="circle"===x?2*Math.sqrt(h*Math.pow(m/2,2)):"square"===x||"diamond"===x||"image"===x?Math.sqrt(h*Math.pow(m,2)):h*m):c=f+(m||g),c=m>c?m:c,null!=v&&c>v&&(c=v)):c=f;else{var J=(a&&a.resolution?a.resolution:1)*this._meterIn[S];"area"===d?(c=Math.sqrt(f/_)/J,c*=2):(c=f/J,("radius"===d||"distance"===d)&&(c*=2)),null!=m&&m>c&&(c=m),null!=v&&c>v&&(c=v)}}else e&&(c=u&&u[0]&&u[0].size,null==c&&(c=e.minSize));return c=isNaN(c)?0:c},_getAverageValue:function(t){var e,i,a=t.stops;return a?(e=a[0].value,i=a[a.length-1].value):(e=t.minDataValue||0,i=t.maxDataValue||0),(e+i)/2},_getColorComponent:function(t,e,i,a,o){var r,s=t.attributes,l=e&&e.field,u="number"==typeof t?t:null;if(l){var c=e.normalizationField,p=s?parseFloat(s[c]):void 0;"number"!=typeof u&&(n.isFunction(l)?u=l.apply(this,arguments):s&&(u=s[l])),null!=u&&(c&&!isNaN(p)&&0!==p&&(u/=p),r=a?this._getOpacity(u,e,i):this._getColor(u,e,i))}else if(e){var f=e.stops;a?(r=f&&f[0]&&f[0].opacity,null==r&&(r=e.opacityValues&&e.opacityValues[0])):r=f&&f[0]&&f[0].color||e.colors&&e.colors[0]}return o&&(o.data=u,o.value=r),o||r},_interpolateData:function(t){var e;if(t)if(t.colors||t.opacityValues){var i,a=(t.colors||t.opacityValues).length,o=t.minDataValue,r=(t.maxDataValue-o)/(a-1);for(e=[],i=0;a>i;i++)e[i]=o+i*r}else t.stops&&(e=t.stops.map(function(t){return t.value}));return e},_getOpacity:function(t,e,i){var a,o=this._lookupData(t,i);if(e=e||this.opacityInfo,o){var r,n,s=o[0],l=o[1];s===l?a=this._getOpacValue(e,s):(r=this._getOpacValue(e,s),n=this._getOpacValue(e,l),a=r+(n-r)*o[2])}return a},_getOpacValue:function(t,e){return t.opacityValues?t.opacityValues[e]:t.stops[e].opacity},_getColor:function(t,e,i){var a,o=this._lookupData(t,i);if(e=e||this.colorInfo,o){var r=o[0],n=o[1];a=r===n?this._getColorObj(e,r):s.blendColors(this._getColorObj(e,r),this._getColorObj(e,n),o[2]),a=new s(a)}return a},_getColorObj:function(t,e){return t.colors?t.colors[e]:t.stops[e].color},_lookupData:function(t,e){var i;if(e){var a=0,o=e.length-1;e.some(function(e,i){return e>t?(o=i,!0):(a=i,!1)}),i=[a,o,(t-e[a])/(e[o]-e[a])]}return i},_writeRotationInfo:function(t){return t&&(t=n.mixin({},t),t.type=h.toJSON(t.type)),t},_writeSizeInfo:function(t){if(t){t=n.mixin({},t);var e=t.legendOptions,i=t.type,a=t.axis;t.type=h.toJSON(i),a&&(t.axis=y.toJSON(a)),e&&(t.legendOptions=n.mixin({},e),e=e.customValues,e&&(t.legendOptions.customValues=e.slice(0)))}return t},_writeColorInfo:function(t){return t&&(t=n.mixin({},t),t.type=h.toJSON(t.type),t.colors&&(t.colors=t.colors.map(function(t){return s.toJSON(t)})),t.stops&&(t.stops=t.stops.map(function(t){return t=n.mixin({},t),t.color&&(t.color=s.toJSON(t.color)),t}))),t},_writeOpacityInfo:function(t){var e;return t&&(e=n.mixin({},t),e.type=h.toJSON(e.type),e.opacityValues&&(e.transparencyValues=e.opacityValues.map(function(t){return 100*(1-t)}),delete e.opacityValues),e.stops&&(e.stops=e.stops.map(function(t){return t=n.mixin({},t),t.transparency=100*(1-t.opacity),delete t.opacity,t}))),e},_createExprContext:function(t){return{vars:{$feature:l.constructFeature(t)}}},_parseExpr:function(t,e){return l.parseScript(t,e)},_executeExpr:function(t,e){return l.executeScript(t,e,-1)}});return m});