// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["require","exports","./core/tsSupport/declareExtendsHelper","./core/tsSupport/decorateHelper","./core/tsSupport/paramHelper","./Map","./core/Error","./core/requireUtils","./core/promiseUtils","./core/JSONSupport","./core/Loadable","./core/urlUtils","./core/Logger","./core/accessorSupport/read","./core/accessorSupport/originUtils","./support/groundUtils","./Basemap","./Viewpoint","./kernel","./geometry/support/jsonUtils","./geometry/support/castUtils","./geometry/Geometry","./geometry/SpatialReference","./geometry/support/scaleUtils","./webscene/Presentation","./webscene/InitialViewProperties","./webscene/Environment","./portal/PortalItem","./portal/Portal","dojo/_base/lang","./core/accessorSupport/decorators"],function(e,r,t,i,n,o,a,p,s,l,u,c,y,d,f,v,m,h,w,g,b,A,S,I,V,L,M,_,O,R,j){function U(){return o}var E=y.getLogger("esri.webscene"),N={major:1,minor:4};Object.freeze(N);var P="Web Scene",J="ViewingMode-Local",x=function(r){function o(e){r.call(this),this.basemapElevationLayerIds=[],this.clippingArea=null,this.clippingEnabled=!1,this.sourceVersion=null,this.presentation=null,this.initialViewProperties=null,this.portalItem=null,this.resourceInfo=null,this.authoringApp=null,this.authoringAppVersion=null,this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1}return t(o,r),o.prototype.initialize=function(){if(this.resourceInfo){var e=void 0;try{e=this._validateJSON(this.resourceInfo)}catch(r){return void this.addResolvingPromise(s.reject(r))}this.read(e),this.addResolvingPromise(this._validateSpatialReference())}},o.prototype.getDefaults=function(e){return R.mixin(this.inherited(arguments),{presentation:{},initialViewProperties:{}})},o.prototype.readBasemap=function(e,r){if(!r.baseMap)return null;var t=R.mixin({},r.baseMap);delete t.elevationLayers;var i=new m;return i.resourceInfo=t,i.read(t,{origin:"web-scene"}),i},o.prototype.writeBasemap=function(e,r,t){var i=this;if(e&&(r.baseMap||(r.baseMap={}),e.write(r.baseMap,t),r.baseMap.elevationLayers=[]),this.ground){var n=this.ground.layers.filter(function(e){return!i._groundLayerIsOperational(e)&&i.verifyWriteLayer(e,t)}).map(function(e){return e.write(null,t)});n.length>0&&(r.baseMap||(r.baseMap={id:"basemap",title:"Basemap"}),r.baseMap.elevationLayers=n.toArray())}},o.prototype.readClippingArea=function(e){return e&&e.geometry?g.fromJSON(e.geometry):null},o.prototype.writeClippingArea=function(e,r){e&&(r.clippingArea||(r.clippingArea={}),r.clippingArea.geometry=e.toJSON())},o.prototype.readClippingEnabled=function(e,r){return r.clippingArea?!!r.clippingArea.clip:!1},o.prototype.writeClippingEnabled=function(e,r){this.clippingArea&&(r.clippingArea||(r.clippingArea={}),r.clippingArea.clip=e)},o.prototype.writeLayers=function(e,r,t){var i=this,n=R.mixin({},t,{layerContainerType:"ground"}),o=R.mixin({},t,{layerContainerType:"operational-layers"}),a=this.ground.layers.filter(function(e){return i._groundLayerIsOperational(e)&&i.verifyWriteLayer(e,n)}).map(function(e){return e.write(null,n)});a.addMany(e.filter(function(e){return i.verifyWriteLayer(e,o)}).map(function(e){return e.write(null,o)})),a=a.filter(function(e){return!!e}),r.operationalLayers=a.toArray()},o.prototype.verifyWriteLayer=function(e,r){return e.write?!0:(r&&r.messages.push(new a("layer:unsupported","Layers ("+e.title+", "+e.id+") of type '"+e.declaredClass+"' cannot be persisted in web scenes",{layer:e})),!1)},o.prototype.readSourceVersion=function(e,r){var t=r.version.split("."),i=t[0],n=t[1];return{major:parseInt(i,10),minor:parseInt(n,10)}},o.prototype.writeSourceVersion=function(e,r){r.version=N.major+"."+N.minor},Object.defineProperty(o.prototype,"authoringApp",{set:function(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)},enumerable:!0,configurable:!0}),o.prototype.writeAuthoringApp=function(e,r){e&&this._isAuthoringAppSetByUser?r.authoringApp=e:r.authoringApp="ArcGIS API for JavaScript"},Object.defineProperty(o.prototype,"authoringAppVersion",{set:function(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)},enumerable:!0,configurable:!0}),o.prototype.writeAuthoringAppVersion=function(e,r){e&&this._isAuthoringAppVersionSetByUser?r.authoringAppVersion=e:r.authoringAppVersion=w.version},o.prototype.writePresentation=function(e,r){var t=this,i=e.toJSON();i.slides.forEach(function(e){e.visibleLayers=e.visibleLayers.filter(function(e){var r=t.ground.layers.find(function(r){return r.id===e.id});return!r||t._groundLayerIsOperational(r)})}),r.presentation=i},o.prototype.readInitialViewProperties=function(e,r){var t={};return r.initialState&&r.initialState.environment&&(t.environment=M.fromJSON(r.initialState.environment)),r.spatialReference&&(t.spatialReference=S.fromJSON(r.spatialReference)),t.viewingMode=r.viewingMode||"global",r.initialState&&r.initialState.viewpoint&&(t.viewpoint=h.fromJSON(r.initialState.viewpoint)),new L(t)},o.prototype.writeInitialViewProperties=function(e,r){if(e){var t={};e.environment&&(t.environment=e.environment.toJSON()),e.viewpoint&&(t.viewpoint=e.viewpoint.toJSON()),0!==Object.keys(t).length&&(r.initialState=t),r.spatialReference=e.spatialReference?e.spatialReference.toJSON():S.WebMercator.toJSON(),r.viewingMode=null!=e.viewingMode?e.viewingMode:"global"}},o.prototype.load=function(){return this.addResolvingPromise(this._loadFromSource()),this},o.prototype.toJSON=function(){return this.write(null,{origin:"web-scene"})},o.prototype.read=function(e,r){var t=this;r=R.mixin({},r,{origin:"web-scene"});var i=this._isAuthoringAppVersionSetByUser,n=this._isAuthoringAppSetByUser,o=arguments;if(d.readLoadable(this,e,function(r){return t.inherited(o,[e,r])},r),n||(this._isAuthoringAppSetByUser=!1),i||(this._isAuthoringAppVersionSetByUser=!1),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)){var a=e.baseMap.elevationLayers.map(function(e){return{id:e.id}});this.presentation.slides.forEach(function(e){e.visibleLayers.addMany(a)})}return this},o.prototype.write=function(e,r){return r=R.mixin({},r,{origin:"web-scene"}),this.inherited(arguments,[e,r])},o.prototype.save=function(e){var r=this;if(!this.portalItem)return E.error("save(): requires the .portalItem property to be set"),s.reject(new a("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene"));if(this.portalItem.type!==P)return s.reject(new a("webscene:portal-item-wrong-type",'Portal item needs to have type "'+P+'"'));var t={origin:"web-scene",url:this.portalItem.itemUrl&&c.urlToObject(this.portalItem.itemUrl),messages:[],portal:this.portalItem.portal||O.getDefault(),writtenProperties:[]},i=this.write(null,t),n=this._verifySave(t,e);return n?s.reject(n):(this._makeRelativeStyleUrls(i,this.portalItem.itemUrl),this._updateTypeKeywords(this.portalItem),this.portalItem.update({data:i}).then(function(){return f.updateOrigins(t),s.resolve(r.portalItem)}))},o.prototype.saveAs=function(e,r){var t=this;if(!e)return E.error("saveAs(portalItem): requires a portal item parameter"),s.reject(new a("webscene:portal-item-required","saveAs requires a portal item to save to"));if(e.type&&e.type!==P||e.id)return s.reject(new a("webscene:portal-item-already-exists","WebScene can only saveAs to a new and empty portal item"));var i=e.portal||O.getDefault();if(!i.user)return s.reject(new a("portal:not-signed-in","Not signed in"));if(this.portalItem&&this.containsRelativeStyleUrls())return s.reject(new a("webscene:failed-to-copy-embedded-resources","Copying of embedded resources is currently not supported"));var n={origin:"web-scene",url:null,messages:[],portal:i,writtenProperties:[]},o=this.write(null,n),p=this._verifySave(n,r);return p?s.reject(p):(e.type=P,this._updateTypeKeywords(e),i.user.addItem({item:e,folder:r&&r.folder,data:o}).then(function(){return t.portalItem=e,l.prototype.read.call(t,{version:o.version,authoringApp:o.authoringApp,authoringAppVersion:o.authoringAppVersion},{name:"web-scene",url:e.itemUrl&&c.urlToObject(e.itemUrl)}),f.updateOrigins(n),s.resolve(e)}))},o.prototype._verifySave=function(e,r){var t=e.messages.filter(function(e){return"error"===e.type});return r&&r.ignoreUnsupported&&(t=t.filter(function(e){return"layer:unsupported"!==e.name&&"symbol:unsupported"!==e.name})),t.length?new a("webscene:save","Failed to save webscene due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:t}):void 0},o.prototype.updateFrom=function(e,r){void 0===r&&(r={}),r.environmentExcluded||(this.initialViewProperties.environment=M.prototype.clone.apply(e.environment)),r.viewpointExcluded||(this.initialViewProperties.viewpoint=e.viewpoint.clone()),this.initialViewProperties.spatialReference=e.spatialReference.clone(),this.initialViewProperties.viewingMode=e.viewingMode,e.clippingArea?e.clippingArea!==this.clippingArea&&(this.clippingArea=e.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,e.map===this&&e.allLayerViews.forEach(function(e){e.layer.visible=e.visible})},o.prototype.containsRelativeStyleUrls=function(){return this.portalItem&&this.portalItem.id&&this.portalItem.itemUrl?this._makeRelativeStyleUrls(this.toJSON(),this.portalItem.itemUrl):!1},o.prototype.isDefaultGroundLayer=function(e){var r=v.groundElevationLayers["world-elevation"];return e.id===r.id&&c.normalize(e.url)===c.normalize(r.url)},o.prototype._groundLayerIsOperational=function(e){if("esri.layers.ElevationLayer"!==e.declaredClass)return!0;var r=-1!==this.basemapElevationLayerIds.indexOf(e.id);return r||this.isDefaultGroundLayer(e)?this.presentation.slides.some(function(r){return!r.visibleLayers.some(function(r){return r.id===e.id})})?!0:!1:!0},o.prototype._loadFromSource=function(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):s.resolve(null)},o.prototype._readAndLoadFromJSON=function(e,r){var t=this._validateJSON(e,r&&r.url&&r.url.path);return this.read(t,r),this._loadFromJSON(t,r)},o.prototype._loadFromJSON=function(r,t){var i=this;return this._validateSpatialReference().then(function(){return p.when(e,"./portal/support/layersCreator")}).then(function(e){var n=[],o=r.operationalLayers,a=[];r.baseMap&&Array.isArray(r.baseMap.elevationLayers)&&(a.push.apply(a,r.baseMap.elevationLayers),i.basemapElevationLayerIds=r.baseMap.elevationLayers.map(function(e){return e.id}));var p=function(e){return e.layers&&(e.layers=e.layers.filter(p)),"ArcGISTiledElevationServiceLayer"===e.layerType?(a.push(e),!1):!0};o&&(o=o.filter(p));var l={context:R.mixin({},t,{layerContainerType:"operational-layers"})};if(i.portalItem&&(l.context.portal=i.portalItem.portal||O.getDefault()),a.length>0){var u=R.mixin({},l,{context:R.mixin({},l.context,{layerContainerType:"ground"})});u.defaultLayerType="ArcGISTiledElevationServiceLayer",n.push.apply(n,e.populateOperationalLayers(i.ground.layers,a,u))}return o&&o.length>0&&n.push.apply(n,e.populateOperationalLayers(i.layers,o,l)),s.eachAlways(n).then(function(){})})},o.prototype._loadFromItem=function(e){var r=this;return e.load().otherwise(function(e){throw new a("webscene:load-portal-item","Failed to load portal item",{error:e})}).then(function(){if("Web Scene"!==e.type)throw new a("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:e.type})}).then(function(){return e.fetchData()}).then(function(t){return r.resourceInfo=t,r._readAndLoadFromJSON(t,{origin:"web-scene",url:c.urlToObject(e.itemUrl),portal:e.portal||O.getDefault()})})},o.prototype._validateSpatialReference=function(){var e,r=this.initialViewProperties,t=r.spatialReference||S.WebMercator,i="local"!==r.viewingMode;if(i){if(!t.isWGS84&&!t.isWebMercator)return s.reject(new a("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator or WGS84 GCS are supported",{spatialReference:t,viewingMode:r.viewingMode}));e=function(e){return!e||e.isWGS84||e.isWebMercator}}else{if(null==I.getUnitValue(t))return s.reject(new a("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:t,viewingMode:r.viewingMode}));e=function(e){return!e||e.equals(t)}}var n=function(e){return e&&(e.camera&&e.camera.position&&e.camera.position.spatialReference||e.targetGeometry&&e.targetGeometry.spatialReference)},o=r.viewpoint,p=n(o);if(p&&!e(p))return s.reject(new a("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:p,sceneSpatialReference:t,viewingMode:r.viewingMode}));var l=this.presentation.slides.find(function(r){return!e(n(r.viewpoint))});if(l){var u=n(l.viewpoint);return s.reject(new a("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:u,sceneSpatialReference:t,viewingMode:r.viewingMode}))}return s.resolve()},o.prototype._validateVersion=function(e){var r=e.split("."),t=r[0],i=r[1],n=/^\s*\d+\s*$/;if(!t||!t.match||!t.match(n))throw new a("webscene:invalid-version","Expected major version to be a number, but got '${version}'",{version:e});if(!i||!i.match||!i.match(n))throw new a("webscene:invalid-version","Expected minor version to be a number, but got '${version}'",{version:e});var o=parseInt(t,10),p=parseInt(i,10);if(o!==N.major)throw new a("webscene:unsupported-version","Required major webscene version is '"+N.major+"', but got '${version.major}.${version.minor}'",{version:{major:t,minor:i}});return{major:o,minor:p}},o.prototype._validateJSON=function(e,r){void 0===r&&(r=null);var t=this._sanitizeJSON(e,r),i=this._validateVersion(t.version);return t.version=i.major+"."+i.minor,1===i.major&&i.minor<=2&&(t.spatialReference=S.WebMercator.toJSON()),t},o.prototype._sanitizeJSON=function(e,r){void 0===r&&(r=null);var t={version:e.version||"",baseMap:e.baseMap,operationalLayers:e.operationalLayers,authoringApp:e.authoringApp||"",authoringAppVersion:e.authoringAppVersion||"",viewingMode:e.viewingMode||"global",presentation:e.presentation&&V.sanitizeJSON(e.presentation)||{},initialState:e.initialState,spatialReference:e.spatialReference||S.WebMercator.toJSON(),clippingArea:e.clippingArea};return this._makeAbsoluteStyleUrls(t,r),t},o.prototype._forEachSymbolResourceUrl=function(e,r){if(!Array.isArray(e.operationalLayers))return!1;var t=!1,i=function(e,i){var n=e[i];if(n){var o=r(n);o!==n&&(e[i]=o,t=!0)}},n=function(e,r){e&&e.styleUrl&&i(e,"styleUrl"),e&&e.symbolLayers&&e.symbolLayers.some(function(e){return e.resource&&e.resource.href&&c.isAbsolute(e.resource.href)})&&(t=!0)};return e.operationalLayers.forEach(function(e){var t=e.layerDefinition&&e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.renderer;if(t)switch(t.type){case"simple":var o=t;n(o.symbol,r);break;case"uniqueValue":var a=t;i(a,"styleUrl"),n(a.defaultSymbol,r),Array.isArray(a.uniqueValueInfos)&&a.uniqueValueInfos.forEach(function(e){n(e.symbol,r)});break;case"classBreaks":var p=t;n(p.defaultSymbol,r),Array.isArray(p.classBreakInfos)&&p.classBreakInfos.forEach(function(e){n(e.symbol,r)})}}),t},o.prototype._makeAbsoluteStyleUrls=function(e,r){return r?this._forEachSymbolResourceUrl(e,function(e){return c.makeAbsolute(e,r,{preserveProtocolRelative:!0})}):!1},o.prototype._makeRelativeStyleUrls=function(e,r){return r?this._forEachSymbolResourceUrl(e,function(e){return c.makeRelative(e,r)}):!1},o.prototype._updateTypeKeywords=function(e){"local"===this.initialViewProperties.viewingMode?e.typeKeywords?-1===e.typeKeywords.indexOf(J)&&e.typeKeywords.push(J):e.typeKeywords=[J]:"global"===this.initialViewProperties.viewingMode&&e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(function(e){return e!==J})),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(function(e,r,t){return t.indexOf(e)===r}))},o.fromJSON=function(e){return new this({resourceInfo:e})},o.VERSION=N,i([j.property({json:{writeAlways:!0,writeNull:!0}})],o.prototype,"basemap",void 0),i([j.read("basemap",["baseMap"])],o.prototype,"readBasemap",null),i([j.write("basemap")],o.prototype,"writeBasemap",null),i([j.property({type:A,json:{writeAlways:!0}}),j.cast(b.cast)],o.prototype,"clippingArea",void 0),i([j.read("clippingArea")],o.prototype,"readClippingArea",null),i([j.write("clippingArea")],o.prototype,"writeClippingArea",null),i([j.property({type:Boolean,json:{writeAlways:!0}})],o.prototype,"clippingEnabled",void 0),i([j.read("clippingEnabled",["clippingArea"])],o.prototype,"readClippingEnabled",null),i([j.write("clippingEnabled")],o.prototype,"writeClippingEnabled",null),i([j.property({json:{writeAlways:!0}})],o.prototype,"layers",void 0),i([j.write("layers")],o.prototype,"writeLayers",null),i([j.property({readOnly:!0,json:{writeAlways:!0,writeNull:!0}})],o.prototype,"sourceVersion",void 0),i([j.read("sourceVersion",["version"])],o.prototype,"readSourceVersion",null),i([j.write("sourceVersion")],o.prototype,"writeSourceVersion",null),i([j.property({type:String,json:{writeAlways:!0,writeNull:!0}})],o.prototype,"authoringApp",null),i([j.write("authoringApp")],o.prototype,"writeAuthoringApp",null),i([j.property({type:String,json:{writeAlways:!0,writeNull:!0}})],o.prototype,"authoringAppVersion",null),i([j.write("authoringAppVersion")],o.prototype,"writeAuthoringAppVersion",null),i([j.property({type:V,json:{writeAlways:!0}})],o.prototype,"presentation",void 0),i([j.write("presentation")],o.prototype,"writePresentation",null),i([j.property({type:L,json:{writeAlways:!0}})],o.prototype,"initialViewProperties",void 0),i([j.read("initialViewProperties",["initialState.environment","spatialReference","viewingMode","initialState.viewpoint"])],o.prototype,"readInitialViewProperties",null),i([j.write("initialViewProperties")],o.prototype,"writeInitialViewProperties",null),i([j.property({type:_})],o.prototype,"portalItem",void 0),i([j.property()],o.prototype,"resourceInfo",void 0),i([n(0,j.cast(_))],o.prototype,"saveAs",null),o=i([j.subclass("esri.WebScene")],o)}(j.declared(U(),u,l));return x});