// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["dojo/_base/lang","dojo/sniff","dojo/number","dojo/Deferred","dstore/Csv","../../../core/Accessor","../../../core/Error","../../../core/Promise","../../../core/urlUtils","../../../core/promiseUtils","../../../geometry/Extent","../../support/Field","../../../tasks/support/FeatureSet","../../../request"],function(e,t,i,r,n,l,s,a,o,d,u,f,h,c){var m=["small-integer","integer","single","double","long"],y=["lat","latitude","y","ycenter","latitude83","latdecdeg","POINT-Y"],p=["lon","lng","long","longitude","x","xcenter","longitude83","longdecdeg","POINT-X"],g=[","," ",";","|","	"],F=l.createSubclass([a],{properties:{parsedUrl:{get:function(){return this.url?o.urlToObject(this.url):null}},delimiter:null,fields:[],latitudeField:null,longitudeField:null,layerDefinition:null,outFields:null,url:null},initialize:function(){this.addResolvingPromise(this._fetchCSV())},queryFeatures:function(e){return d.resolve(h.fromJSON(this._featureSetJSON))},_updateUrl:function(e){e&&(this.url=this.url.replace(/^http:/i,"https:"))},_fetchCSV:function(){return c(this.parsedUrl.path,{query:this.parsedUrl.query,responseType:"text"}).then(function(e){return this._updateUrl(e.ssl),this._processCSV(e.data)}.bind(this))},_isValidDate:function(e,i){if(!e||"[object Date]"!==Object.prototype.toString.call(e)||isNaN(e.getTime()))return!1;var r=!0;if(t("chrome")&&/\d+\W*$/.test(i)){var n=i.match(/[a-zA-Z]{2,}/);if(n){for(var l=!1,s=0,a=n.length,o=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!l&&a>=s&&!(l=!o.test(n[s]));)s++;r=!l}}return r},_getCSVExtent:function(e){var t;return e.forEach(function(e){e.geometry&&(t?(t.xmin=Math.min(t.xmin,e.geometry.x),t.ymin=Math.min(t.ymin,e.geometry.y),t.xmax=Math.max(t.xmax,e.geometry.x),t.ymax=Math.max(t.ymax,e.geometry.y)):t=new u(e.geometry.x,e.geometry.y,e.geometry.x,e.geometry.y))}),t&&t.width<=0&&t.height<=0&&(t=null),t},_readFirstLine:function(t){var i=t.indexOf("\n");return e.trim(t.substr(0,i))},_detectDelimiter:function(e){if(!this.delimiter){var t=0,i="";g.forEach(function(r){var n=e.split(r).length;n>t&&(t=n,i=r)}),this.delimiter=i}},_readFieldNames:function(e){return e.split(this.delimiter)},_createLayerDefinition:function(e){this.layerDefinition||(this.layerDefinition={name:"csv",geometryType:"esriGeometryPoint",fields:[]}),this.fields&&(this.layerDefinition.fields=this.fields.map(function(e){return e.toJSON()}));var t=this.layerDefinition.fields;if(!this.layerDefinition.objectIdField){for(var i=0;i<t.length;i++)if("esriFieldTypeOID"===t[i].type){this.layerDefinition.objectIdField=t[i].name;break}this.layerDefinition.objectIdField||(t.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1}),this.layerDefinition.objectIdField="__OBJECTID")}e.forEach(function(e){t.some(function(t){return e===t.name})||t.push({name:e,alias:e,type:e===this.latitudeField||e===this.longitudeField?"esriFieldTypeDouble":"esriFieldTypeString"})},this)},_getCoordinateFields:function(e){var t,i;e.forEach(function(e){var r;r=y.indexOf(e.toLowerCase()),-1===r||t||(t=e),r=p.indexOf(e.toLowerCase()),-1===r||i||(i=e)}),this.latitudeField=this.latitudeField||t,this.longitudeField=this.longitudeField||i},_createFeatureSet:function(e){var t=[],r=[],l=[],s=this.latitudeField,a=this.longitudeField,o=this.fields.filter(function(e){return e.name!==this.layerDefinition.objectIdField},this).map(function(e){return e.name});this.fields.forEach(function(e){"date"===e.type?r.push(e.name):m.indexOf(e.type)>-1&&l.push(e.name)});var d;-1===this.outFields.indexOf("*")&&(d=this.outFields);var u=new n;u.delimiter=this.delimiter,u.fieldNames=o,u.newline="\n";var f=u.parse(e),h=0;f.shift(),f.forEach(function(e){for(var n in e)if(n===s||n===a||!d||d.indexOf(n)>-1){if(r.indexOf(n)>-1){var o=new Date(e[n]);e[n]=this._isValidDate(o,e[n])?o.getTime():null}else if(l.indexOf(n)>-1){var u=i.parse(e[n]);n!==s&&n!==a||!(isNaN(u)||Math.abs(u)>181)||(u=parseFloat(e[n])),isNaN(u)?e[n]=null:e[n]=u}}else delete e[n];var f=e[s],c=e[a];e[this.layerDefinition.objectIdField]=h,h++;var m={attributes:e};null===c||null===f||isNaN(f)||isNaN(c)||(d&&-1===d.indexOf(s)&&delete e[s],d&&-1===d.indexOf(a)&&delete e[a],m.geometry={x:c,y:f}),t.push(m)},this),this._featureSetJSON={features:t,geometryType:"esriGeometryPoint",spatialReference:{wkid:4326}}},_processCSV:function(e){var t=new r,i=this._readFirstLine(e);if(!i)return t.reject(new s("CSVSource","CSV is empty"));if(this._detectDelimiter(i),!this.delimiter)return t.reject(new s("CSVSource","Unable to detect the delimiter from CSV"));var n=this._readFieldNames(i);if(this._getCoordinateFields(n),!this.latitudeField||!this.longitudeField)return t.reject(new s("CSVSource","Unable to identify latitudeField and/or longitudeField from CSV"));this._createLayerDefinition(n),this.fields=this.layerDefinition.fields.map(function(e){return f.fromJSON(e)},this),this._createFeatureSet(e);var l=this._getCSVExtent(this._featureSetJSON.features);return l&&(this.layerDefinition.extent=l.toJSON()),t.resolve()}});return F});