// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["require","exports","dojo/_base/window","dojo/_base/lang","dojo/_base/url","dojo/io-query","../config","./lang","./sniff","./Logger","./Error"],function(r,e,t,n,i,o,u,a,l,s,p){function f(r){var e={path:null,query:null},t=new i(r),n=r.indexOf("?");return null===t.query?e.path=r:(e.path=r.substring(0,n),e.query=o.queryToObject(t.query)),t.fragment&&(e.hash=t.fragment,null===t.query&&(e.path=e.path.substring(0,e.path.length-(t.fragment.length+1)))),e}function c(r,e){void 0===r&&(r=!1),void 0===e&&(e=!0);var t,n=J.proxyUrl;if("string"==typeof r){t=B(r);var i=x(r);i&&(n=i.proxyUrl)}else t=!!r;if(!n)throw H.warn(K),new p("urlutils:proxy-not-set",K);var o;if(t&&e&&z()){var u=_(n);q(u)&&(n=u,o=1)}var a=f(n);return a._xo=o,a}function h(r){var e,t,i=x(r);if(i){var u=v(i.proxyUrl);e=u.path,t=u.query?o.queryToObject(u.query):null}else if(J.forceProxy){var u=c();e=u.path,t=u.query}if(e){var a=f(r);r=e+"?"+a.path;var l=o.objectToQuery(n.mixin(t||{},a.query));l&&(r=r+"?"+l)}return r}function v(r){var e=r.indexOf("?");return-1!==e?(Y.path=r.slice(0,e),Y.query=r.slice(e+1)):(Y.path=r,Y.query=null),Y}function g(r){return r=v(r).path,r=D(r),r=E(r,!0),r=r.toLowerCase()}function d(r){for(var e={proxyUrl:r.proxyUrl,urlPrefix:g(r.urlPrefix)},t=J.proxyRules,n=e.urlPrefix,i=t.length,o=0;o<t.length;o++){var u=t[o].urlPrefix;if(0===n.indexOf(u)){if(n.length===u.length)return-1;i=o;break}0===u.indexOf(n)&&(i=o+1)}return t.splice(i,0,r),i}function x(r){for(var e=J.proxyRules,t=g(r),n=0;n<e.length;n++)if(0===t.indexOf(e[n].urlPrefix))return e[n]}function U(r,e){return r=y(r),e=y(e),E(r)===E(e)}function y(r){r=P(r);var e=r.indexOf("/sharing");return e>0?r.substring(0,e):r.replace(/\/+$/,"")}function m(r,e,t){void 0===t&&(t=!1);var n=Q(r),i=Q(e);return t||n.scheme===i.scheme?n.host.toLowerCase()===i.host.toLowerCase()&&n.port===i.port:!1}function q(r){if(l("esri-phonegap"))return!0;if(!l("esri-cors"))return!1;var t=J.corsEnabledServers||[];"string"==typeof r&&(r=S(r)?Q(r):e.appUrl);for(var n=0;n<t.length;n++)for(var i=O(t[n]),o=0;o<i.length;o++)if(m(r,i[o]))return!0;return!1}function O(r){return e.corsServersUrlCache[r]||(k(r)||L(r)?e.corsServersUrlCache[r]=[new i(w(r))]:e.corsServersUrlCache[r]=[new i("http://"+r),new i("https://"+r)]),e.corsServersUrlCache[r]}function w(r,t,n){return void 0===t&&(t=e.appBaseUrl),L(r)?n&&n.preserveProtocolRelative?r:"file"===e.appUrl.scheme?"https:"+r:e.appUrl.scheme+":"+r:k(r)?r:C("/"===r[0]?A(t):t,r)}function b(r,t){if(void 0===t&&(t=e.appBaseUrl),!S(r))return r;for(var n=P(r),i=n.toLowerCase(),o=P(t).toLowerCase().replace(/\/+$/,""),u=function(r,e,t){return t=r.indexOf(e,t),-1===t?r.length:t},a=u(i,"/",i.indexOf("//")+2),l=-1;i.slice(0,a+1)===o.slice(0,a)+"/"&&(l=a+1,a!==i.length);)a=u(i,"/",a+1);if(-1===l)return r;r=n.slice(l);var s=o.slice(l-1).replace(/[^\/]+/g,"").length;if(s>0)for(var p=0;s>p;p++)r="../"+r;else r="./"+r;return r}function P(r){return r=w(r),r=W(r),r=I(r)}function C(){for(var r=[],e=0;e<arguments.length;e++)r[e-0]=arguments[e];if(r&&r.length){var t=[];if(S(r[0])){var n=r[0],i=n.indexOf("//");t.push(n.slice(0,i+1)),$(r[0])&&(t[0]+="/"),r[0]=n.slice(i+2)}else"/"===r[0][0]&&t.push("");for(var o=r.reduce(function(r,e){return r.concat(e.split("/"))},[]),u=0;u<o.length;u++){var a=o[u];".."===a&&t.length>0?t.pop():!a||"."===a&&0!==t.length||t.push(a)}return t.join("/")}}function j(r){if(R(r))return null;var e=r.indexOf("://");if(-1===e&&L(r))e=2;else{if(-1===e)return null;e+=3}var t=r.indexOf("/",e);return-1===t?r:r.slice(0,t)}function S(r){return L(r)||k(r)}function R(r){return"data:"===r.slice(0,5)}function L(r){return r&&"/"===r[0]&&"/"===r[1]}function k(r){return M.test(r)}function B(r){return/^\s*https:/i.test(r)||L(r)&&"https"===e.appUrl.scheme}function T(r){return N.test(r)||L(r)&&"http"===e.appUrl.scheme}function $(r){return V.test(r)}function _(r){return L(r)?"https:"+r:r.replace(N,"https:")}function z(){return"https"===e.appUrl.scheme}function E(r,e){return void 0===e&&(e=!1),L(r)?r.slice(2):(r=r.replace(M,""),e&&r.length>1&&"/"===r[0]&&"/"===r[1]&&(r=r.slice(2)),r)}function A(r){var e=r.indexOf("//"),t=r.indexOf("/",e+2);return-1===t?r:r.slice(0,t)}function D(r){return r&&"/"===r[r.length-1]?r:r+"/"}function I(r){return r.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function W(r){var t=u.request.httpsDomains;if(!T(r)||!z()&&!$(e.appBaseUrl))return r;var n,i=r.indexOf("/",7);return n=-1===i?r:r.slice(0,i),(a.endsWith(n,""+e.appUrl.host+(null!=e.appUrl.port?":"+e.appUrl.port:""))||t&&t.some(function(r){return a.endsWith(n,r)}))&&(r=_(r)),r}function Q(r){return"string"==typeof r?new i(w(r)):(r.scheme||(r.scheme=e.appUrl.scheme),r)}function X(r,e){var t=e&&e.url&&e.url.path;return r&&t?w(r,t,{preserveProtocolRelative:!0}):r}function F(r,e){if(!r)return r;r=w(r);var t=e&&e.url&&e.url.path;return t&&(r=b(r,t)),r}var G=t.global,H=s.getLogger("esri.core.urlUtils"),J=u.request,K="esri/config: esriConfig.request.proxyUrl is not set. If making a request to a CORS-enabled\n server, please push the domain into esriConfig.request.corsEnabledServers.",M=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,N=/^\s*http:/i,V=/^\s*file:/i;e.appUrl=new i(G.location),e.corsServersUrlCache={},e.appBaseUrl=function(){var r=e.appUrl.path,t=r.substring(0,r.lastIndexOf(r.split("/")[r.split("/").length-1])),n=e.appUrl.scheme+"://"+e.appUrl.host+(null!=e.appUrl.port?":"+e.appUrl.port:"");return""+n+t}(),e.urlToObject=f,e.getProxyUrl=c,e.addProxy=h;var Y={path:"",query:""};e.addProxyRule=d,e.getProxyRule=x,e.hasSamePortal=U,e.hasSameOrigin=m,e.canUseXhr=q,e.makeAbsolute=w,e.makeRelative=b,e.normalize=P,e.join=C,e.getOrigin=j,e.isAbsolute=S,e.isDataProtocol=R,e.read=X,e.write=F});