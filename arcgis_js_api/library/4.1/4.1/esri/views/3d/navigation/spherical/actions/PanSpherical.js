// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["./ActionSpherical","../../mixins/PanMixin","../../../lib/glMatrix","../../../support/earthUtils","../../../support/mathUtils","../../../webgl-engine/lib/Util","../../ContinuousAction","../../NavigationConstants"],function(t,i,e,n,a,s,r,o){var h=e.vec2d,u=e.vec3d,c=e.vec4d,d=e.mat4d,P=u.create(),_=u.create(),l=u.create(),m=u.create(),g=u.create(),p=u.create(),A=d.create(),C=o.Pan.Mode,v=o.Pan.Direction,R=o.Pan.Vertical,S=o.Pan.Momentum,y=t.createSubclass([i],{declaredClass:"esri.views.3d.navigation.spherical.actions.PanSpherical",constructor:function(){this._panMode=0,this._lastPanActionPtr=0,this._lastPanActions=[],this._plane=c.create(),this._isMomentumPanning=!1,this.continuous=new r;for(var t=0;t<S.BUFFER_SIZE;t++)this._lastPanActions[t]={point:u.create(),pointScreen:h.create(),time:0}},begin:function(t,i){this.inherited(arguments),this.pickPointInScreen(t,this._navPickPoint)?this._navSphereRadius=u.length(this._navPickPoint):(this._navSphereRadius=u.length(this.targetCamera.center),this._navSphereRadius<.9*n.earthRadius&&(this._navSphereRadius=n.earthRadius),this.createPickRay(t,t,this.currentCamera.viewMatrix,P,_),u.subtract(_,this.currentCamera.eye),this.intersectManifold(this.currentCamera.eye,_,this._navSphereRadius-n.earthRadius,this._navPickPoint)||this.closestPointOnSphereSilhouette(this.currentCamera.eye,P,this._navSphereRadius,this._navPickPoint));var e=!1,a=this.renderCoordsHelper.getAltitude(this.currentCamera.eye);if(a<R.ELEVATION_THRESHOLD)if(this._navSphereRadius>u.length(this.currentCamera.eye))e=!0;else{u.normalize(u.subtract(this.targetCamera.eye,this._navPickPoint,l));var r=Math.abs(.5*Math.PI-Math.acos(u.dot(this._navPickPoint,l)/u.length(this._navPickPoint)));e=r<R.ANGLE_THRESHOLD}e?(this._panMode=C.VERTICAL,u.normalize(u.subtract(this.targetCamera.eye,this.targetCamera.center,l)),this.updatePlane(this._navPickPoint,l)):(this._panMode=C.HORIZONTAL,this._addToLastPanActions(void 0===i?s.performance.now():i,this._navPickPoint,t)),h.set(t,this._dragLastPoint),h.set(t,this._dragBeginPoint),this._mouseDownCamera.copyFrom(this.targetCamera)},update:function(t,i){if(this._panMode===C.HORIZONTAL){if(this._navSphereRadius<=0)return;this.createPickRay(t,this._dragBeginPoint,this._mouseDownCamera.viewMatrix,P,_),u.subtract(_,this._mouseDownCamera.eye),this.intersectManifold(this._mouseDownCamera.eye,_,this._navSphereRadius-n.earthRadius,this._targetOnSphere)||this.closestPointOnSphereSilhouette(this._mouseDownCamera.eye,P,this._navSphereRadius,this._targetOnSphere),this.rotateCameraWithPointsOnSphere(this._navPickPoint,this._targetOnSphere,this._mouseDownCamera,this.targetCamera,this._navSphereRadius),this._addToLastPanActions(void 0===i?s.performance.now():i,this._targetOnSphere,t)}else{if(this.createPickRay(this._dragLastPoint,this._dragBeginPoint,this.currentCamera.viewMatrix,P,_),u.subtract(_,P),!s.rayPlane(P,_,this._plane,m))return;if(this.createPickRay(t,this._dragBeginPoint,this.currentCamera.viewMatrix,P,_),u.subtract(_,P),!s.rayPlane(P,_,this._plane,g))return;u.subtract(g,m),u.subtract(this.targetCamera.eye,g),u.subtract(this.targetCamera.center,g),h.set(t,this._dragLastPoint)}this.constrainTargetEyeByElevationAndMoveLookAt(),h.set(t,this._dragLastPoint),this.fixTargetUpVector(),this.targetAndCurrentChanged(),this.inherited(arguments)},end:function(t,i){this._panMode===C.HORIZONTAL&&this._initiateMomentumPanning(t,i),this._navSphereRadius=0,this.inherited(arguments)},_initiateMomentumPanning:function(t,i){var e=h.dist(this._dragLastPoint,t);if(e>0&&this._navSphereRadius>0){this.update(t,i);var n=this._lastPanActionPtr;do if(n=(n-1+S.BUFFER_SIZE)%S.BUFFER_SIZE,this._lastPanActions[this._lastPanActionPtr].time-this._lastPanActions[n].time>1e3*S.INPUT_FILTER)break;while(this._lastPanActionPtr!==n);n++,n%=S.BUFFER_SIZE,n===this._lastPanActionPtr&&(n=(this._lastPanActionPtr-1+S.BUFFER_SIZE)%S.BUFFER_SIZE);var a=.001*(this._lastPanActions[this._lastPanActionPtr].time-this._lastPanActions[n].time);if(a>0){var s=this.rotationFromPointsOnSphere(this._lastPanActions[n].point,this._lastPanActions[this._lastPanActionPtr].point,this._navSphereRadius,this.continuous.direction);this.continuous.velocity=s/a;var r=h.create(),o=h.create();this.normalizeCoordinate(this._lastPanActions[n].pointScreen,r),this.normalizeCoordinate(this._lastPanActions[this._lastPanActionPtr].pointScreen,o);var u=Math.min(h.dist(r,o)/a/S.DURATION_LONG_VEL,1);return this.continuous.timer=S.DURATION_SHORT+u*(S.DURATION_LONG-S.DURATION_SHORT),this._isMomentumPanning=!0,this.animationStarted(),!0}this.currentReachedTarget()}else this.setPoiAuto(t,!0);return!1},beginContinuous:function(t){if(this.inherited(arguments),this.setCurrentToTarget(),0===this.continuous.status&&u.set3(0,0,0,this.continuous.direction),!(this.continuous.status&t)){if(this.continuous.status|=t,t&(v.LEFT|v.RIGHT|v.FORWARD|v.BACKWARD))this._computePanAxis(t,p),u.add(this.continuous.direction,p);else{var i=this.continuous.status&(v.UP|v.DOWN);i===v.UP?this.continuous.radiusChange=1:i===v.DOWN?this.continuous.radiusChange=-1:this.continuous.radiusChange=0}this.continuous.velocity=this._computePanVelocity()}this.continuous.timer=0},updateContinuous:function(t){if(this.continuous){if(!this.continuous.active)return void(this._isMomentumPanning&&(this._isMomentumPanning=!1,this.targetAndCurrentChanged(!0)));var i=this.continuous.step(t),e=u.dot(this.continuous.direction,this.continuous.direction)>.01;if(Math.abs(this.continuous.radiusChange)>0){var n=1+i*this.continuous.radiusChange;u.scale(this.targetCamera.center,n),u.scale(this.targetCamera.eye,n),this.continuous.velocity=this._computePanVelocity(),e||(this.constrainTargetEyeByElevationAndMoveLookAt(),this.targetAndCurrentChanged(!0))}e&&(d.identity(A),d.rotate(A,i,this.continuous.direction),d.multiplyVec3(A,this.targetCamera.eye),d.multiplyVec3(A,this.targetCamera.center),d.multiplyVec3(A,this.targetCamera.up),this.constrainTargetEyeByElevationAndMoveLookAt(),this.fixTargetUpVector(),this.targetAndCurrentChanged())}},endContinuous:function(t){if(this.continuous.status&=~t,0===this.continuous.status)this.continuous.stop(),this.continuous.radiusChange=0;else if(t&(v.LEFT|v.RIGHT|v.FORWARD|v.BACKWARD))this._computePanAxis(t,p),u.subtract(this.continuous.direction,p),u.length(this.continuous.direction)<.01&&u.set3(0,0,0,this.continuous.direction);else{var i=this.continuous.status&(v.UP|v.DOWN);i==v.UP?this.continuous.radiusChange=1:i==v.DOWN?this.continuous.radiusChange=-1:this.continuous.radiusChange=0}this.inherited(arguments)},_computePanAxis:function(t,i){u.subtract(this.targetCamera.center,this.targetCamera.eye,i),u.cross(i,this.targetCamera.up),(t===v.LEFT||t===v.RIGHT)&&(u.normalize(i),u.cross(i,this.targetCamera.center)),(t===v.RIGHT||t===v.FORWARD)&&u.negate(i),u.normalize(i)},_computePanVelocity:function(){var t=.5*Math.abs(u.length(this.targetCamera.eye)-n.earthRadius);return t=a.clamp(t,1,2*n.earthRadius),a.acos(1-t*t/(2*n.earthRadius*n.earthRadius))},_addToLastPanActions:function(t,i,e){this._lastPanActionPtr=(this._lastPanActionPtr+1)%5,this._lastPanActions[this._lastPanActionPtr].time=t,u.set(i,this._lastPanActions[this._lastPanActionPtr].point),h.set(e,this._lastPanActions[this._lastPanActionPtr].pointScreen)},updatePlane:function(t,i){c.set4(i[0],i[1],i[2],-u.dot(i,t),this._plane)}});return y});