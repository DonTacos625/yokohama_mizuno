// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["require","exports","dojo/_base/lang","../../../../core/Logger","../../../../core/Error"],function(e,t,r,n,a){function u(e,t,r){for(var n="",u=0,o=0,i=0,f=0;r>u;)if(o=e[t+u],128>o)n+=String.fromCharCode(o),u++;else if(o>191&&224>o){if(u+1>=r)throw new a("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");i=e[t+u+1],n+=String.fromCharCode((31&o)<<6|63&i),u+=2}else{if(u+2>=r)throw new a("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");i=e[t+u+1],f=e[t+u+2],n+=String.fromCharCode((15&o)<<12|(63&i)<<6|63&f),u+=3}return n}function o(e,r){for(var n={byteOffset:0,byteCount:0,fields:Object.create(null)},a=0,u=0;u<r.length;u++){var o=r[u],i=o.valueType||o.type,f=t.valueType2ArrayBufferReader[i];n.fields[o.property]=f(e,a),a+=t.valueType2TypedArrayClassMap[i].BYTES_PER_ELEMENT}return n.byteCount=a,n}function i(e,t,r){var n,o,i=[],f=0;for(o=0;e>o;o+=1){if(n=t[o],n>0){if(i.push(u(r,f,n-1)),0!==r[f+n-1])throw new a("string-array-error","Invalid string array: missing null termination.")}else i.push(null);f+=n}return i}function f(e,r){var n=t.valueType2TypedArrayClassMap[r.valueType];return new n(e,r.byteOffset,r.count*r.valuesPerElement)}function l(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}function s(e,t,n){for(var u=null!=t.header?o(e,t.header):{byteOffset:0,byteCount:0,fields:{count:n}},i={header:u,byteOffset:u.byteCount,byteCount:0,entries:Object.create(null)},f=u.byteCount,l=0;l<t.ordering.length;l++){var s=t.ordering[l],y=r.clone(t[s]);if(y.count=u.fields.count,"String"===y.valueType){if(y.byteOffset=f,y.byteCount=u.fields[s+"ByteCount"],"UTF-8"!==y.encoding)throw new a("unsupported-encoding","Unsupported String encoding.",{encoding:y.encoding})}else{if(!b(y.valueType))throw new a("unsupported-value-type","Unsupported binary valueType",{valueType:y.valueType});var d=v(y.valueType);f+=f%d!==0?d-f%d:0,y.byteOffset=f,y.byteCount=d*y.valuesPerElement*y.count}f+=y.byteCount,i.entries[s]=y}return i.byteCount=f-i.byteOffset,i}function y(e,t,r){if(t!==e&&g.error("Invalid "+r+" buffer size\n expected: "+e+", actual: "+t+")"),e>t)throw new a("buffer-too-small","Binary buffer is too small",{expectedSize:e,actualSize:t})}function d(e,t,n){var a=o(e,t.header),u=a.byteCount,i={header:a,byteOffset:a.byteCount,byteCount:0,vertexAttributes:r.clone(t.vertexAttributes)},f=i.vertexAttributes;n||null==f.region||delete f.region;for(var l=0;l<t.ordering.length;l++){var s=t.ordering[l];null!=f[s]&&(f[s].byteOffset=u,f[s].count=a.fields.vertexCount,u+=v(f[s].valueType)*f[s].valuesPerElement*a.fields.vertexCount)}if(t.faces){i.faces=r.clone(t.faces);for(var d=i.faces,l=0;l<t.ordering.length;l++)name=t.ordering[l],d[name].byteOffset=u,d[name].count=a.fields.vertexCount;u+=v(d[name].valueType)*d[name].valuesPerElement*a.fields.vertexCount}if(t.featureAttributes&&t.featureAttributeOrder&&a.fields.featureCount){i.featureAttributes=r.clone(t.featureAttributes);for(var c=i.featureAttributes,l=0;l<t.featureAttributeOrder.length;l++){name=t.featureAttributeOrder[l],c[name].byteOffset=u,c[name].count=a.fields.featureCount;var b=v(c[name].valueType);"UInt64"===c[name].valueType&&(b=8),u+=b*c[name].valuesPerElement*a.fields.featureCount}}return y(u,e.byteLength,"geometry"),i.byteCount=u-i.byteOffset,i}function c(e,t,r){e["attributeByteCounts "]&&!e.attributeByteCounts&&(g.error("Warning: Trailing space in 'attributeByteCounts '."),e.attributeByteCounts=e["attributeByteCounts "]),"ObjectIds"===e.ordering[0]&&e.hasOwnProperty("objectIds")&&(g.error("Warning: Case error in objectIds"),e.ordering[0]="objectIds");var n=s(t,e,r),u=n.byteOffset+n.byteCount;y(u,t.byteLength,"attribute");var o=n.entries.attributeValues||n.entries.objectIds;if(o){if("String"===o.valueType){var d=n.entries.attributeByteCounts,c=f(t,d),b=l(t,o);return i(d.count,c,b)}return f(t,o)}throw new a("bad-attribute-storage-info","Bad attributeStorageInfo specification.")}function b(e){return t.valueType2TypedArrayClassMap.hasOwnProperty(e)}function v(e){return b(e)&&t.valueType2TypedArrayClassMap[e].BYTES_PER_ELEMENT}var g=n.getLogger("esri.layers.SceneService");t.readHeader=o,t.readStringArray=i,t.createTypedView=f,t.createRawView=l,t.createAttributeDataIndex=s,t.createGeometryDataIndex=d,t.readBinaryAttribute=c,t.valueType2TypedArrayClassMap={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},t.valueType2ArrayBufferReader={Float32:function(e,t){return new DataView(e,0).getFloat32(t,!0)},Float64:function(e,t){return new DataView(e,0).getFloat64(t,!0)},UInt8:function(e,t){return new DataView(e,0).getUint8(t)},Int8:function(e,t){return new DataView(e,0).getInt8(t)},UInt16:function(e,t){return new DataView(e,0).getUint16(t,!0)},Int16:function(e,t){return new DataView(e,0).getInt16(t,!0)},UInt32:function(e,t){return new DataView(e,0).getUint32(t,!0)},Int32:function(e,t){return new DataView(e,0).getInt32(t,!0)}},t.isValueType=b,t.getBytesPerValue=v});