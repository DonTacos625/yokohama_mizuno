// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["dojo/_base/array","dojo/_base/lang","dojo/Deferred","../../config","../Polyline","../Polygon","./webMercatorUtils","./jsonUtils"],function(e,r,n,t,i,o,a,s){function f(e,r){return Math.ceil((e-r)/(2*r))}function c(e,r){var n,t,i,o=e.paths||e.rings,a=o.length;for(n=0;a>n;n++){var s=o[n];for(i=s.length,t=0;i>t;t++){var f=e.getPoint(n,t);e.setPoint(n,t,f.clone().offset(r,0))}}return e}function u(r,n){if(!(r instanceof i||r instanceof o)){var t="_straightLineDensify: the input geometry is neither polyline nor polygon";throw console.error(t),new Error(t)}var a,s=r instanceof i,f=s?r.paths:r.rings,c=[];return e.forEach(f,function(e){c.push(a=[]),a.push([e[0][0],e[0][1]]);var r,t,i,o,s,f,u,l,h,p,g,v;for(s=0;s<e.length-1;s++){if(r=e[s][0],t=e[s][1],i=e[s+1][0],o=e[s+1][1],u=Math.sqrt((i-r)*(i-r)+(o-t)*(o-t)),l=(o-t)/u,h=(i-r)/u,p=u/n,p>1){for(f=1;p-1>=f;f++){var m=f*n;g=h*m+r,v=l*m+t,a.push([g,v])}var d=(u+Math.floor(p-1)*n)/2;g=h*d+r,v=l*d+t,a.push([g,v])}a.push([i,o])}}),s?new i({paths:c,spatialReference:r.spatialReference}):new o({rings:c,spatialReference:r.spatialReference})}function l(e,r,n){var t=1e6;if(r){var i=u(e,t);e=a.webMercatorToGeographic(i,!0)}return n&&(e=c(e,n)),e}function h(e,r,n){var t,i=e.x||e[0];return i>r?(t=f(i,r),e.x?e=e.clone().offset(t*(-2*r),0):e[0]=i+t*(-2*r)):n>i&&(t=f(i,n),e.x?e=e.clone().offset(t*(-2*n),0):e[0]=i+t*(-2*n)),e}function p(r,n){var t=-1;return e.forEach(n.cutIndexes,function(i,o){var a=n.geometries[o],s=a.rings||a.paths;e.forEach(s,function(r,n){e.some(r,function(e){if(e[0]<180)return!0;var t,i,o=0,s=r.length;for(t=0;s>t;t++)i=r[t][0],o=i>o?i:o;o=Number(o.toFixed(9));var c,u=f(o,180),l=-360*u,h=r.length;for(c=0;h>c;c++){var p=a.getPoint(n,c);a.setPoint(n,c,p.clone().offset(l,0))}return!0})}),i===t?a.rings?e.forEach(a.rings,function(e){r[i]=r[i].addRing(e)}):e.forEach(a.paths,function(e){r[i]=r[i].addPath(e)}):(t=i,r[i]=a)}),r}function g(r,u,g,v){var m=new n;m.then(g,v),u=u||t.geometryService;var d,y,x,b,_,E,w,j,M=[],O=[],P=0;e.forEach(r,function(r){if(!r)return void M.push(r);if(d||(d=r.spatialReference,y=d._getInfo(),x=d.isWebMercator,b=x?20037508.342788905:180,_=x?-20037508.342788905:-180,E=x?102100:4326,w=new i({paths:[[[b,_],[b,b]]],spatialReference:{wkid:E}}),j=new i({paths:[[[_,_],[_,b]]],spatialReference:{wkid:E}})),!y)return void M.push(r);var n=s.fromJSON(r.toJSON()),t=r.extent;if("point"===r.type)M.push(h(n,b,_));else if("multipoint"===r.type)n.points=e.map(n.points,function(e){return h(e,b,_)}),M.push(n);else if("extent"===r.type){var a=t.clone()._normalize(null,null,y);M.push(a.rings?new o(a):a)}else if(t){var u=f(t.xmin,_),p=u*(2*b);n=0===p?n:c(n,p),t=t.clone().offset(p,0),t.intersects(w)&&t.xmax!==b?(P=t.xmax>P?t.xmax:P,n=l(n,x),O.push(n),M.push("cut")):t.intersects(j)&&t.xmin!==_?(P=t.xmax*(2*b)>P?t.xmax*(2*b):P,n=l(n,x,360),O.push(n),M.push("cut")):M.push(n)}else M.push(n)});for(var R=new i,C=f(P,b),T=-90,z=C;C>0;){var S=-180+360*C;R.addPath([[S,T],[S,-1*T]]),T=-1*T,C--}return O.length>0&&z>0?u?u.cut(O,R,function(n){O=p(O,n);var t=[];e.forEach(M,function(e,n){if("cut"===e){var i=O.shift();r[n].rings&&r[n].rings.length>1&&i.rings.length>=r[n].rings.length?(M[n]="simplify",t.push(i)):M[n]=x===!0?a.geographicToWebMercator(i):i}}),t.length>0?u.simplify(t,function(r){e.forEach(M,function(e,n){"simplify"===e&&(M[n]=x===!0?a.geographicToWebMercator(r.shift()):r.shift())}),m.resolve(M)},function(e){m.reject(e)}):m.resolve(M)},function(e){m.reject(e)}):m.reject(new Error("esri.geometry.normalizeCentralMeridian: 'geometryService' argument is missing.")):(e.forEach(M,function(e,r){if("cut"===e){var n=O.shift();M[r]=x===!0?a.geographicToWebMercator(n):n}}),m.resolve(M)),m.promise}function v(n,t,i,o){var a,s=!1;r.isObject(n)&&n&&(r.isArray(n)?n.length&&(a=n[0]&&n[0].declaredClass,a&&-1!==a.indexOf("Graphic")?(n=e.map(n,function(e){return e.geometry}),s=n.length?!0:!1):a&&-1!==a.indexOf("esri.geometry.")&&(s=!0)):(a=n.declaredClass,a&&-1!==a.indexOf("FeatureSet")?(n=e.map(n.features||[],function(e){return e.geometry}),s=n.length?!0:!1):a&&-1!==a.indexOf("esri.geometry.")&&(s=!0))),s&&t.push({index:i,property:o,value:n})}function m(n,t){var i=[];return e.forEach(t,function(t){var o,a=t.i,s=n[a],f=t.p;if(r.isObject(s)&&s)if(f)if("*"===f[0])for(o in s)s.hasOwnProperty(o)&&v(s[o],i,a,o);else e.forEach(f,function(e){v(r.getObject(e,!1,s),i,a,e)});else v(s,i,a)}),i}function d(n,t){var i=0,o={};return e.forEach(t,function(e){var t=e.index,a=e.property,s=e.value,f=s.length||1,c=n.slice(i,i+f);r.isArray(s)||(c=c[0]),i+=f,delete e.value,a?(o[t]=o[t]||{},o[t][a]=c):o[t]=c}),o}function y(n){var t=r.isObject(n)?n.prototype:r.getObject(n+".prototype");e.forEach(t.__msigns,function(r){var n=t[r.n];t[r.n]=function(){var t,i=this,o=[];for(t=0;t<r.c;t++)o[t]=arguments[t];var a={};o.push(a);var s,f,c=[];return i.normalization&&!i._isTable&&(s=m(o,r.a),e.forEach(s,function(e){c=c.concat(e.value)}),c.length&&(f=g(c))),f?f.then(function(e){return a.assembly=d(e,s),n.apply(i,o)}):n.apply(i,o)}})}var x={normalizeCentralMeridian:g,_foldCutResults:p,_prepareGeometryForCut:l,_offsetMagnitude:f,_pointNormalization:h,_updatePolyGeometry:c,_straightLineDensify:u,_createWrappers:y,_disassemble:m,_addToBucket:v,_reassemble:d};return x});