// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["../../../Color","../../../request","../../../renderers/SimpleRenderer","../../../renderers/ClassBreaksRenderer","../../../renderers/UniqueValueRenderer","../../../core/Accessor","../../../core/HandleRegistry","../../../core/Logger","../../../core/arrayUtils","../../../../esri/layers/support/ExportImageParameters","./colorRampUtils","./sizeRampUtils","dojo/Deferred","dojo/promise/all","dojo/_base/lang"],function(e,t,n,l,r,i,a,s,o,u,c,h,d,f,y){var m="http://utility.arcgis.com/sharing/tools/legend",g=s.getLogger("esri.widgets.Legend.support.ActiveLayerInfo");return i.createSubclass({declaredClass:"esri.widgets.Legend.support.ActiveLayerInfo",constructor:function(){this._legendResponse=null,this._handles=new a;var e=this.watch("tearingDown",function(){this.destroy()}.bind(this));this._handles.add(e,"tearingDown-watcher")},getDefaults:function(){return{legendElements:[]}},destroy:function(){this._handles.destroy(),this._handles=null,this._legendResponse=null},properties:{layer:null,legendElements:{type:Array},ready:!1,tearingDown:!1,title:null,scale:null,updating:!1,version:{value:0,readOnly:!0,dependsOn:["updating"],get:function(){return this._get("version")+1}},_hasSizeRamp:!1},buildLegendElementsForRenderer:function(){var e=this.layer.renderer,t=this._getVisualVariableLegendElements(e);this._getRendererSymbolTableElement(e).then(function(e){e&&e.infos.length&&this.legendElements.push(e),t&&Array.prototype.push.apply(this.legendElements,t),this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(e){g.warn("error while building activeLayerInfo!",e)}).always(function(){this.updating=!1}.bind(this))},buildLegendElementsForTools:function(){this.layer.sublayers?this._constructLegendElementsForSublayers():this._getLegendLayers().then(function(e){e.forEach(function(e){var t=this._generateSymbolTableElementForLegendLayer(e);t&&t.infos.length&&this.legendElements.push(t)},this),this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(e){g.warn("Request to server for legend has failed!",e)}).always(function(){this.updating=!1}.bind(this))},_getLegendLayers:function(e){var t=e&&e.hasDynamicLayers,n=this._legendResponse;if(!t&&n){var l=new d;return l.resolve(n),l.promise}var r=t?e.dynamicLayers:null;return this._legendRequest(r).then(function(e){var t=e.data.layers;return this._legendResponse=t,t}.bind(this))},_legendRequest:function(e){var n=this.layer,l=n.url,r={f:"json",dynamicLayers:e};if(n.version>=10.01){var i=l.indexOf("?");i>-1?l=l.substring(0,i)+"/legend"+l.substring(i):l+="/legend",n.token&&(l+="?token="+n.token)}else{var a=l.toLowerCase().indexOf("/rest/"),s=n.url.substring(0,a)+n.url.substring(a+5,n.url.length);l=m+"?soapUrl="+window.escape(s)+"&returnbytes=true"}return t(l,{query:r,callbackParamName:"callback"})},_constructLegendElementsForSublayers:function(){this.updating=!0,this.ready=!1,this.legendElements=[],this._handles.remove("sublayers-watcher");var e=new u({layer:this.layer});this._getLegendLayers(e).then(function(e){var t={};e.forEach(function(e){t[e.layerId]=e}),this.legendElements=this._generateLegendElementsForSublayers(this.layer.sublayers,t,this.layer.opacity),this.legendElements.length&&(this.ready=!0)}.bind(this)).otherwise(function(e){g.warn("Request to server for legend has failed!",e)}).always(function(){e.destroy(),this.updating=!1}.bind(this))},_generateLegendElementsForSublayers:function(e,t,n){var l=[];return this._handles.add(e.on("change",this._constructLegendElementsForSublayers.bind(this)),"sublayers-watcher"),e.forEach(function(e){var r=e.watch("renderer, opacity, title, visible",this._constructLegendElementsForSublayers.bind(this));if(this._handles.add(r,"sublayers-watcher"),e.visible&&e.legendEnabled){var i=e&&null!=e.opacity?e.opacity:null,a=null!=i?i*n:n,s=this._generateSymbolTableElementForSublayer(e,t,a);s&&s.infos.length&&l.unshift(s)}},this),l},_generateSymbolTableElementForSublayer:function(e,t,n){var l=t[e.id];if(!l&&e.sublayers){var r=this._generateLegendElementsForSublayers(e.sublayers,t,n);return{type:"symbol-table",title:e.title,infos:r}}return this._generateSymbolTableElementForLegendLayer(l,e,n)},_generateSymbolTableElementForLegendLayer:function(e,t,n){if(e){var l=e.layerName,r=t&&t.renderer;if(r){var i=t&&t.title?t.title:this._getRendererTitle(r,this.layer,t);i&&(l&&(i.title=l),l=i)}var a={type:"symbol-table",title:l,infos:[]};if(e.legend&&this._isLegendLayerInScale(e,t)){var s=t?this._sanitizeLegendForSublayer(e.legend,t):e.legend;a.infos=s.map(function(t){var l=t.url;if(t.imageData&&t.imageData.length>0)l="data:image/png;base64,"+t.imageData;else{if(0===l.indexOf("http"))return null;l=this.layer.url+"/"+e.layerId+"/images/"+l;var r=this.layer.token;r&&(l+="?token="+r)}return{label:t.label,src:l,opacity:n,width:t.width,height:t.height}},this).filter(function(e){return!!e})}return a.infos.length?a:null}},_sanitizeLegendForSublayer:function(e,t){if(this.layer.version<10.1||0===e.length)return e;var n,l,r=t.renderer,i=e.some(function(e){return e.values});return i&&e.some(function(e,t){return e.values||(n=t,l=e,l.label||(l.label="others")),null!=l}),r?"uniqueValue"===r.type?l&&(e.splice(n,1),e.push(l)):"classBreaks"===r.type&&(l&&e.splice(n,1),e.reverse(),l&&e.push(l)):l&&(e.splice(n,1),e.push(l)),e},_isLegendLayerInScale:function(e,t){var n,l,r=t||this.layer,i=!0;return!r.minScale&&0!==r.minScale||!r.maxScale&&0!==r.maxScale?(0===e.minScale&&r.tileInfo&&(n=r.tileInfo.lods[0].scale),0===e.maxScale&&r.tileInfo&&(l=r.tileInfo.lods[r.tileInfo.lods.length-1].scale)):(n=Math.min(r.minScale,e.minScale)||r.minScale||e.minScale,l=Math.max(r.maxScale,e.maxScale)),(n>0&&n<this.scale||l>this.scale)&&(i=!1),i},_getVisualVariableLegendElements:function(e,t,n){var r=e.visualVariables,i=[],a=[],s=[],o=null!=n?n:this.layer.opacity,u=null;if(!r)return null;if(r.forEach(function(e){"color"===e.type?i.push(e):"opacity"===e.type?a.push(e):"size"===e.type&&s.push(e)}),r=[],Array.prototype.push.apply(r,i),Array.prototype.push.apply(r,a),Array.prototype.push.apply(r,s),0===i.length&&e.isInstanceOf(l)&&e.classBreakInfos&&1===e.classBreakInfos.length){var d=e.classBreakInfos[0];u=d&&d.symbol.color.toRgba()}return r.map(function(n){var l,r=t?t.title:this._getRampTitle(n,this.layer),i=c._getRampBorderColor(e),a=c._getRampOverlayColor(o);return"color"===n.type?l={type:"color-ramp",title:r,borderColor:i,overlayColor:a,infos:c._getRampStops(e,n)}:"opacity"===n.type?l={type:"opacity-ramp",title:r,borderColor:i,overlayColor:a,infos:c._getRampStops(e,n,u)}:"size"===n.type&&(l={type:"size-ramp",title:r,infos:h._getRampStops(e,n,this._getMedianColor(e),this.scale)},this._hasSizeRamp||(this._hasSizeRamp=null!=l.infos&&l.infos.length)),l.infos&&l},this).filter(function(e){return!!e})},_getRendererSymbolTableElement:function(e,t,i){var a=e.visualVariables,s=this._getMedianColor(e),o=null!=i?i:this.layer.opacity,u=e.isInstanceOf(n),c=e.isInstanceOf(l),h=e.isInstanceOf(r),d=u||c||h;return this._loadSymbols(e,d).then(function(e){var n={type:"symbol-table",title:t&&t.title?t.title:this._getRendererTitle(e,this.layer,t),infos:[]};if(c){var l=this._isUnclassedRenderer(e,a),r=!l||!this._hasSizeRamp;if(r){var i=e.classBreakInfos.slice().reverse();n.infos=i.map(function(e){return{label:e.label||(l?null:e.minValue+" - "+e.maxValue),value:[e.minValue,e.maxValue],symbol:this._getAppliedCloneSymbol(e.symbol,s,o)}},this),l&&(n.title=null)}}if(h&&(n.infos=e.uniqueValueInfos.map(function(e){return{label:e.label||e.value,value:e.value,symbol:this._getAppliedCloneSymbol(e.symbol,s,o)}},this)),d){var f=e.label||e.defaultLabel,y=e.symbol||e.defaultSymbol;y&&!l&&n.infos.push({label:u?f:f||"others",symbol:this._getAppliedCloneSymbol(y,s,o)})}return n.infos.length?n:null}.bind(this))},_loadSymbols:function(e,t){var i=new d,a=[];if(!t)return i.reject(),i.promise;if(e=e.clone(),e.isInstanceOf(l)||e.isInstanceOf(r)){var s=e.classBreakInfos||e.uniqueValueInfos;s.forEach(function(e){a.push(this._fetchSymbol(e.symbol).then(function(t){e.symbol=t}))},this)}return a.push(this._fetchSymbol(e.symbol||e.defaultSymbol).then(function(t){e.isInstanceOf(n)?e.symbol=t:e.defaultSymbol=t})),f(a).then(function(){i.resolve(e)}).otherwise(function(){i.reject()}),i.promise},_fetchSymbol:function(e){if(e&&"web-style-symbol"===e.type)return e.fetchSymbol();var t=new d;return t.resolve(e),t.promise},_getMedianColor:function(e){var t,n,l,r;if(!e.visualVariables)return null;if(r=o.find(e.visualVariables,function(e){return"color"===e.type}),!r)return null;if(r.colors)t=r.minDataValue,n=r.maxDataValue;else if(r.stops){if(1===r.stops.length)return r.stops[0].color;t=r.stops[0].value,n=r.stops[r.stops.length-1].value}return null!=t&&null!=n?(l=t+(n-t)/2,e.getColor(l,{colorInfo:r})):void 0},_getAppliedCloneSymbol:function(t,n,l){var r,i,a=t.clone(),s=a.type,o=s.indexOf("3d")>-1;if(n&&(r=new e(n.toRgba()),o?this._applyColorTo3dSymbol(a,r):a.color=r),"simple-line-symbol"===s||"cartographic-line-symbol"===s||"text-symbol"===s){if(!a.color)return;i=a.color.toRgba(),i[3]=i[3]*l,a.color=i}else"simple-marker-symbol"===s||"simple-fill-symbol"===s?(a.color&&(i=a.color.toRgba(),i[3]=i[3]*l,a.color=i),a.outline&&a.outline.color&&(i=a.outline.color.toRgba(),i[3]=i[3]*l,a.outline.color=i)):o&&this._applyColorTo3dSymbol(a,null,l);return a},_applyColorTo3dSymbol:function(e,t,n){e.symbolLayers.forEach(function(e){if(e&&(t&&(e.material||(e.material={}),e.material.color=t),null!=n)){var l;e.material&&e.material.color&&(l=e.material.color.toRgba(),l[3]=l[3]*n,e.material.color=l),e.outline&&e.outline.color&&(l=e.outline.color.toRgba(),l[3]=l[3]*n,e.outline.color=l)}})},_getRampTitle:function(e,t){var n,l=e.field,r=e.normalizationField,i=!1,a=!1,s=!1;if(l=y.isFunction(l)?null:l,r=y.isFunction(r)?null:r,e.legendOptions&&e.legendOptions.title)n=e.legendOptions.title;else{if(t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables)for(var o=t.renderer.authoringInfo.visualVariables,u=0;u<o.length;u++){var c=o[u];if("colorInfo"===c.type){if("ratio"===c.style){i=!0;break}if("percent"===c.style){a=!0;break}if("percentTotal"===c.style){s=!0;break}}}n={field:l&&this._getFieldAlias(l,t),normField:r&&this._getFieldAlias(r,t),ratio:i,ratioPercent:a,ratioPercentTotal:s}}return n},_getRendererTitle:function(e,t,n){var r,i,a,s=e.field;return e instanceof l&&(r=e.normalizationField,i="percent-of-total"===e.normalizationType),s=y.isFunction(s)?null:s,r=y.isFunction(r)?null:r,(s||r)&&(a={field:n?s:s&&this._getFieldAlias(s,t),normField:n?r:r&&this._getFieldAlias(r,t),normByPct:i}),a},_getFieldAlias:function(e,t){var n,l,r,i=t.popupTemplate,a=i&&i.fieldInfos,s=y.isFunction(e)?null:t.getField&&t.getField(e);return a&&a.some(function(t){return e===t.fieldName?(l=t,!0):void 0}),r=l||s,r&&(n=l&&l.label||s&&s.alias||r.name||r.fieldName),n},_isUnclassedRenderer:function(e,t){var n=!1,r=e.isInstanceOf(l)&&e.classBreakInfos&&1===e.classBreakInfos.length;return r&&t&&(n=t.some(function(t){return!(!t||e.field!==t.field||e.normalizationField!=t.normalizationField)})),n}})});