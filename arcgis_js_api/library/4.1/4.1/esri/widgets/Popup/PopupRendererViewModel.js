// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["../../core/Accessor","../../core/HandleRegistry","../../core/lang","../../core/urlUtils","../../core/promiseList","../../core/promiseUtils","../../core/watchUtils","../../request","../../tasks/support/StatisticDefinition","../../tasks/support/Query","../../tasks/QueryTask","dojo/_base/lang","dojo/promise/all","dojo/i18n!dojo/cldr/nls/number"],function(t,e,r,i,n,a,s,o,l,d,c,h,u,f){var m={apostrophe:/\'/g,hrefAttributes:/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,token:/(\{([^\{\r\n]+)\})/g},_={apostrophe:"&apos;",ltr:"&lrm;"},y="relationships/",p={attachments:"attachments",fields:"fields",media:"media",text:"text"},g={"short-date":"(datePattern: 'M/d/y', selector: 'date')","short-date-le":"(datePattern: 'd/M/y', selector: 'date')","long-month-day-year":"(datePattern: 'MMMM d, y', selector: 'date')","day-short-month-year":"(datePattern: 'd MMM y', selector: 'date')","long-date":"(datePattern: 'EEEE, MMMM d, y', selector: 'date')","short-date-short-time":"(datePattern: 'M/d/y', timePattern: 'h:mm a', selector: 'date and time')","short-date-le-short-time":"(datePattern: 'd/M/y', timePattern: 'h:mm a', selector: 'date and time')","short-date-short-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm', selector: 'date and time')","short-date-le-short-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm', selector: 'date and time')","short-date-long-time":"(datePattern: 'M/d/y', timePattern: 'h:mm:ss a', selector: 'date and time')","short-date-le-long-time":"(datePattern: 'd/M/y', timePattern: 'h:mm:ss a', selector: 'date and time')","short-date-long-time-24":"(datePattern: 'M/d/y', timePattern: 'H:mm:ss', selector: 'date and time')","short-date-le-long-time-24":"(datePattern: 'd/M/y', timePattern: 'H:mm:ss', selector: 'date and time')","long-month-year":"(datePattern: 'MMMM y', selector: 'date')","short-month-year":"(datePattern: 'MMM y', selector: 'date')",year:"(datePattern: 'y', selector: 'date')"};return t.createSubclass({declaredClass:"esri.widgets.Popup.PopupRendererViewModel",properties:{content:{readOnly:!0},contentEnabled:!0,contentTypes:{readOnly:!0},formattedAttributes:{readOnly:!0},graphic:{},title:{readOnly:!0},waitingForContent:{readOnly:!0}},constructor:function(){this._handles=new e},initialize:function(){this._handles.add([s.init(this,"graphic",function(t){this._updateGraphic(t,this.contentEnabled)}.bind(this)),s.init(this,"contentEnabled",function(t){this._updateGraphic(this.graphic,t)}.bind(this))])},destroy:function(){this._handles.destroy(),this._handles=null,this._clearRelatedInfo(),this._cancelPromises(),this.graphic=null,this._set("title",null),this._set("content",null),this._set("waitingForContent",null)},content:null,contentEnabled:!0,contentTypes:p,formattedAttributes:null,graphic:null,title:"",waitingForContent:!1,_handles:null,_contentPromise:null,_contentPromiseLookup:null,_relatedRecordsPromise:null,_relatedRecordsQueryPromises:[],_relatedRecordsLayerPromises:[],_relatedLayersInfo:null,_relatedInfo:null,_dateFormats:g,_addValuesToHref:function(t,e,i,n){return e=this._trimString(e),r.substitute((e?0!==e.indexOf("${"):1)?n:i,t)},_cancelPromises:function(){this._contentPromiseLookup&&(Object.keys(this._contentPromiseLookup).forEach(function(t){this._contentPromiseLookup[t].cancel()},this),this._contentPromiseLookup=null),this._contentPromise&&(this._contentPromise.cancel(),this._contentPromise=null),this._relatedRecordsQueryPromises.forEach(function(t){t.cancel()}),this._relatedRecordsQueryPromises.length=0,this._relatedRecordsLayerPromises.length&&(this._relatedRecordsLayerPromises.forEach(function(t){t.cancel()}),this._relatedRecordsLayerPromises.length=0),this._relatedRecordsPromise&&(this._relatedRecordsPromise.cancel(),this._relatedRecordsPromise=null)},_clearRelatedInfo:function(){this._relatedLayersInfo=null,this._relatedInfo=null},_compileContent:function(t,e){var r=t.content;if("function"==typeof r&&(r=r.call(null,{graphic:t.graphic}),r&&r.nodeName))return r;if("string"==typeof r)return this._compileText(t,{type:p.text,text:r}).text;if(Array.isArray(r))return r.map(function(r,i){switch(r.type){case p.attachments:return this._proxyAttachments(r,e&&e[i]);case p.fields:return r;case p.media:return this._compileMedia(t,r);case p.text:return this._compileText(t,r)}},this);try{throw new Error(this.declaredClass+"::invalid content type.")}catch(i){console.warn(i.stack)}},_compileMedia:function(t,e){var i,n,a=h.clone(e),s=a.mediaInfos,o=t.attributes,l=t.layer,d=this.formattedAttributes.global,c=t.substOptions;return s&&(i=[],s.forEach(function(e){n=0;var a=e.value;switch(e.type){case"image":var s=a.sourceURL;s=s&&this._trimString(r.substitute(o,this._fixTokens(s,l))),n=!!s;break;case"pie-chart":case"line-chart":case"column-chart":case"bar-chart":var u,f=a.normalizeField;a.fields=a.fields.map(function(t){return u=this._getLayerFieldInfo(l,t),u?u.name:t},this),f&&(u=this._getLayerFieldInfo(l,f),a.normalizeField=u?u.name:f),n=a.fields.some(function(t){return r.isDefined(o[t])||-1!==t.indexOf(y)&&this._relatedInfo},this);break;default:return}if(n){e=h.clone(e),a=e.value;var m=e.title?this._processFieldsInLinks(this._fixTokens(e.title,l),o):"",_=e.caption?this._processFieldsInLinks(this._fixTokens(e.caption,l),o):"";if(e.title=m?this._trimString(r.substitute(d,m,c)):"",e.caption=_?this._trimString(r.substitute(d,_,c)):"","image"===e.type)a.sourceURL=r.substitute(o,this._fixTokens(a.sourceURL,l)),a.linkURL&&(a.linkURL=this._trimString(r.substitute(o,this._fixTokens(a.linkURL,l))));else{var p,g=t.template,b=g&&g.fieldInfos;a.fields.forEach(function(t,e){if(-1!==t.indexOf(y)){var r=this._getRelatedChartInfos(l,b,t,a,o,c);Array.isArray(r)?a.fields=r:a.fields[e]=r}else{var i=o[t];i=void 0===i?null:i,p=o[a.normalizeField]||0,i&&p&&(i/=p);var n=b&&this._getFieldInfo(b,t);a.fields[e]={y:i,tooltip:(n&&n.label||t)+":"+this._formatValue(b,i,t,c,!!p)}}},this)}i.push(e)}},this)),a.mediaInfos=i,a},_compileText:function(t,e){var i=h.clone(e);if(i&&i.text){var n=t.layer,a=t.attributes,s=this.formattedAttributes.global,o=t.substOptions,l=this._processFieldsInLinks(this._fixTokens(i.text,n),a);i.text=this._trimString(r.substitute(s,l,o))}return i},_compileTitle:function(t){var e="",i=t.title,n=t.layer,a=t.attributes,s=t.substOptions,o=this.formattedAttributes.global;if(i&&("function"==typeof i&&(i=i.call(null,{graphic:t.graphic})),"string"==typeof i)){var l=-1!==i.indexOf("{"+y);if(!l){var d=this._processFieldsInLinks(this._fixTokens(i,n),a);e=this._trimString(r.substitute(o,d,s))}}return e},_createGraphicInfo:function(t,e){var r=t.getEffectivePopupTemplate(),i=r&&r.title,n=r&&r.content,a=t.layer,s=a&&a._getDateOpts&&a._getDateOpts().properties,o=h.clone(t.attributes)||{},l={dateFormat:{properties:s,formatter:"DateFormat"+g["short-date-short-time"]}};return{graphic:t,template:r,title:i,content:n,contentEnabled:e,layer:a,attributes:o,properties:s,substOptions:l}},_fixTokens:function(t,e){return t.replace(m.token,function(t,r,i){var n=this._getLayerFieldInfo(e,i);return n?"{"+n.name+"}":r}.bind(this))},_encodeAttributes:function(t){var e=h.clone(t)||{};return Object.keys(e).forEach(function(t){var r=e[t];if("string"==typeof r){var i=encodeURIComponent(r).replace(m.apostrophe,_.apostrophe);e[t]=i}}),e},_formatAttributesToFieldInfos:function(t,e,r,i,n){t.forEach(function(a){var s=a.fieldName,o=this._getLayerFieldInfo(e,s);o&&(s=a.fieldName=o.name);var l=n[s];if(n[s]=this._formatValue(t,l,s,r),i&&a.format&&a.format.dateFormat){var d=i.indexOf(s);d>-1&&i.splice(d,1)}},this)},_formatAttributes:function(t,e,i,n,a,s){var o=h.clone(a);if(this._relatedInfo&&Object.keys(this._relatedInfo).forEach(function(t){var e=this._relatedInfo[t],r=this._relatedLayersInfo[t];e&&(e.relatedFeatures.forEach(this._relatedFeaturesAttributes.bind(this,r,a,o)),e.relatedStatsFeatures.forEach(this._relatedStatsAttributes.bind(this,r,a,o)))},this),t&&this._formatAttributesToFieldInfos(t,e,i,n,o),e){var l=e.typeIdField;Object.keys(a).forEach(function(t){if(-1===t.indexOf(y)){var i=a[t];if(r.isDefined(i)){var n=this._getDomainName(e,s,t,i);if(r.isDefined(n))o[t]=n;else if(t===l){var d=this._getTypeName(e,s,i);r.isDefined(d)&&(o[t]=d)}}}},this)}return o},_formatValue:function(t,e,i,n,a){var s=t&&this._getFieldInfo(t,i),o=s&&s.format,l="number"==typeof e&&n.dateFormat.properties&&-1===n.dateFormat.properties.indexOf(i)&&(!o||!o.dateFormat);if(!r.isDefined(e)||!s||!r.isDefined(o))return l?this._forceLTR(e):e;var d="",c=[],h=o.hasOwnProperty("places")||o.hasOwnProperty("digitSeparator"),u=o.hasOwnProperty("digitSeparator")?o.digitSeparator:!0;if(h)d="NumberFormat",c.push("places: "+(r.isDefined(o.places)&&(!a||o.places>0)?Number(o.places):"Infinity")),c.length&&(d+="("+c.join(",")+")");else{if(!o.dateFormat)return l?this._forceLTR(e):e;d="DateFormat"+g[o.dateFormat]||g["short-date-short-time"]}var m=r.substitute({myKey:e},"{myKey:"+d+"}",n)||"";return h&&!u&&f.group&&(m=m.replace(new RegExp("\\"+f.group,"g"),"")),l?this._forceLTR(m):m},_forceLTR:function(t){return _.ltr+t},_getDomainName:function(t,e,r,i){var n=t.getDomain&&t.getDomain(r,{feature:e});return n&&n.codedValues?n.getName(i):null},_getFieldInfo:function(t,e){for(var r,i=e.toLowerCase(),n=0;n<t.length;n++){var a=t[n];if(a.fieldName&&a.fieldName.toLowerCase()===i){r=a;break}}return r},_getLayerFieldInfo:function(t,e){return t&&t.getField?t.getField(e):null},_getTypeName:function(t,e){var r=t.getType&&t.getType(e);return r&&r.name},_processFieldsInLinks:function(t,e){var r=this._encodeAttributes(e);return t&&(t=t.replace(m.hrefAttributes,function(t,i){return this._addValuesToHref(t,i,e,r)}.bind(this))),t},_proxyAttachments:function(t,e){var r=h.clone(t);if(e&&!(e instanceof Error)&&e.attachmentInfos&&e.attachmentInfos.length){var n=e.attachmentInfos.map(function(t){return t.url=i.addProxy(t.url),t},this);r.attachmentInfos=n}return r},_queryAttachments:function(t){var e=t.layer,r=t.attributes,i=e&&e.objectIdField,n=r&&i&&r[i];return i&&e.hasAttachments&&n?this._queryAttachmentInfos(e,n):void 0},_queryAttachmentInfos:function(t,e){var r=t.url+"/"+t.layerId+"/"+e+"/attachments",i=t.token||"";return o(r,{query:{f:"json",token:i},callbackParamName:"callback"}).then(function(t){var n=t.data,a=n.attachmentInfos;return a.forEach(function(t){t.url=r+"/"+t.id,i&&(t.url+="?token="+i),t.objectId=e}),n})},_queryContent:function(t){var e=t.template,r=e&&e.content;if(!r||"string"==typeof r||"function"==typeof r)return a.resolve();if(!Array.isArray(r))return a.reject(new Error(this.declaredClass+"::Invalid content type."));var i={};return r.forEach(function(e,r){e.type===p.attachments&&(i[r]=this._queryAttachments(t))},this),0===Object.keys(i).length?a.resolve():(this._contentPromiseLookup=i,n(i).always(function(t){return this._contentPromiseLookup=null,t}.bind(this)))},_trimString:function(t){return(t||"").trim()},_updateContent:function(t){if(t.contentEnabled){var e=this._queryContent(t).then(function(e){this._set("content",this._compileContent(t,e))}.bind(this),function(t){console.log(this.declaredClass+"::error loading template",t)}.bind(this)).always(function(){this._contentPromise=null}.bind(this));return this._contentPromise=e,e}return a.resolve()},_createFormattedAttributes:function(t){var e=t.graphic,r=t.attributes,i=t.layer,n=t.template,a=n&&n.fieldInfos,s=t.substOptions,o=t.properties,l={global:this._formatAttributes(a,i,s,o,r,e),content:[]},d=n&&n.content;return Array.isArray(d)&&d.forEach(function(t,n){t.type===p.fields&&t.fieldInfos&&(l.content[n]=this._formatAttributes(t.fieldInfos,i,s,o,r,e))},this),l},_updateGraphic:function(t,e){if(this._handles&&(this._clearRelatedInfo(),this._cancelPromises(),this._set("title",""),this._set("content",null),this._set("formattedAttributes",null),this._set("waitingForContent",!1),t)){this._set("waitingForContent",!0);var r=this._createGraphicInfo(t,e),i=this._checkForRelatedRecords(r).then(function(){return this._set("formattedAttributes",this._createFormattedAttributes(r)),this._set("title",this._compileTitle(r)),this._updateContent(r)}.bind(this)).always(function(){this._relatedRecordsPromise=null,this._relatedRecordsLayerPromises.length=0,this._relatedRecordsQueryPromises.length=0,this._set("waitingForContent",!1)}.bind(this));this._relatedRecordsPromise=i}},_getAllFieldInfos:function(t){var e=[],r=t.template,i=r&&r.fieldInfos,n=t.contentEnabled;if(i&&(e=e.concat(i)),n){var a=r&&r.content;Array.isArray(a)&&a.forEach(function(t){var r=t&&t.fieldInfos;e=e.concat(r)},this)}return e},_checkForRelatedRecords:function(t){var e=this._getAllFieldInfos(t),r=e.filter(function(t){return t&&t.fieldName&&-1!==t.fieldName.indexOf(y)},this);return r&&r.length>0?this._getRelatedRecords({graphic:t.graphic,fieldsInfo:r}):a.resolve()},_relatedFeaturesAttributes:function(t,e,r,i){Object.keys(i.attributes).forEach(function(n){if("esriRelCardinalityOneToOne"===t.relation.cardinality){var a=this._toRelatedFieldName([t.relation.id,n]);e[a]=r[a]=i.attributes[n]}},this)},_relatedStatsAttributes:function(t,e,r,i){Object.keys(i.attributes).forEach(function(n){var a=this._toRelatedFieldName([t.relation.id,n]);e[a]=r[a]=i.attributes[n]},this)},_getRelatedChartInfos:function(t,e,r,i,n,a){var s,o,l,d,c,h,u,f;return s=[],f=this._fromRelatedFieldName(r),h=f[0],o=this._relatedInfo[h],u=this._relatedLayersInfo[h],o&&o.relatedFeatures.forEach(function(o){var l,h=o.attributes;Object.keys(h).forEach(function(o){if(o===f[1]){if(l={},c=h[o],i.normalizeField&&(d=-1!==i.normalizeField.indexOf(y)?h[this._fromRelatedFieldName(i.normalizeField)[1]]:n[i.normalizeField]),c&&d&&(c/=d),i.tooltipField)if(-1!==i.tooltipField.indexOf(y)){var u=this._fromRelatedFieldName(i.tooltipField)[1];l.tooltip=h[u]+": "+this._formatValue(e,c,h[u],a,!!d)}else{var m=this._getLayerFieldInfo(t,r);m&&(r=m.name),l.tooltip=r+": "+this._formatValue(e,c,i.tooltipField,a,!!d)}else l.tooltip=c;l.y=c,s.push(l)}},this)},this),l="esriRelCardinalityOneToMany"===u.relation.cardinality||"esriRelCardinalityManyToMany"===u.relation.cardinality?s:s[0]},_getRelatedRecords:function(t){var e=t.graphic;return this._relatedLayersInfo?this._queryRelatedLayers(e).then(function(t){return this._setRelatedRecords(t),t}.bind(this)):this._getRelatedLayersInfo(t).then(function(t){return Object.keys(t).forEach(function(e){t[e]&&(this._relatedLayersInfo[e].relatedLayerInfo=t[e].data)},this),this._queryRelatedLayers(e).then(function(t){return this._setRelatedRecords(t),t}.bind(this))}.bind(this))},_getRelatedLayersInfo:function(t){var e,r=t.graphic,i=t.fieldsInfo,n={};return e=r.layer,this._relatedLayersInfo||(this._relatedLayersInfo={}),i.forEach(function(t){var r,i,n,a,s;r=this._fromRelatedFieldName(t.fieldName),i=r[0],n=r[1],i&&(this._relatedLayersInfo[i]||(e.relationships.some(function(t){return t.id==i?(s=t,!0):void 0}),s&&(this._relatedLayersInfo[i]={relation:s,relatedFields:[],outStatistics:[]})),this._relatedLayersInfo[i]&&(this._relatedLayersInfo[i].relatedFields.push(n),t.statisticType&&(a=new l({statisticType:t.statisticType,onStatisticField:n,outStatisticFieldName:n}),this._relatedLayersInfo[i].outStatistics.push(a))))},this),Object.keys(this._relatedLayersInfo).forEach(function(t){var r,i;this._relatedLayersInfo[t]&&(r=this._relatedLayersInfo[t].relation,i=e.url+"/"+r.relatedTableId,this._relatedLayersInfo[t].relatedLayerUrl=i,n[t]=o(i,{query:{f:"json"},callbackParamName:"callback"}))},this),Object.keys(n).forEach(function(t){this._relatedRecordsLayerPromises.push(n[t])},this),u(n)},_queryRelatedLayers:function(t){var e={};return Object.keys(this._relatedLayersInfo).forEach(function(r){e[r]=this._queryRelatedLayer({graphic:t,relatedInfo:this._relatedLayersInfo[r]})},this),u(e)},_queryRelatedLayer:function(t){var e,r,i,n,a,s,o,l,h,f,m,_,y,p;return e=t.graphic,r=e.layer,i=r.layerId,_=t.relatedInfo,n=_.relatedLayerInfo,y=_.relatedLayerUrl,p=_.relation,n&&n.relationships&&n.relationships.some(function(t){return t.relatedTableId===parseInt(i,10)?(a=t,!0):void 0}),a&&(n.fields.some(function(t){if(t.name===a.keyField){var e=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble"];return s=-1!==e.indexOf(t.type)?"number":"string",!0}}),f="string"===s?a.keyField+"='"+e.attributes[p.keyField]+"'":a.keyField+"="+e.attributes[p.keyField],o=new d({where:f,outFields:_.relatedFields}),_.outStatistics&&_.outStatistics.length>0&&n.supportsStatistics&&(m=new d({where:o.where,outFields:o.outFields,outStatistics:_.outStatistics})),l=new c({url:y}),h=[l.execute(o)],m&&h.push(l.execute(m))),this._relatedRecordsQueryPromises=this._relatedRecordsQueryPromises.concat(h),u(h)},_setRelatedRecords:function(t){this._relatedInfo=[],Object.keys(t).forEach(function(e){if(t[e]){var i=t[e];this._relatedInfo[e]={relatedFeatures:i[0].features},r.isDefined(i[1])&&(this._relatedInfo[e].relatedStatsFeatures=i[1].features)}},this)},_fromRelatedFieldName:function(t){var e=-1!==t.indexOf(y);return e?t.split("/").slice(1):[]},_toRelatedFieldName:function(t){return t&&t.length>0?y+t[0]+"/"+t[1]:""}})});