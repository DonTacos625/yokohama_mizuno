// COPYRIGHT Â© 2016 Esri
//
// All rights reserved under the copyright laws of the United States
// and applicable international laws, treaties, and conventions.
//
// This material is licensed for use under the Esri Master License
// Agreement (MLA), and is bound by the terms of that agreement.
// You may redistribute and use this code without modification,
// provided you adhere to the terms of the MLA and include this
// copyright notice.
//
// See use restrictions at http://www.esri.com/legal/pdfs/mla_e204_e300/english
//
// For additional information, contact:
// Environmental Systems Research Institute, Inc.
// Attn: Contracts and Legal Services Department
// 380 New York Street
// Redlands, California, USA 92373
// USA
//
// email: contracts@esri.com
//
// See http://js.arcgis.com/4.1/esri/copyright.txt for details.

define(["./Widget","./DateTimeTextBox","./RendererSlider/sliderUtils","../core/numberUtils","../core/watchUtils","../renderers/support/utils","dijit/_TemplatedMixin","dijit/form/NumberTextBox","dojo/_base/array","dojo/_base/lang","dojo/dnd/move","dojo/dom-construct","dojo/dom-style","dojo/dom-class","dojo/on","dojo/text!./RendererSlider/templates/RendererSlider.html"],function(e,t,i,a,s,o,n,l,r,h,d,u,m,c,_,b){var p=e.createSubclass([n],{declaredClass:"esri.widgets.RendererSlider",templateString:b,_visibleLabels:["data","handle"],_roundedDataLabels:[],_roundedHandleLabels:[],_ratioLabels:[],_minRatioLabel:"",_maxRatioLabel:"",_sliderHeight:null,_isZoomed:!1,_minZoomLabel:"",_maxZoomLabel:"",_maximumNumberEditor:null,_minimumNumberEditor:null,_valueDifferenceByIndex:[],_primaryHandleIdx:null,_currentTopValue:[],_isLTR:!0,_ctrlDown:!1,_histogramSurface:null,_css:null,_minPrecisionForSmallNumbers:3,properties:{loaded:!1,intermediateChanges:!0,type:null,minimum:0,maximum:100,values:[],precision:2,handles:[],primaryHandle:null,showHandles:!0,showTicks:!0,showLabels:!0,showRatioLabels:!1,minLabel:null,maxLabel:null,isDate:!1},constructor:function(e,t){this.inherited(arguments),this.domNode=t,this._css={container:"esri-renderer-slider",slidernode:"esri-slider-node",sliderarea:"esri-slider-area",sliderarearight:"esri-slider-area-right",moveable:"esri-moveable",handler:"esri-handle",handlerSpan:"esri-handle-span",handlerContainer:"esri-handle-container",handlerLabel:"esri-handle-label",handlerLabelSpan:"esri-handle-label-span",topLabelNode:"esri-top-label-node",bottomLabelNode:"esri-bottom-label-node",topLabelNodeHover:"esri-top-label-node-hover",bottomLabelNodeHover:"esri-bottom-label-node-hover",heatmapTick:"esri-heatmap-tick",handlerTick:"esri-handler-tick",handlerTickTop:"esri-handler-tick-top",handlerTickBottom:"esri-handler-tick-bottom"},this.set("showLabels",e.showLabels||this._visibleLabels)},startup:function(){this.inherited(arguments);var e=m.get(this._sliderArea,"height");if(this._sliderHeight=e?e:200,this._checkMinMaxDefaults(),this.set("_isLTR",this.isLeftToRight()),!this._isLTR){var t=m.get(this._sliderNode,"padding-left")+m.get(this._sliderNode,"padding-right"),a=Math.round(m.get(this._sliderNode,"width"));this.set("_sliderNodeWidth_RTL",t+a)}this.set("precision",i.getCombinedPrecision(this.minimum,this.maximum)),this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),this._generateCtrlKeyListener(),this.watch("values",this._valuesChange),this.watch("minimum, maximum, showRatioLabels",this._updateTimeout),this.set("loaded",!0),this.emit("load")},destroy:function(){this.inherited(arguments)},setValue:function(e,t,i){var a=this.get("values"),s=a.slice(0);"object"==typeof a[0]?s[e].value=t:s[e]=t,(this.intermediateChanges||i)&&this.set("values",s),i?this.emit("stop",{values:this.get("values")}):this.emit("slide",{values:s})},_updateTimeout:function(e,t,i){this._updateSlider()},_updateSlider:function(){this._reset(),this._checkMinMaxDefaults(),this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),this._generateCtrlKeyListener()},_checkMinMaxDefaults:function(){var e,t,i=this.values;this.minimum===this.maximum&&i&&i.length>0&&(isNaN(i[0])?this.set({minimum:0,maximum:2*i[0].value}):this.set({minimum:0,maximum:2*i[0]})),i&&i.lenth>0&&(e=isNaN(i[0])?i[0].value:i[0],this.minimum>e&&this.set("minimum",e),t=isNaN(i[i.length-1])?i[i.length-1].value:i[i.length-1],this.maximum<t&&this.set("maximum",t))},_calculateValueFromHandlePosition:function(e){var t,i=this.get("minimum"),a=this.get("maximum"),s=this.get("precision"),o=this.get("step")||Math.pow(10,-s);return t=1>=i&&i>=-1&&1>=a&&a>=-1||s>=this._minPrecisionForSmallNumbers?(e*(a-i)+i)/o*o:parseFloat((Math.round((e*(a-i)+i)/o)*o).toFixed(s))},_generateMoveables:function(){var e,t=this._sliderNode,s=this._sliderHeight,o=this.get("minimum"),n=this.get("maximum"),l=this.get("showLabels"),c=this.get("showTicks"),_=h.hitch(this,this.setValue),b=this.get("values");this._updateMinMaxLabels(),this.set("_primaryHandleIdx",null),e=r.map(b,h.hitch(this,function(b,p){var L,x,N,g,v,f;return b&&b.primaryHandle&&this.set("_primaryHandleIdx",p),"object"==typeof b&&b.hidden?null:("object"==typeof b&&(b=b.value),L=u.create("div",{style:this._getHandleStyleString(b),className:this._css.moveable},t),L.handleContainer=f=u.create("div",{className:this._css.handlerContainer},L),L.arrowSpan=g=u.create("span",{className:this._css.handlerSpan},f),L.handler=x=u.create("div",{className:this._css.handler},f),"HeatmapSlider"!==this.type&&(l===!0||"object"==typeof l&&-1!==r.indexOf(l,"handles"))&&(N=this._generateHandleLabel(L,p)),c&&this._generateHandleTicks(L,p),v=new d.constrainedMoveable(L,{handle:f,within:!0,constraints:h.hitch(this,function(){return{t:0,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s}})}),v.onMoveStart=h.hitch(this,function(t){var a,o,n,l,d,u,c,_,b=this.handles,x=r.indexOf(b,p);this._currentTopValue[p]=t.node.style.top,L.labelNode&&L.labelNode._autoPositioned&&(m.set(L.labelNode,"top","3px"),L.labelNode._autoPositioned=!1),i._autoPositionHandleLabels(this.get("moveables")),L._numberEditor&&(L._numberEditor.destroy(),L._numberEditor=null),this._primaryHandleIdx!==p?(b&&b.length>0?(a=null!==b[x-1]?b[x-1]:null,o=null!==b[x+1]?b[x+1]:null,n=e[a],l=e[o]):(n=e[p-1],l=e[p+1]),n&&l?(d=n.style.top,u=l.style.top,c=Number(d.replace("px","")),_=Number(u.replace("px","")),v.constraints=h.hitch(this,function(){return{t:_+2,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s-_-(s-c+4)}})):n?(d=n.style.top,c=Number(d.replace("px","")),v.constraints=h.hitch(this,function(){return{t:0,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s-(s-c+2)}})):l&&(u=l.style.top,_=Number(u.replace("px","")),v.constraints=h.hitch(this,function(){return{t:_+2,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s-(_+2)}}))):(b&&b.length>0?(a=null!==b[x-1]?b[x-1]:null,o=null!==b[x+1]?b[x+1]:null,n=e[a],l=e[o]):(n=e[p-1],l=e[p+1]),n&&l&&(d=n.style.top,u=l.style.top,c=Number(d.replace("px","")),_=Number(u.replace("px","")),v.constraints=h.hitch(this,function(){return{t:2,l:this._isLTR?0:this._sliderNodeWidth_RTL,w:0,h:s-4}})))}),v.onMoved=h.hitch(this,function(t){var a,l,d,u,c,b,L,x;if(p===this._primaryHandleIdx&&(d=Number(this._currentTopValue[p].replace("px",""))-Number(t.node.style.top.replace("px","")),this._currentTopValue[p]=t.node.style.top,r.forEach(e,h.hitch(this,function(e,t){if(e){if(t===p)return;if(u=Number(e.style.top.replace("px","")),b=u-d,a=1-Number(b/s),l=this._calculateValueFromHandlePosition(a),o>l||l>n)return;m.set(e,"top",b+"px"),_(t,l,!1),e.labelNode&&(e.labelNode.spanNode.innerHTML=this.showRatioLabels?this._getLabelValueFromIndex(t):this._formatValue(l.toFixed(6)))}}))),a=1-Number(t.node.style.top.replace("px",""))/s,l=this._calculateValueFromHandlePosition(a),null!==this._primaryHandleIdx&&p!==this._primaryHandleIdx&&this._ctrlDown&&(d=Number(this._currentTopValue[p].replace("px",""))-Number(t.node.style.top.replace("px","")),this._currentTopValue[p]=t.node.style.top,0===p?(u=Number(e[e.length-1].style.top.replace("px","")),c=u+d,c>s&&(c=s),0>c&&(c=0),m.set(e[e.length-1],"top",c+"px"),x=1-c/s,L=this._calculateValueFromHandlePosition(x),_(e.length-1,L,!1),e[e.length-1].labelNode&&(e[e.length-1].labelNode.spanNode.innerHTML=this._formatValue(L.toFixed(6)))):p===e.length-1&&(u=Number(e[0].style.top.replace("px","")),c=u+d,c>s&&(c=s),0>c&&(c=0),m.set(e[0],"top",c+"px"),x=1-c/s,L=this._calculateValueFromHandlePosition(x),_(0,L,!1),e[0].labelNode&&(e[0].labelNode.spanNode.innerHTML=this._formatValue(L.toFixed(6))))),_(p,l,!1),this._updateRoundedLabels(),N){var g=this._formatValue(parseFloat(this._roundValue([l,parseFloat(this._getLabelValueFromIndex(p,!0))])[0]).toFixed(this.precision));N.spanNode.innerHTML=this.showRatioLabels?this._getLabelValueFromIndex(p):g}i._autoPositionHandleLabels(this.get("moveables"))}),v.onMoveStop=h.hitch(this,function(e){var t,o,n;if(n=Number(e.node.style.top.replace("px","")),t=1-n/s,o=this._calculateValueFromHandlePosition(t),_(p,o,!0),this._updateRoundedLabels(),N){var l=a.format(parseFloat(a.round([o,parseFloat(this._getLabelValueFromIndex(p,!0))])[0]).toFixed(this.precision));N.spanNode.innerHTML=this.showRatioLabels?this._getLabelValueFromIndex(p):l}i._autoPositionHandleLabels(this.get("moveables"))}),this.showHandles||(m.set(x,"display","none"),m.set(g,"display","none")),L)})),this.set("moveables",e),i._autoPositionHandleLabels(this.get("moveables"))},_reset:function(){r.forEach(this.moveables,h.hitch(this,function(e){e&&e.parentElement.removeChild(e)})),this.moveables=[]},_getHandleStyleString:function(e){var t=this.get("minimum"),i=this.get("maximum"),a=(e-t)/(i-t),s=Math.round((1-a)*this._sliderHeight),o=this._isLTR?0:this._sliderNodeWidth_RTL,n="left: "+o+"px;",l="top: "+s+"px;",r=l+" "+n;return r},_generateHandleTicks:function(e,t){var i=this._css,a=i.handlerTick+" "+i.handlerTickTop,s=i.handlerTick+" "+i.handlerTickBottom,o=0===t?s:a;"HeatmapSlider"===this.type&&(o+=i.heatmapTick),e.tick=u.create("div",{className:o},e)},_updateLabels:function(){this._updateMinMaxLabels(),this._updateRoundedLabels()},_resetLabelPositions:function(){r.forEach(this.moveables,function(e){if(e){var t=e.labelNode;t&&(m.set(t,"top","3px"),e.labelNode._autoPositioned=!1)}})},_generateHandleLabel:function(e,t){var i,a;return i=u.create("div",{className:this._css.handlerLabel},e),a=u.create("span",{className:this._css.handlerLabelSpan,innerHTML:this._getLabelValueFromIndex(t)},i),i.spanNode=a,e.labelNode=i,_(i,"click",h.hitch(this,function(){this._generateHandleLabelEditor(e,t)})),i},_updateMinMaxLabels:function(){var e,t,i,a,s,o,n=this.minimum,l=this.maximum,h=this.showLabels,d=this.minLabel,u=this.maxLabel,m=this._topNodeSpan,c=this._bottomNodeSpan,_=this._isZoomed,b=this._maxZoomLabel,p=this._minZoomLabel,L=this.showRatioLabels,x=this._maxRatioLabel,N=this._minRatioLabel,g=this._roundedDataLabels;h===!1||"object"==typeof h&&-1===r.indexOf(h,"data")?(m.innerHTML="",c.innerHTML=""):_?L?(m.innerHTML=x,c.innerHTML=N):(m.innerHTML=this._formatValue(b),c.innerHTML=this._formatValue(p)):L?(m.innerHTML=x,c.innerHTML=N):(e=isNaN(d)?d:this._roundValue([d,u])[0],t=isNaN(u)?u:this._roundValue([d,u])[1],i=isNaN(e)||null===e?d:this._formatValue(e),a=isNaN(t)||null===t?u:this._formatValue(t),s=this._formatValue(g[0])||this._formatValue(n),o=this._formatValue(g[1])||this._formatValue(l),m.innerHTML=a||o,c.innerHTML=i||s)},_formatValue:function(e){return"string"==typeof e&&(e=Number(e)),this.isDate?o.formatDate(new Date(e),o.timelineDateFormatOptions):a.format(e)},_roundValue:function(e){return this.isDate?e.slice(0):a.round(e)},_updateRoundedLabels:function(){switch(this._roundedDataLabels=this._roundValue([this.minimum,this.maximum]),this.type){case"SizeInfoSlider":case"ClassedSizeSlider":case"ClassedColorSlider":case"ColorAndSizeSlider":this._roundedHandleLabels=this._roundValue(this.values);break;case"ColorInfoSlider":case"OpacitySlider":this._roundedHandleLabels=this._roundValue(this._getValuesFromObject(this.values))}this._updateRatioLabels()},_updateRatioLabels:function(){var e,t,i=this.get("showRatioLabels"),a=this.get("minimum"),s=this.get("maximum"),o=this._getValuesFromObject(this.values),n=[];if(i!==!1){if("percent"!==i&&"percentTotal"!==i)return void this.set("showRatioLabels",!1);"percent"===i?(r.forEach(o,function(e){n.push(this._getRatioFromValue(e))},this),e=this._formatValue(this._getRatioFromValue(a).toFixed(2)),t=this._formatValue(this._getRatioFromValue(s).toFixed(2))):"percentTotal"===i&&(r.forEach(o,function(e){n.push(this._getRatioFromValue(e))},this),e=this._formatValue(this._getRatioFromValue(a).toFixed(2)),t=this._formatValue(this._getRatioFromValue(s).toFixed(2))),this.set({_ratioLabels:n,_minRatioLabel:e+"%",_maxRatioLabel:t+"%"})}},_generateMinMaxEditors:function(){!this.showLabels||"object"==typeof this.showLabels&&-1===r.indexOf(this.showLabels,"data")||"HeatmapSlider"===this.type?(c.remove(this._topNode,this._css.topLabelNodeHover),c.remove(this._botNode,this._css.bottomLabelNodeHover)):(_(this._topNode,"click",h.hitch(this,this._generateMaxEditor)),_(this._botNode,"click",h.hitch(this,this._generateMinEditor)))},_generateMaxEditor:function(){if(!(this._maximumNumberEditor&&this._topLabelNode||this._isZoomed)){var e,i,a=this.get("minLabel"),s=this.get("maxLabel"),o=this.get("maximum");if(this._topNodeSpan.innerHTML="",this._topLabelNode=u.create("input",{type:"text"},this._topNode),e=this.handles&&this.handles.length>0?this.values[this.handles[this.handles.length-1]]:this.values[this.values.length-1],"object"==typeof e&&(e=e.value),this.showRatioLabels&&(e=this._getLabelValueFromIndex(this.values.length-1,!0).replace("%",""),o=Number(this._maxRatioLabel.replace("%",""))),this.isDate){i=new t({date:new Date(Number(o)),required:!0,constraints:{min:new Date(e),max:null}},this._topLabelNode);var n={editor:i,editorPropName:"_maximumNumberEditor",spanNode:this._topNodeSpan,operator:"<"};i.on("keydown",h.hitch(this,this._minMaxKeydownDateHandler,n)),i.on("blur",h.hitch(this,this._minMaxBlurDateValue,n)),i.watch("date",h.hitch(this,this._minMaxUpdateDateValue,n))}else{i=new l({value:Number(o),required:!0,constraints:{min:e,max:"percentTotal"===this.showRatioLabels?100:null,places:"0,20"}},this._topLabelNode);var r=!1;_(i,"keydown",h.hitch(this,this._keydownHandler,{editor:i,originalValidate:r})),_(i,"blur",h.hitch(this,this._minMaxBlurHandler,{editor:i,editorPropName:"_maximumNumberEditor",label:s,current:o,spanNode:this._topNodeSpan,index:1,minLabel:a,maxLabel:s,ratioLabel:this._maxRatioLabel})),_(i,"change",h.hitch(this,this._minMaxChangeHandler,{label:s,current:o,spanNode:this._topNodeSpan,index:1,minLabel:a,maxLabel:s,ratioLabel:this._maxRatioLabel,handleValue:e,operator:"<"}))}this._maximumNumberEditor=i,i.startup(),i.focus(),i.textbox.select()}},_generateMinEditor:function(){if(!(this._minimumNumberEditor&&this._botLabelNode||this._isZoomed)){var e,i,a=this.minLabel,s=this.maxLabel,o=this.minimum;if(this._bottomNodeSpan.innerHTML="",this._botLabelNode=u.create("input",{type:"text"},this._botNode),e=this.handles&&this.handles.length>0?this.values[this.handles[0]]:this.values[0],"object"==typeof e&&(e=e.value),this.showRatioLabels&&(e=this._getLabelValueFromIndex(0,!0).replace("%",""),o=Number(this._minRatioLabel.replace("%",""))),this.isDate){i=new t({date:new Date(Number(o)),required:!0,constraints:{min:null,max:new Date(e)}},this._botLabelNode);var n={editor:i,editorPropName:"_minimumNumberEditor",spanNode:this._bottomNodeSpan,operator:">"};i.on("keydown",h.hitch(this,this._minMaxKeydownDateHandler,n)),i.on("blur",h.hitch(this,this._minMaxBlurDateValue,n)),i.watch("date",h.hitch(this,this._minMaxUpdateDateValue,n))}else{i=new l({value:Number(o),required:!0,constraints:{max:e,min:"percentTotal"===this.showRatioLabels?0:null,places:"0,20"}},this._botLabelNode);var r=!1;_(i,"keydown",h.hitch(this,this._keydownHandler,{editor:i,originalValidate:r})),_(i,"blur",h.hitch(this,this._minMaxBlurHandler,{editor:i,editorPropName:"_minimumNumberEditor",label:a,current:o,spanNode:this._bottomNodeSpan,index:0,minLabel:a,maxLabel:s,ratioLabel:this._minRatioLabel})),_(i,"change",h.hitch(this,this._minMaxChangeHandler,{label:a,current:o,spanNode:this._bottomNodeSpan,index:0,minLabel:a,maxLabel:s,ratioLabel:this._minRatioLabel,handleValue:e,operator:">"}))}this._minimumNumberEditor=i,i.startup(),i.focus(),i.textbox.select()}},_minMaxBlurHandler:function(e,t){var i=e.editor,a=e.editorPropName,s=e.label,o=e.current,n=e.spanNode,l=e.index,h=e.minLabel,d=e.maxLabel,u=e.ratioLabel,m=isNaN(s)?s:this._roundValue([h,d])[l],c=isNaN(m)||null===m?s:this._formatValue(m),_=this._formatValue(this._roundedDataLabels[l])||this._formatValue(o);this.showLabels||"object"==typeof this.showLabels&&-1!==r.indexOf(this.showLabels,"data")?this.showRatioLabels?n.innerHTML=u:n.innerHTML=c||_:n.innerHTML="",i.destroy(),this[a]=null},_minMaxChangeHandler:function(e,t){var i,a,s,o,n=e.label,l=e.current,r=e.spanNode,d=e.index,u=e.minLabel,m=e.maxLabel,c=e.ratioLabel,_=e.handleValue,b=e.operator;return("<"===b?t<Number(_):t>Number(_))||isNaN(t)||void 0===t?(i=isNaN(n)?n:this._roundValue([u,m])[d],a=isNaN(i)||null===i?n:this._formatValue(i),s=this._formatValue(this._roundedDataLabels[d])||this._formatValue(l),void(this.showRatioLabels?r.innerHTML=c:r.innerHTML=a||s)):(o=this.showRatioLabels?this._getValueFromPercent(t):t,r.innerHTML=this.showRatioLabels?o:this._formatValue(t),this.set("<"===b?"maximum":"minimum",o),this._reset(),this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),void this.emit("data-value-change",{min:this.minimum,max:this.maximum,values:h.clone(this.values)}))},_minMaxKeydownDateHandler:function(e,t){13===t.keyCode&&e.editor.isValid()&&setTimeout(h.hitch(this,this._destroyMinMaxHandleEditor,e),0)},_minMaxBlurDateValue:function(e,t){setTimeout(h.hitch(this,this._destroyMinMaxHandleEditor,e),0)},_destroyMinMaxHandleEditor:function(e){var t="<"===e.operator?"maximum":"minimum";e.spanNode.innerHTML=this._formatValue(this.get(t)),e.editor.destroy(),this[e.editorPropName]=null},_minMaxUpdateDateValue:function(e){var t=e.editor,i=e.spanNode,a=e.operator,s=t.get("date"),o="<"===a?"maximum":"minimum",n=this.get(o);s=s&&s.getTime();var l=n!==s;l&&(i.innerHTML=this._formatValue(s),this.set(o,s)),this._reset(),this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),l&&this.emit("data-value-change",{min:this.minimum,max:this.maximum,values:h.clone(this.values)})},_generateHandleLabelEditor:function(e,i){if(!e._numberEditor){var a,s,o,n,d,m,c,b,p=this.get("handles"),L=this.get("maximum"),x=this.get("minimum"),N=this.get("_isZoomed"),g=this.get("values"),v=g[i],f=r.indexOf(p,i),H=e.labelNode,V=!1;if("object"==typeof v&&(v=v.value),H.spanNode.innerHTML="",c=u.create("input",{type:"text"},H),p&&p.length>0?(a=null!==p[f-1]?p[f-1]:null,s=null!==p[f+1]?p[f+1]:null,o=g[a],n=g[s],"object"==typeof o&&(o=o.value),"object"==typeof n&&(n=n.value)):(o=g[i-1],n=g[i+1],"object"==typeof o&&(o=o.value),"object"==typeof n&&(n=n.value)),d=void 0!==o&&null!==o?o:N&&!isNaN(this._minZoomLabel)?this._minZoomLabel:x,m=void 0!==n&&null!==n?n:N&&!isNaN(this._maxZoomLabel)?this._maxZoomLabel:L,this.showRatioLabels&&(v=this._getLabelValueFromIndex(i).replace("%",""),d=o?Number(this._getLabelValueFromIndex(a,!0).replace("%","")):Number(this._minRatioLabel.replace("%",""))||Number(this._getRatioFromValue(this.minimum)),m=n?Number(this._getLabelValueFromIndex(s,!0).replace("%","")):Number(this._maxRatioLabel.replace("%",""))||Number(this._getRatioFromValue(this.maximum))),this.isDate){b=new t({date:new Date(v),required:!0,constraints:{min:new Date(d),max:new Date(m)}},c);var y={editor:b,editorPropName:"_numberEditor",min:x,max:L,index:i,zoomed:N,spanNode:H.spanNode,moveable:e};b.on("keydown",h.hitch(this,this._stopKeydownDateHandler,y)),b.on("blur",h.hitch(this,this._stopBlurDateHandler,y)),b.watch("date",h.hitch(this,this._stopUpdateDateValue,y))}else b=new l({value:v,constraints:{min:d,max:m,places:"0,20"}},c),_(b,"keydown",h.hitch(this,this._keydownHandler,{editor:b,originalValidate:V})),_(b,"blur",h.hitch(this,this._blurHandler,{editor:b,editorPropName:"_numberEditor",updatedValue:v,min:x,max:L,index:i,zoomed:N,spanNode:H.spanNode,moveable:e})),_(b,"change",h.hitch(this,this._changeHandler,{editor:b,index:i,spanNode:H.spanNode}));e._numberEditor=b,b.focus(),b.textbox.select()}},_keydownHandler:function(e,t){var i=e.originalValidate,a=e.editor;if(i!==!1&&(a.validate=i),13===t.keyCode){var s=a.get("value");void 0===s&&(s=a.get("displayedValue")),s<=a.constraints.max&&s>=a.constraints.min?a.focusNode.blur():(i=a.validate,a.validate(!1),a.validate=function(){return!1})}},_blurHandler:function(e,t){var i=e.editor,a=e.editorPropName,s=e.updatedValue,o=e.min,n=e.max,l=e.index,r=e.zoomed,h=e.spanNode,d=e.moveable;isNaN(i.get("value"))&&i.set("value",s),r&&(i.get("value")>n||i.get("value")<o)&&(this.set("_isZoomed",!1),this.emit("zoom-out")),h.innerHTML=this._getLabelValueFromIndex(l),i.destroy(),d[a]=null},_changeHandler:function(e,t){var i=e.editor,a=e.index,s=e.spanNode,o=t;return t>i.constraints.max||t<i.constraints.min||isNaN(t)||void 0===t?void(s.innerHTML=this._getLabelValueFromIndex(a)):(this.showRatioLabels&&(o=this._getValueFromPercent(t)),"object"==typeof this.values[a]?this.values[a].value=o:this.values[a]=o,this._reset(),this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),void this.emit("handle-value-change",{values:this.values}))},_stopKeydownDateHandler:function(e,t){13===t.keyCode&&e.editor.isValid()&&setTimeout(h.hitch(this,this._destroyHandleEditor,e),0)},_stopBlurDateHandler:function(e,t){setTimeout(h.hitch(this,this._destroyHandleEditor,e),0)},_destroyHandleEditor:function(e){e.spanNode.innerHTML=this._getLabelValueFromIndex(e.index),e.editor.destroy(),e.moveable[e.editorPropName]=null},_stopUpdateDateValue:function(e){var t=e.editor,i=e.min,a=e.max,s=e.index,o=e.zoomed,n=e.spanNode,l=t.get("date");l=l&&l.getTime(),o&&(l>a||i>l)&&(this.set("_isZoomed",!1),this.emit("zoom-out"));var r="object"==typeof this.values[s]?this.values[s].value:this.values[s],h=r!==l;h&&("object"==typeof this.values[s]?this.values[s].value=l:this.values[s]=l),n.innerHTML=this._getLabelValueFromIndex(s),this._reset(),this._updateRoundedLabels(),this._generateMoveables(),this._generateMinMaxEditors(),h&&this.emit("handle-value-change",{values:this.values})},_getRatioFromValue:function(e){var t=this.get("showRatioLabels");return"percent"===t?100*e:"percentTotal"===t?e/(1+e)*100:null},_getValueFromPercent:function(e){var t=this.get("showRatioLabels");return"percent"===t?e/100:"percentTotal"===t?e>=100?100:e/(100-e):void 0},_getLabelValueFromIndex:function(e,t){return this.showRatioLabels&&this._ratioLabels[e]?t===!0?parseFloat(this._ratioLabels[e].toFixed(2))+"%":this._formatValue(parseFloat(this._ratioLabels[e].toFixed(2)))+"%":t===!0?this._roundedHandleLabels[e]:this._formatValue(this._roundedHandleLabels[e])},_getValuesFromObject:function(e){var t=[];return r.forEach(e,function(e){t.push(e.value)}),t},_getDecimalPlaces:function(e){return a.format(e,{places:"0,20",round:-1}).replace(/^-?\d*\.?|0+$/g,"").length},_collisionCheck:function(e,t){return!(e.right<t.left||e.left>t.right||e.bottom<t.top||e.top>t.bottom)},_generateCtrlKeyListener:function(){_(document,"keydown",h.hitch(this,function(e){this._ctrlDown=e.metaKey||e.ctrlKey})),_(document,"keyup",h.hitch(this,function(e){this._ctrlDown=e.metaKey||e.ctrlKey}))},_valuesChange:function(){this.emit("data-change",{values:this.get("values")})}});return p});